---
# This workflow is required to publish test results from forks
name: Test Results

on: # yamllint disable-line rule:truthy
  workflow_run:
    workflows: ["Docker build", "UI Tests"]
    types:
      - completed
# actionlint doesn't like the following line depite it being recommanded:
# https://docs.github.com/en/actions/using-jobs/assigning-permissions-to-jobs#overview
# permissions: {}

jobs:
  test-results:
    name: Test Results
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'skipped'

    permissions:
      checks: write

      # needed unless run with comment_mode: off
      pull-requests: write

      # required by download step to access artifacts API
      actions: read

    steps:
      - name: Wait for both workflows to complete
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          COMPLETED_WORKFLOW="${{ github.event.workflow_run.name }}"

          # Determine which workflow to wait for
          if [ "$COMPLETED_WORKFLOW" = "Docker build" ]; then
            WAIT_FOR="UI Tests"
          else
            WAIT_FOR="Docker build"
          fi

          echo "Workflow '$COMPLETED_WORKFLOW' completed. Waiting for '$WAIT_FOR' to complete..."

          # Poll until the other workflow completes or is skipped (max 120 attempts = 10 minutes)
          for i in {1..120}; do
            # Get workflow runs for this commit and check if the target workflow is completed
            WORKFLOW_STATE=$(gh run list --repo ${{ github.event.workflow_run.head_repository.full_name }} --commit $SHA --workflow "$WAIT_FOR" --json status --jq '.[0].status' 2>/dev/null)

            if [ "$WORKFLOW_STATE" = "completed" ]; then
              echo "✓ '$WAIT_FOR' has completed"
              break
            fi

            if [ $i -eq 120 ]; then
              echo "⚠ Timeout waiting for $WAIT_FOR after 10 minutes, proceeding anyway..."
              break
            fi

            echo "Waiting for $WAIT_FOR... (attempt $i/120, ~$((i*5)) seconds elapsed)"
            sleep 5
          done

      - name: Download and Extract Artifacts
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          mkdir -p artifacts && cd artifacts

          artifacts_url=${{ github.event.workflow_run.artifacts_url }}

          gh api --paginate "$artifacts_url" -q '.artifacts[] | [.name, .archive_download_url] | @tsv' | while read -r artifact
          do
            IFS=$'\t' read -r name url <<< "$artifact"
            gh api "$url" > "$name.zip"
            unzip -d "$name" "$name.zip"
          done

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          commit: ${{ github.event.workflow_run.head_sha }}
          event_name: ${{ github.event.workflow_run.event }}
          files: "artifacts/**/*.xml"
          check_name: "Unit Test Results"
          comment_mode: always

      # The following step is the catch situations where the tests didn't run at all.
      - name: Check failure files
        run: |
          if compgen -G "artifacts/**/pytest*failed" > /dev/null; then
            echo "Tests failure file(s) exist. Some tests have failed or didn't run at all! \
              Check the artifacts for details."
            exit 1
          fi

      # For PR builds triggered from comment builds, the GITHUB_REF is set to main
      # so the checks aren't automatically associated with the PR
      # If prHeadSha is specified then explicity mark the checks for that SHA
      - name: Report check status
        if: github.event.workflow_run.head_sha != ''
        uses: LouisBrunner/checks-action@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # the name must be identical to the one received by the real job
          sha: ${{ github.event.workflow_run.head_sha }}
          name: "Test Results"
          status: "completed"
          conclusion: ${{ github.event.workflow_run.conclusion }}
          details_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
