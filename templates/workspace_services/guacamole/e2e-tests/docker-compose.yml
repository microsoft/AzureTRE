version: '3.8'

services:
  # Mock xrdp server for testing
  xrdp:
    image: danielguerra/ubuntu-xrdp:20.04
    hostname: xrdp-test
    ports:
      - "3390:3389"
    environment:
      - TZ=UTC
    networks:
      - guac-test-network

  # Nginx proxy to inject auth headers for E2E testing
  nginx-proxy:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx-test.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - guacamole-backend
    networks:
      - guac-test-network

  # Guacamole backend server with TRE auth extension (Debian-based from-source build)
  guacamole-backend:
    image: guacamole-tre:latest
    environment:
      # Azure TRE Configuration (mock values for testing)
      - TRE_ID=test-tre
      - API_URL=http://mock-api:1080
      - WORKSPACE_ID=test-workspace
      - KEYVAULT_URL=https://mock-keyvault.vault.azure.net/
      - AAD_TENANT_ID=test-tenant-id
      # Disable oauth2-proxy for E2E tests (nginx injects headers directly)
      - DISABLE_OAUTH2_PROXY=true
    ports:
      - "8081:8080"  # Expose backend directly for debugging
    depends_on:
      - xrdp
      - mock-api
    networks:
      - guac-test-network

  # Mock TRE API server
  mock-api:
    image: mockserver/mockserver:5.15.0
    ports:
      - "8000:1080"
    environment:
      - MOCKSERVER_INITIALIZATION_JSON_PATH=/config/expectations.json
      - MOCKSERVER_LOG_LEVEL=INFO
    volumes:
      - ./mock-api-config.json:/config/expectations.json:ro
    networks:
      - guac-test-network

  # Playwright test runner
  playwright:
    build:
      context: ./playwright
      dockerfile: Dockerfile
    depends_on:
      - nginx-proxy
      - xrdp
      - mock-api
    environment:
      - GUACAMOLE_URL=http://nginx-proxy:80
      - XRDP_HOST=xrdp
      - XRDP_PORT=3389
      - TEST_USERNAME=testuser
      - TEST_PASSWORD=testpass
    volumes:
      - ./playwright/tests:/tests
      - ./playwright/screenshots:/screenshots
      - ./playwright/videos:/videos
    networks:
      - guac-test-network
    command: npx playwright test --reporter=html

networks:
  guac-test-network:
    driver: bridge
