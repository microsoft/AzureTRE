{
    "definition": {
        "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
        "actions": {
            "Initialize_message_variable": {
                "inputs": {
                    "variables": [
                        {
                            "name": "message",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Parse_JSON": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable"
            },
            "Initialize_email_body_variable": {
                "inputs": {
                    "variables": [
                        {
                            "name": "email_body",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_message_variable": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable"
            },
            "Initialize_created_when_variable": {
                "inputs": {
                    "variables": [
                        {
                            "name": "created_when",
                            "type": "integer",
                            "value": "@int(formatNumber(body('Parse_JSON')?['data']?['request']?['created_when'], 'F0'))"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_email_body_variable": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable"
            },
            "Initialize_export_review_due_date": {
                "inputs": {
                    "variables": [
                        {
                            "name": "export_review_due_date",
                            "type": "integer",
                            "value": "@int(formatNumber(body('Parse_JSON')?['data']?['request']?['export_review_due_date'], 'F0'))"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_created_when_variable": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable"
            },
            "Initialize_triage_level_code": {
                "inputs": {
                    "variables": [
                        {
                            "name": "triage_level_code",
                            "type": "string",
                            "value": "@body('Parse_JSON')?['data']?['request']?['triage_level_code']"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_export_review_due_date": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable"
            },
            "Initialize_recipients_variable": {
                "inputs": {
                    "variables": [
                        {
                            "name": "recipients",
                            "type": "array"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_triage_level_code": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable"
            },
            "Parse_JSON": {
                "inputs": {
                    "content": "@triggerOutputs()?['body']?['contentData']",
                    "schema": {
                        "properties": {
                            "data": {
                                "properties": {
                                    "event_type": {
                                        "type": "string"
                                    },
                                    "recipient_emails_by_role": {
                                        "properties": {
                                            "airlock_manager": {
                                                "items": {
                                                    "type": "string"
                                                },
                                                "type": "array"
                                            },
                                            "workspace_owner": {
                                                "items": {
                                                    "type": "string"
                                                },
                                                "type": "array"
                                            },
                                            "workspace_researcher": {
                                                "items": {
                                                    "type": "string"
                                                },
                                                "type": "array"
                                            }
                                        },
                                        "type": "object"
                                    },
                                    "request": {
                                        "properties": {
                                            "title": {
                                                "type": "string"
                                            },
                                            "business_justification": {
                                                "type": "string"
                                            },
                                            "createdBy": {
                                                "properties": {
                                                    "email": {
                                                        "type": "string"
                                                    },
                                                    "name": {
                                                        "type": "string"
                                                    }
                                                },
                                                "type": "object"
                                            },
                                            "createdWhen": {
                                                "type": "number"
                                            },
                                            "files": {
                                                "items": {
                                                    "name": {
                                                        "type": "string"
                                                    },
                                                    "size": {
                                                        "type": "number"
                                                    }
                                                },
                                                "type": "array"
                                            },
                                            "id": {
                                                "type": "string"
                                            },
                                            "requestType": {
                                                "type": "string"
                                            },
                                            "status": {
                                                "type": "string"
                                            },
                                            "updatedBy": {
                                                "properties": {
                                                    "email": {
                                                        "type": "string"
                                                    },
                                                    "name": {
                                                        "type": "string"
                                                    }
                                                },
                                                "type": "object"
                                            },
                                            "updatedWhen": {
                                                "type": "number"
                                            }
                                        },
                                        "type": "object"
                                    },
                                    "workspace": {
                                        "properties": {
                                            "description": {
                                                "type": "string"
                                            },
                                            "display_name": {
                                                "type": "string"
                                            },
                                            "id": {
                                                "type": "string"
                                            }
                                        },
                                        "type": "object"
                                    }
                                },
                                "type": "object"
                            }
                        },
                        "type": "object"
                    }
                },
                "runAfter": {},
                "type": "ParseJson"
            },
            "Send_Email_with_SMTP": {
                "inputs": {
                    "body": {
                        "Body": "@variables('email_body')",
                        "From": "@parameters('smtp_from_email')",
                        "Subject": "@variables('message')",
                        "To": "@{join(variables('recipients'), ';')}"
                    },
                    "host": {
                        "connection": {
                            "referenceName": "smtp"
                        }
                    },
                    "method": "post",
                    "path": "/SendEmailV3"
                },
                "runAfter": {
                    "Switch_on_request_status": [
                        "Succeeded"
                    ]
                },
                "type": "ApiConnection"
            },
            "Succeeded": {
                "inputs": {
                    "runStatus": "Succeeded"
                },
                "runAfter": {
                    "Send_Email_with_SMTP": [
                        "Succeeded"
                    ]
                },
                "type": "Terminate"
            },
            "Switch_on_request_status": {
                "cases": {
                    "Case_approved": {
                        "actions": {
                            "Set_approved_email_body": {
                                "cases": {
                                    "Case_import": {
                                        "actions": {
                                            "Set_approved_import_email_body": {
                                                "inputs": {
                                                    "name": "email_body",
                                                    "value": "<p>Hi @{body('Parse_JSON')?['data']?['request']?['created_by']?['name']}</p><p>Your CPRD Safe airlock import request has been approved. You can now download your file from the airlock inside CPRD Safe. This guide: <a href=\"https://www.cprd.com/sites/default/files/2024-09/Airlock%20Import%20v1.pdf\">Airlock import request</a> shows you how. Further help can be found at: <a href=\"https://www.cprd.com/cprd-safe-training-and-guidance\">CPRD Safe training and guidance | CPRD</a>.</p><p>Log in to <a href=\"@{parameters('tre_url')}\">CPRD Safe</a> to view the request.</p><p>Many thanks,</p><p><b>CPRD Safe Team</b></p>."
                                                },
                                                "type": "SetVariable"
                                            }
                                        },
                                        "case": "import"
                                    },
                                    "Case_export": {
                                        "actions": {
                                            "Set_approved_export_email_body": {
                                                "inputs": {
                                                    "name": "email_body",
                                                    "value": "<p>Hi @{body('Parse_JSON')?['data']?['request']?['created_by']?['name']}</p><p>Your CPRD Safe airlock export request has been approved. You can now download your file from the airlock outside CPRD Safe. Further help can be found at: <a href=\"https://www.cprd.com/cprd-safe-training-and-guidance\">CPRD Safe training and guidance | CPRD</a>.</p><p>Log in to <a href=\"@{parameters('tre_url')}\">CPRD Safe</a> to view the request.</p><p>Many thanks,</p><p><b>CPRD Safe Team</b></p>."
                                                },
                                                "type": "SetVariable"
                                            }
                                        },
                                        "case": "export"
                                    }
                                },
                                "expression": "@body('Parse_JSON')?['data']?['request']?['request_type']",
                                "runAfter": {
                                    "Set_approved_message": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Switch"
                            },
                            "Set_approved_message": {
                                "inputs": {
                                    "name": "message",
                                    "value": "Your CPRD Safe airlock request was approved"
                                },
                                "runAfter": {
                                    "Set_recipients_as_researchers_emails": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "SetVariable"
                            },
                            "Set_recipients_as_researchers_emails": {
                                "inputs": {
                                    "name": "recipients",
                                    "value": [
                                        "@body('Parse_JSON')?['data']?['request']?['created_by']?['email']"
                                    ]
                                },
                                "runAfter": {},
                                "type": "SetVariable"
                            }
                        },
                        "case": "approved"
                    },
                    "Case_in_review": {
                        "actions": {
                            "Set_in_review_email_body": {
                                "inputs": {
                                    "name": "email_body",
                                    "value": "<p>Dear Reviewer,<br>A @{variables('triage_level_code')} airlock export request is ready for review by @{addToTime('1970-01-01T00:00:00Z',variables('export_review_due_date'),'second','dd/MM/yyyy')}:</p><table border=\"1\"><tr><th>Overview of Request</th></tr><tr><th>Workspace Name</th><td>@{body('Parse_JSON')?['data']?['workspace']?['display_name']}</td></tr><tr><th>Workspace ID</th><td>@{body('Parse_JSON')?['data']?['workspace']?['id']}</td></tr><tr><th>Airlock Request ID</th><td>@{body('Parse_JSON')?['data']?['request']?['id']}</td></tr><tr><th>Requestor</th><td>@{body('Parse_JSON')?['data']?['request']?['created_by']?['name']}</td></tr><tr><th>Submitted Date</th><td>@{addToTime('1970-01-01T00:00:00Z',variables('created_when'),'second','dd/MM/yyyy')}</td></tr><tr><th>Status</th><td>In Review</td></tr><tr><th>File name</th><td>@{first(body('Parse_JSON')?['data']?['request']?['files'])['name']}</td></tr></table><p>Log in to <a href=\"@{parameters('tre_url')}\">CPRD Safe</a> to review the request.</p>"
                                },
                                "runAfter": {
                                    "Set_in_review_message": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "SetVariable"
                            },
                            "Set_in_review_message": {
                                "inputs": {
                                    "name": "message",
                                    "value": "@{variables('triage_level_code')} Airlock export review from Workspace @{body('Parse_JSON')?['data']?['workspace']?['display_name']}"
                                },
                                "runAfter": {
                                    "Set_recipients_as_owners_emails": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "SetVariable"
                            },
                            "Set_recipients_as_owners_emails": {
                                "inputs": {
                                    "name": "recipients",
                                    "value": "@body('Parse_JSON')?['data']?['recipient_emails_by_role']?['airlock_manager']"
                                },
                                "runAfter": {},
                                "type": "SetVariable"
                            }
                        },
                        "case": "in_review"
                    },
                    "Case_rejected": {
                        "actions": {
                            "Condition_on_triage_level": {
                                "type": "If",
                                "expression": "@startsWith(toUpper(body('Parse_JSON')?['data']?['request']?['triage_level_code']), 'L4')",
                                "actions": {
                                    "Not_Send_Emails_For_Triage_Level_L4": {
                                        "inputs": {
                                            "runStatus": "Cancelled"
                                        },
                                        "runAfter": {},
                                        "type": "Terminate"
                                    }
                                },
                                "else": {
                                    "actions": {
                                        "Set_recipients_as_researchers_emails_rejected": {
                                            "inputs": {
                                                "name": "recipients",
                                                "value": [
                                                    "@body('Parse_JSON')?['data']?['request']?['created_by']?['email']"
                                                ]
                                            },
                                            "runAfter": {},
                                            "type": "SetVariable"
                                        },
                                        "Set_rejected_message": {
                                            "inputs": {
                                                "name": "message",
                                                "value": "Your CPRD Safe export request has been rejected"
                                            },
                                            "runAfter": {
                                                "Set_recipients_as_researchers_emails_rejected": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable"
                                        },
                                        "Set_rejected_email_body": {
                                            "inputs": {
                                                "name": "email_body",
                                                "value": "<p>Dear @{body('Parse_JSON')?['data']?['request']?['created_by']?['name']},</p><p>Export request: @{body('Parse_JSON')?['data']?['request']?['title']}</p><p>Your CPRD Safe airlock export request has been rejected as it did not meet CPRD Safe output criteria. Guidance can be found at: <a href=\"https://www.cprd.com/sites/default/files/2024-10/CPRD%20Safe%20Outputs%20Guidance.pdf\">CPRD Safe Outputs Guidance</a>.</p><p>To view more information about your request, log in to <a href=\"@{parameters('tre_url')}\">CPRD Safe</a> and navigate to your workspace > Airlock dashboard > Export requests > View. Scroll down to Overview of request to see the reason for the decision.</p><p>If you need further help, please email <a href=\"mailto:enquiries@cprd.com?subject=CPRD%20Safe%20export%20request%20rejection\">enquiries@cprd.com</a></p>.<p>Many thanks,</p><p><b>CPRD Safe Team</b></p>"
                                            },
                                            "runAfter": {
                                                "Set_rejected_message": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable"
                                        }
                                    }
                                },
                                "runAfter": {}
                            }
                        },
                        "case": "rejected"
                    }
                },
                "default": {
                    "actions": {
                        "Cancelled": {
                            "inputs": {
                                "runStatus": "Cancelled"
                            },
                            "runAfter": {},
                            "type": "Terminate"
                        }
                    }
                },
                "expression": "@body('Parse_JSON')?['data']?['request']?['status']",
                "runAfter": {
                    "Initialize_recipients_variable": [
                        "Succeeded"
                    ]
                },
                "type": "Switch"
            }
        },
        "contentVersion": "1.0.0.0",
        "outputs": {},
        "triggers": {
            "When_messages_are_available_in_a_queue": {
                "inputs": {
                    "parameters": {
                        "isSessionsEnabled": false,
                        "queueName": "notifications"
                    },
                    "serviceProviderConfiguration": {
                        "connectionName": "serviceBus",
                        "operationId": "receiveQueueMessages",
                        "serviceProviderId": "/serviceProviders/serviceBus"
                    }
                },
                "splitOn": "@triggerOutputs()?['body']",
                "type": "ServiceProvider"
            }
        }
    },
    "kind": "Stateful"
}
