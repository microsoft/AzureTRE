{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Azure TRE Overview","text":""},{"location":"#what-is-azure-tre","title":"What is Azure TRE?","text":"<p>Across the health industry, be it a pharmaceutical company interrogating clinical trial results, or a public health provider analyzing electronic health records, there is the need to enable researchers, analysts, and developers to work with sensitive data sets.  </p> <p>Trusted Research Environments (TREs) enable organisations to provide research teams secure access to these data sets along side tooling to ensure a researchers can be productive. Further information on TREs in general can be found in many places, one good resource is HDR UK.</p> <p>The Azure Trusted Research Environment project is an accelerator to assist Microsoft customers and partners who want to build out Trusted Research environments on Azure. This project enables authorized users to deploy and configure secure workspaces and researcher tooling without a dependency on IT teams.  </p> <p>This project is typically implemented alongside a data platform that provides research ready datasets to TRE workspaces:</p> <p></p> <p>TREs are not \u201cone size fits all\u201d, hence although the Azure TRE has a number of out of the box features, the project has been built be extensible, and hence tooling and data platform agnostic.</p> <p>Core features include:</p> <ul> <li>Self-service for administrators \u2013 workspace creation and administration</li> <li>Self-service for research teams \u2013 research tooling creation and administration</li> <li>Package and repository mirroring</li> <li>Extensible architecture - build your own service templates as required</li> <li>Azure Active Directory integration</li> <li>Airlock</li> <li>Cost reporting</li> <li>Ready to workspace templates including:<ul> <li>Restricted with data exfiltration control</li> <li>Unrestricted for open data</li> </ul> </li> <li>Ready to go workspace service templates including:<ul> <li>Virtual Desktops: Windows, Linux</li> <li>AzureML (Jupyter, R Studio, VS Code)</li> <li>ML Flow, Gitea</li> </ul> </li> </ul>"},{"location":"coming-soon/","title":"Coming Soon","text":"<p>We're working to improve our documentation, and fill in some gaps. Unfortunately, this particular page is one of the gaps we're looking to fill and isn't yet available.</p>"},{"location":"coming-soon/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"azure-tre-overview/airlock/","title":"Airlock","text":"<p>In a Trusted Research Environment (TRE) the workspaces represent a security boundary that enables researchers to access data, execute analysis, apply algorithms and collect reports. The airlock capability brings the only mechanism that allows users to <code>import</code> or <code>export</code> data, tools or other file based artefacts in a secure fashion with a human approval. This constitutes the mechanism focused in preventing data exfiltration and securing TRE and its workspaces from inappropriate data, while allowing researchers to work on their projects and execute their tasks. The airlock feature brings several actions: ingress/egress Mechanism; Data movement; Security gates; Approval mechanism and Notifications. As part of TRE's Safe settings all activity must be tracked for auditiing purpose.</p> <p>The Airlock feature aims to address these goals:</p> <ul> <li>Prevent unauthorised data import or export.</li> </ul> <ul> <li>Provide a process to allow approved data to be imported through the security boundary of a TRE Workspace.</li> </ul> <ul> <li>TRE provides functionality to track requests and decisions, supporting cycle of revision, approval or rejection.</li> </ul> <ul> <li>Data being imported with an airlock import process can be automatically scanned for security issues.</li> </ul> <ul> <li>Data being exported or imported must be manually reviewed by the Airlock Manager.</li> </ul> <ul> <li>Notify the requesting researcher of the process progress and/or required actions.</li> </ul> <ul> <li>All steps within the airlock process are audited.</li> </ul> <p>Typically in a TRE, the Airlock feature would be used to allow a researcher to export outputs of a research project such as summary results. With the airlock, data to export must go though a human review, typically done by a data governance team.</p> <p>The Airlock feature will create events on every meaningful step of the processes. This will enable increased flexibility by allowing an organization to extend the notification mechanism.</p>"},{"location":"azure-tre-overview/airlock/#ingressegress-mechanism","title":"Ingress/Egress Mechanism","text":"<p>The Airlock allows a TRE user to start <code>import</code> or <code>export</code> process to a given workspace. A number of milestones must be reached in order to complete a successful import or export. These milestones are defined using the following states:</p> <ol> <li>Draft: An Airlock request has been created but has not yet started. The TRE User/Researcher has now access to a storage location and he must identify the data to be processed. At this point the airlock import/export processes allow a single file to be processed. However a compressed file may be used (zip).</li> <li>Submitted: The request was submitted by the ressearcher (not yet processed).</li> <li>In-Review: The request is ready to be reviewed. This state can be reached directly from Submitted state or after going through a successful security scan (found clean).</li> <li>Approval In-progress: The Airlock request has been approved, however data movement is still ongoing.</li> <li>Approved: The Airlock request has been approved. At this state, data has been securely verified and manually reviewed. The data is now in its final location. For an import process the data is now available in the TRE workspace. It can be accessed by the requestor from within the workspace.</li> <li>Rejection In-progress: The Airlock request has been rejected, however data movement is still ongoing.</li> <li>Rejected: The Airlock request has been rejected. The data in the process was rejected manually by the Airlock Manager.</li> <li>Cancelled: The Airlock request was manually cancelled by the requestor TRE user, a Workspace owner or a TRE administrator. The cancelation is only allowed when the request is not actively changing (i.e. Draft or In-Review state).</li> <li>Blocking In-progress: The Airlock request has been blocked, however data movement is still ongoing.</li> <li>Blocked By Scan: The Airlock request has been blocked. The security analysis found issues in the submitted data, and consequently quarantined the data.</li> </ol> <pre><code>graph TD \n  A[Researcher wants to export data from TRE Workspace] --&gt;|Request created| B[Request in state Draft] \n  B--&gt;|Researcher gets link to storage container and uploads data| B\n  B--&gt;|Request submitted| C[Submitted]\n  C--&gt; D{Security issues found?} \n  D--&gt;|Yes| E[Blocking In-progress]\n  D--&gt;|No| G[In-Review]\n  E:::temporary--&gt; F((Blocked By Scan))\n  G--&gt;|Human Review| H{Is data appropriate to export?}\n  H--&gt;|Approve| I[Approval In-progress]\n  H--&gt;|Reject| J[Rejection In-progress]\n  I:::temporary--&gt;K((Approved))\n  J:::temporary--&gt;L((Rejected))\n  B--&gt;|Request Canceled| X((Canceled))\n  G--&gt;|Request Canceled| X\n  H--&gt;|Request Canceled| X\n  classDef temporary stroke-dasharray: 5 5</code></pre> <p>Airlock state flow diagram for an Airlock export request</p> <p>When an airlock process is created the initial state is Draft and the required infrastructure will get created providing a single container to isolate the data in the request. Once completed, the user user will be able to get a link for this container inside the storage account (URL + SAS token) that he can use to upload the desired data to be processed (import or export). This storage location is external for import (<code>stalimex</code>) or internal for export (<code>stalexint</code>), however only accessible to the requestor (ex: a TRE user/researcher). The user will be able to upload a file to the provided storage location, using any tool of their preference: Azure Storage Explorer or AzCopy which is a command line.</p> <p>The user Submits the request (TRE API call) starting the data movement (to the <code>stalimip</code> - import in-progress or <code>stalexip</code> - export in-progress). The airlock request is now in state Submitted. If enabled, the Security Scanning is started. In case security flaws are found, the request state becomes Blocking In-progress while the data is moved to blocked storage  (either import blocked <code>stalimblocked</code> or export blocked<code>stalexblocked</code>). In this case, the request is finalized with the state Blocked By Scan. If the Security Scanning does not identify security flaws, the request state becomes In-Review. Simultaneously a notification is sent to the Airlock Manager user. The user needs to ask for the container url using the TRE API (SAS token + URL with READ permission).</p> <p>The Security Scanning can be disabled, chaging the request state from Submitted straight to In-Review.</p> <p>The Airlock Manager will manually review the data using the tools of their choice available in the TRE workspace. Once review is completed, the Airlock Manager will have to Approve or Reject the airlock proces, though a TRE API call. At this point, the request will change state to either Approval In-progress or Rejection In-progress, while the data movement occurs moving afterwards to Approved or Rejected accordingly. The data will now be in the final storage destination: <code>stalexapp</code> - export approved  or <code>stalimapp</code> - import approved. With this state change a notification will be triggered to the requestor including the location for the processed data in the form of an URL + SAS token.</p>"},{"location":"azure-tre-overview/airlock/#data-movement","title":"Data movement","text":"<p>For any airlock process there is data movement either into a TRE workspace (in import process) or from a TRE workspace (in export process). Being the TRE a Workspace boundary, there are networking configurations designed to achieve this goal. The data movement will guarantee that the data is automatically verified for securty flaws and manually reviewed, before placing data inside the TRE Workspace. Also, the process guarantees that data is not tampered with through out the process.</p> <p>In an import process, data will transition from more public locations (yet confined to the requestor) to TRE workspace storage, after guaranteeding security automatically and by manual review.</p> <p>In an export process data will transition from internal locations (available to the requestor) to public locations in the TRE, after going through a manual review.</p> <p>Considering that the Airlock requests may require large data movements, the operations can have longer durations, hence becoming the operations asynchronous. This is why states like Approval In-progress, Rejection In-progress or Blocking In-progress will be set while there are data movement operations.</p> <p>The data movement mechanism is data-driven, allowing an organization to extend how request data transitions between</p>"},{"location":"azure-tre-overview/airlock/#security-scan","title":"Security Scan","text":"<p>The identified data in a airlock proces, will be submited to a security scan. If the security scan identifies issues the data is quarantined, and a report is added to the process metadata. Both the requestor and Workspace Owner are notified. For successful security scan, the data will remain in state In-progress, and accessible to the Workspace Owner.</p> <ul> <li>The Security scan will be optional, behind a feature flag, enabled by script</li> <li>The outcome of security scan will be either the in-progress (<code>stalexip</code>) storage or blocked (<code>stalexblocked</code>)</li> <li>An airlock process will guarantee that the content being imported/exported is secure. It is envisioned that a set of security gates are identified to be executed successfully for a process to be approve.</li> </ul>"},{"location":"azure-tre-overview/airlock/#approval-mechanism","title":"Approval mechanism","text":"<p>The approval mechanism, is bundled with any airlock process, providing a specific way to <code>approve</code> or <code>reject</code> the data. This mechanism will allow the Airlock Managers to explicitly approve/reject the process, after having acess to the data. The Airlock Manager users will be able to execute a manual review on the data using the tools available to him in a reviewal TRE Workspace. Once this manual review is executed, Airlock Managers can proactivelly approve or reject the airlock request.</p> <p>The only goal of the Approval mechanism is to provide a cycle of revision, approval or rejection, while tracking the decision.</p> <p>This mechanism will provide access to the data in the airlock process, and will be able to use a VM in TRE workspace. The data review will be the Airlock Manager responsibility</p> <ul> <li>It is envisioned that this mechanism to be more flexible and extensible.</li> <li>The <code>Airlock Manager</code> is a role defined at workspace instance level and assigned to identities. Initially the <code>Owner</code> role will be used.</li> </ul>"},{"location":"azure-tre-overview/airlock/#notifications","title":"Notifications","text":"<p>Throughout the airlock process, the notification mechanism will notify the relevant people to the process. Both the requestor (TRE User/Researcher) and the Workspace Owner will be notified by email, of the relevant process events.</p> <p>Whenever the airlock process changes to a state of Draft, Submitted, Approved, Rejected, Approval In-progress,Rejection In-progress, Blocked By Scan or Cancelled, the process requestor gets notified. When the state changes to <code>In-progress</code> the Workspace Onwer (Airlock Manager) gets notified.</p> <ul> <li>The Notification mechanism is also data-driven, allowing an organization to extend the notifications behavior. The mechanism is exemplified with a Logic App determining the notifications logic.</li> <li>Notifications will work with All TRE users being AAD users (guests or not), with email defined \u2013 if not, notifications will not be sent.</li> </ul>"},{"location":"azure-tre-overview/airlock/#architecture","title":"Architecture","text":"<p>The Airlock feature is supported by infrastructure at the TRE and workspace level, containing a set of storage accounts. Each Airlock request, will provision and use unique storage containers with the request id in it's name.</p> <pre><code>graph LR\n  subgraph TRE Workspace\n  E[(stalimapp&lt;/br&gt;import approved)]\n  end\n  subgraph TRE\n  A[(stalimex&lt;/br&gt;import external)]--&gt;|Request Submitted| B\n  B[(stalimip&lt;/br&gt;import in-progress)]--&gt;|Security issues found| D[(stalimblocked&lt;/br&gt;import blocked)] \n  B--&gt;|No security issues found| review{Manual&lt;/br&gt;Approval} \n  review--&gt;|Rejected| C[(stalimrej&lt;/br&gt;import rejected)]\n  review--&gt;|Approved| E\n  end\n  subgraph External\n      data(Data to import)--&gt;A\n  end</code></pre> <p>Data movement in an Airlock import request</p> <p>TRE:</p> <ul> <li><code>stalimex</code> - storage (st) airlock (al) import (im) external (ex)</li> <li><code>stalimip</code> - storage (st) airlock (al) import (im) in-progress (ip)</li> <li><code>stalimrej</code> - storage (st) airlock (al) import (im) rejected (rej)</li> <li><code>stalimblocked</code> - storage (st) airlock (al) import (im) blocked</li> <li><code>stalexapp</code> - storage (st) airlock (al) export (ex) approved (app)</li> </ul> <p>Workspace:</p> <ul> <li><code>stalimapp</code> - workspace storage (st) airlock (al) import (im) approved (app)</li> <li><code>stalexint</code> - workspace storage (st) airlock (al) export (ex) internal (int)</li> <li><code>stalexip</code> - workspace storage (st) airlock (al) export (ex) in-progress (ip)</li> <li><code>stalexrej</code> - workspace storage (st) airlock (al) export (ex) rejected (rej)</li> <li><code>stalexblocked</code> - workspace storage (st) airlock (al) export (ex) blocked</li> </ul> <ul> <li>The external storage accounts (<code>stalimex</code>, <code>stalexapp</code>), are not bound to any vnet and accessible (with SAS token) via internet.</li> <li>The internal storage account (<code>stalexint</code>) is bound to the workspace vnet, so ONLY TRE Users/Researchers on that workspace can access it</li> <li>The (export) in-progress storage account (<code>stalexip</code>) is bound to the workspace vnet</li> <li>The (export) blocked storage account (<code>stalexblocked</code>) is bound to the workspace vnet</li> <li>The (export) rejected storage account (<code>stalexrej</code>) is bound to the workspace vnet</li> <li>The (import) in-progress storage account (<code>stalimip</code>) is bound to the TRE CORE vnet</li> <li>The (import) blocked storage account (<code>stalimblocked</code>) is bound to the TRE CORE vnet</li> <li>The (import) rejected storage account (<code>stalimrej</code>) is bound to the TRE CORE vnet</li> <li>The (import) approved storage account (<code>stalimapp</code>) is bound to the workspace vnet</li> </ul> <p></p> <p>In the TRE Core, the TRE API will provide the airlock API endpoints allowing to advance the process. The TRE API will expose the following methods:</p> Method Endpoint Description <code>POST</code> <code>/api/workspaces/{workspace_id}/requests</code> Create an Airlock request (in Draft) <code>POST</code> <code>/api/workspaces/{workspace_id}/requests/{airlock_request_id}/link</code> Get the url and token to acccess Airlock Request <code>POST</code> <code>/api/workspaces/{workspace_id}/requests/{airlock_request_id}/review</code> Reviews an Airlock request <code>POST</code> <code>/api/workspaces/{workspace_id}/requests/{airlock_request_id}/cancel</code> Cancels an Airlock request container <p>Also in the airlock feature we have the Airlock Processor which will handle the events that are created throughout the process, signalling state changes from blobs created, status changed or security scans finalized.</p>"},{"location":"azure-tre-overview/airlock/#airlock-flow","title":"Airlock flow","text":"<p>The following sequence diagram detailing the Airlock feature and its event driven behaviour:</p> <p></p>"},{"location":"azure-tre-overview/architecture/","title":"Azure TRE Architecture","text":"<p>The Azure Trusted Research Environment (TRE) consists of multiple components, all encapsulated in networks with restricted ingress- &amp; egress traffic.</p> <p>There is one network for the core components and one network per Workspace.</p> <p>All traffic has to be explicitly allowed by the Application Gateway or the Firewall.</p> <p></p> <p>The Azure resources outside the network boundries of the Azure TRE are Azure Active Directory, Microsoft Graph and TRE Management. TRE Management are resources used during deployment.</p> <p>The Azure TRE core plane consists of two groups of components:</p> <ul> <li>API &amp; Composition Service</li> <li>Shared Services</li> </ul> <p>The TRE API is a service that users can interact with to request changes to workspaces e.g., to create, update, delete workspaces and workspace services inside each workspace. The Composition Service is doing the actual work of mutating the state of each Workspace including the Workspace Services.</p> <p>Ingress/egress components governs all inbound and outbound traffic from the public Internet to and from Azure TRE including the Workspaces. The Firewall Service is managing the egress rules of the Firewall.</p> <p>Shared Services are services available to all Workspaces. Source Mirror can mirror source repositories such as GitHub, but only allowing read-access, hence data from a Workspace cannot be pushed to a source repository. Package Mirror is also a read-only front for developer/researcher application package services like NPM, PyPI, and NuGet and operating system application package services like apt-get and Windows Package Manager (winget).</p>"},{"location":"azure-tre-overview/architecture/#azure-resources","title":"Azure Resources","text":"<p>The following diagram shows the Azure components deployed as part of a typical TRE deployment. The exact configuration will vary depending on the specific deployment.</p> <p></p> <p>For a full breakdown of Azure Resources see Azure TRE Resources Breakdown</p>"},{"location":"azure-tre-overview/architecture/#composition-service","title":"Composition Service","text":"<p>The Composition Service is responsible for managing and mutating Workspaces and Workspace Services. It consists of multiple components:</p> Component Name Responsibility / Description TRE API An API responsible for performing all operations on Workspaces and managing Workspace Templates. Configuration Store Keeping the state of Workspaces and Workspace Templates. The store uses Cosmos DB (SQL). Service Bus Azure Service Bus responsible for reliable delivery of messages between components. Resource Processor Responsible for starting the process of mutating a Workspace via a Workspace Template. <p>A Workspace is an instance of a Workspace Template. A Workspace Template is implemented as a Porter bundle - read more about Authoring workspaces templates.</p> <p>A Porter bundle is a fully encapsulated versioned bundle with everything needed (binaries, scripts, IaC templates etc.) to provision an instance of Workspace Template.</p> <p>To automate Porter it needs a place to live in Azure TRE. The home chosen for Porter to run was a Linux virtual machine. This Azure TRE component encompassing Porter and its dependencies is called Resource Processor.</p> <p></p> <p>During the deployment of Resource Processor itself it is given the credentials of a managed identity with the privileges to modify and deploy resources to the subscription associated with the Azure TRE instance. Resource Processor later then uses these credentials to receive and send Service Bus messages, authorizes Porter to deploy Porter bundles and to access the storage account to update installation data.</p> <p>The logic in Resource Processor is written in Python. The Resource Processor implementation is located in <code>resource_processor</code> folder of the repository.</p> <p>The TRE Administrator can register a Porter bundle to use the Composition Service to provision instances of the Workspace Templates.</p> <p>This requires:</p> <ol> <li>The Porter bundle to be pushed to the Azure Container Registry (ACR).</li> <li>Registering the Workspace through the API.</li> </ol> <p>Details on how to register a Workspace Template.</p>"},{"location":"azure-tre-overview/architecture/#provisioning-a-workspace","title":"Provisioning a Workspace","text":"<p>The flow to provision a Workspace is as follows (the flow is the same for all kinds of mutations to a Workspace):</p> <ol> <li>TRE Admin sends an HTTP request to the TRE API to create a new Workspace. The request contains information like the name of the Workspace, the Workspace Template to use, and the parameters required for the Workspace Template (Workspace Templates can expose the parameters via a JSON Schema ).</li> <li>The API saves the desired state of the Workspace in the Configuration Store.</li> <li> <p>The API sends a command message with the Workspace Template reference and parameters to the <code>workspacequeue</code>.</p> <pre><code>{\n\"action\": \"install\",\n\"id\": \"base\",\n\"name\": \"BaseWorkspaceTemplate\",\n\"version\": \"1.0\",\n\"parameters\": {\n\"param1\": \"value1\"\n}\n}\n</code></pre> </li> <li> <p>The Resource Processor picks up the new message from the service bus queue.</p> </li> <li> <p>The Resource Processor processes the command by executing the Porter bundle (the implementation of a Workspace Template).</p> <pre><code># simplified for readability\nporter &lt;action&gt; --reference &lt;ACR name&gt;.azurecr.io/bundles/&lt;name&gt;:&lt;version&gt; --params key=value --cred &lt;credentials set name or file&gt;\n\n# Example\nporter install --reference msfttreacr.azurecr.io/bundles/BaseWorkspaceTemplate:1.0 --params param1=value1 --cred arm_auth_local_debugging.json\n</code></pre> <p>Deployments are carried out against the Azure Subscription using a User Assigned Managed Identity. The <code>arm_auth_local_debugging.json</code> tells Porter where the credential information can be found and for the Resource Processor they are set as environment variables.</p> <p>Porter bundle actions are required to be idempotent, so if a deployment fails, the Resource Processor can retry.</p> </li> <li> <p>The Porter Docker bundle is pulled from the Azure Container Registry (ACR) and executed.</p> </li> <li>The Porter bundle executes against Azure Resource Manager to provision Azure resources. Any kind of infrastructure of code frameworks like ARM, Terraform, or Pulumi can be used or scripted via PowerShell or Azure CLI.</li> <li>Porter stores state and outputs in Azure Storage Containers. State for keeping persistent state between executions of a bundled with the same Workspace.</li> <li>For the time being, the Porter bundle updates Firewall rules directly setting egress rules. An enhancement to implement a Shared Firewall services is planned (#882).</li> <li>The Resource Processor sends events to the <code>deploymentstatus</code> queue on state changes and informs if the deployment succeeded or failed.</li> <li>The API receives the status of the Porter bundle execution.</li> <li>The API updates the status of the Porter bundle execution in the Configuration Store.</li> </ol>"},{"location":"azure-tre-overview/compliance-info/","title":"Compliance Information","text":"<p>Info</p> <p>Coming soon</p> <p>We're working to improve our documentation, and fill in some gaps. Unfortunately, this particular page is one of the gaps we're looking to fill and isn't yet available.</p>"},{"location":"azure-tre-overview/compliance-info/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"azure-tre-overview/cost-reporting/","title":"Cost Reporting","text":"<p>The exact running costs will depend on the number of workspaces you have deployed, the workspace services you have enabled within them and the Azure Data center region. TRE users can use the Azure TRE cost API to get a report of the running costs of TRE resources according to their role.</p> <p>TRE provides a set of cost APIs which generates costs reports by custom timeframe, and level of details according to user's role.</p> <p>Cost APIs are based on\u00a0Azure Cost Management\u00a0and\u00a0TRE Templates azure resource tagging, Azure resources must be tagged when authoring new template.</p>"},{"location":"azure-tre-overview/cost-reporting/#cost-apis","title":"Cost APIs","text":"Method Endpoint Description Allowed Roles Level of details GET /api/costs Get overall costs of a TRE Instance TRE Admin Core services, Shared services, workspaces GET /api/workspace/{workspace_id}/costs Get workspace costs TRE Admin, Workspace Owner Workspace, workspace services, user resources"},{"location":"azure-tre-overview/cost-reporting/#get-overall-cost-report","title":"Get overall cost report","text":"<p>Description</p> <p>Get overall cost report for TRE instance (core services), per shared services and per workspace</p> <p>Authorization</p> <p>Only TRE Admin can call this url, others will get unauthorized</p> <p>Endpoint</p> <p>GET /api/costs</p> <p>Query Parameters</p> Parameter name Type Description Default Value from, to datetime Custom time period, up to 1 year timeframe, iso-8601 format Month to date period granularity Enum (Daily, None) The granularity of rows in the query. None <p>Output</p> <pre><code>{\n\"coreServices\": [\n{\"date\":\"\", \"cost\":\"\", \"currency\":\"\"} ],\n\"sharedServices\": [ {\n\"id\":\"shared service id\",\n\"name\":\"shared service name\",\n\"costs\": [\n{\"date\":\"\", \"cost\":\"\", \"currency\":\"\"} ]\n}],\n\"workspaces\": [ {\n\"id\": \"workspace id\",\n\"name\": \"workspace name\", \"costs\":[\n{\"date\":\"\", \"cost\":\"\", \"currency\":\"\"} ]}\n]\n}\n</code></pre>"},{"location":"azure-tre-overview/cost-reporting/#get-workspace-cost-report","title":"Get workspace cost report","text":"<p>Description</p> <p>Get overall cost report for a specific workspace</p> <p>Authorization</p> <p>Only TRE Admin and the workspace owner can call this url, others will get unauthorized</p> <p>Input</p> <p>GET /api/workspaces/{workspace_id}/costs</p> <p>Query Parameters</p> Parameter name Type Description Default Value from, to datetime Custom time period, up to 1 year timeframe, iso-8601 format Month to date period granularity Enum (Daily, None) The granularity of rows in the query. None workspace_id Guid The workspace id to generate report for Required field for workspace and user resource level apis <p>Output <pre><code>{\n\"id\": \"workspace id\",\n\"name\": \"workspace name\", \"workspaceServices\":[{\n\"id\": \"workspace service id\",\n\"name\": \"workspace service name\", \"costs\":[{\"date\":\"\", \"cost\":\"\", \"currency\":\"\"}], \"userResources\":[{\n\"id\": \"user resource id\",\n\"name\": \"user resource name\", \"costs\":[{\"date\":\"\", \"cost\":\"\", \"currency\":\"\"}], }]\n}]\n}\n</code></pre></p>"},{"location":"azure-tre-overview/cost-reporting/#sequence-diagram","title":"Sequence Diagram","text":"<p>source</p> <p></p>"},{"location":"azure-tre-overview/cost-reporting/#limitations-and-notes","title":"Limitations and notes","text":"<ul> <li>Cost and usage data is typically available in Cost Management within 8-24 hours.</li> </ul> <ul> <li>Tags aren't applied to historical data, template authors need to make sure all relevant Azure resources of a TRE resource are tagged as instructed.</li> </ul> <ul> <li>Cost records might include multiple currencies for the same date and TRE resource.</li> </ul> <ul> <li>Once cost data becomes available in Cost Management, it will be retained for at least seven years. Only the last 13 months is available from the TRE Cost API and Azure Portal. For historical data before 13 months, please use Exports or the UsageDetails API.</li> </ul> <ul> <li>For more information please refer to Azure Cost Management and Cost API swagger docs.</li> </ul>"},{"location":"azure-tre-overview/cost-reporting/#azure-resources-tagging","title":"Azure Resources Tagging","text":"<p>TRE Cost Reporting is based on Azure tagging to be able to generate cost report for core services, shared services, workspace, workspace services and user resources. Templates authors need to make sure that underling Azure resources are tagged with the following tags:</p> Tag Value Applies to <code>tre_id</code> Unique ID of the TRE instance All resources of a TRE instance <code>tre_core_service_id</code> Unique ID of the TRE instance All TRE core azure resources <code>shared_service_id</code> The shared service unique ID Shared Services <code>workspace_id</code> The workspace unique ID Workspaces, Workspace Services and User Resources <code>workspace_service_id</code> The workspace service unique ID Workspace Services and User Resources <code>user_resource_id</code> The user resoruce unique ID User Resources <p>Notes</p> <ul> <li>Main Azure Container Registry and Storage Account are not be tagged as those resources are used to spin up more than one Azure TRE Instance.</li> <li>There are some cases in which azure resources cannot get tagged by template author due to different reasons, for example services get deployed outside of TRE (Example being Cyclecloud or Cromwell on Azure), or services which doesn't support tagging for cost management (for example Azure ML compute). for the full list of tag support of Azure see this article.</li> </ul> <p></p>"},{"location":"azure-tre-overview/cost-reporting/#tre-cost-api-logic","title":"TRE Cost API Logic","text":"<p>Cost management query API, which Azure TRE Cost APIs are based upon, returns a flat result of all cost with every tag combination which exists on the filtered resources by the provided tag, meaning that a resource which has tre_id, tre_core_service_id, tre_workspace_id, tre_workspace_service_id, and tre_user_resource_id will get be summarized by all those tags. if filtered resources have more tags, those tags will appear in the result.</p> <p>To rollup untagged resources into workspace costs Azure TRE cost API first calls Azure Resource Manager to get all resource group names which are tagged with the workspace_id and passes those names into Azure Cost Management Query API as a filter and group by resource group along with the tag name. untagged costs results will apear in with an empty tag name and get aggregated using the resource group and relevent the workspace id.</p> <p>Azure TRE Cost API joins this response with the hierarchical structure of the requested report.</p> <p>Cost management query API Request example</p> <pre><code>@SUBSCRIPTION = FILL_YOUR_SUBSCRIPTION_ID\n@COST_API_URI = https://management.azure.com/subscriptions/{{SUBSCRIPTION}}/providers/Microsoft.CostManagement\n@COST_API_VERSION = 2021-10-01\n@TRE_ID = mytre\n@TIME_FROM = MM/DD/YYYY\n@TIME_TO = MM/DD/YYYY\n\nPOST {{COST_API_URI}}/query?api-version={{COST_API_VERSION}}&amp;$expand=properties/data\nAuthorization: {{$aadToken $aadV2TenantId}}\nContent-Type: application/json\n</code></pre> <p>Payload <pre><code>{\n\"type\": \"ActualCost\",\n\"timeframe\": \"Custom\", // can be also BillingMonthToDate|MonthToDate|TheLastBillingMonth|TheLastMonth|WeekToDate according to input\n\"timePeriod\": {\n\"from\": \"{{TIME_FROM}}\",\n\"to\": \"{{TIME_TO}}\"\n},\n\"dataset\": {\n\"granularity\": \"None\", // can be also \"Daily\" for total costs\n\"aggregation\": {\n\"totalCost\": {\n\"name\": \"PreTaxCost\", // can be also 'UsageQuantity','Cost','CostUSD','PreTaxCostUSD' (up to two aggregations)\n\"function\": \"Sum\"\n}\n},\n\"filter\": {\n\"or\": [\n{\n\"dimensions\": {\n\"name\": \"ResourceGroup\",\n\"operator\": \"In\",\n\"values\": [\"{{RG_NAME}}\"]\n}\n},\n{\n\"tags\": {\n\"name\": \"{{TAG_KEY}}\",\n\"operator\": \"In\",\n\"values\" : [\n\"{{TAG_VALUE}}\",\n]\n}\n}\n]\n},\n\"grouping\": [\n{\n\"type\": \"Dimension\",\n\"name\": \"ResourceGroup\"\n},\n{\n\"type\": \"Tag\",\n}\n]\n}\n}\n</code></pre></p> <p>Response</p> <pre><code>{\n\"id\": \"subscriptions/xxxxxxxxxxxxx/providers/Microsoft.CostManagement/query/ec1f0eae-9343-4f4e-a0c0-dd219a66efc4\",\n\"name\": \"ec1f0eae-9343-4f4e-a0c0-dd219a66efc4\",\n\"type\": \"Microsoft.CostManagement/query\",\n\"location\": null,\n\"sku\": null,\n\"eTag\": null,\n\"properties\": {\n\"nextLink\": null,\n\"columns\": [\n{\n\"name\": \"PreTaxCost\",\n\"type\": \"Number\"\n},\n{\n\"name\": \"ResourceGroup\",\n\"type\": \"String\"\n},\n{\n\"name\": \"Tag\",\n\"type\": \"String\"\n},\n{\n\"name\": \"Currency\",\n\"type\": \"String\"\n}\n],\n\"rows\": [\n[\n0.00055748658857886549,\n\"rg-mytre\",\n\"\",\n\"USD\"\n],\n[\n3.9306515711531222,\n\"rg-mytre\",\n\"\\\"tre_core_service\\\":\\\"mytre\\\"\",\n\"USD\"\n],\n[\n11.66335497490112,\n\"rg-mytre\",\n\"\\\"tre_id\\\":\\\"mytre\\\"\",\n\"USD\"\n],\n[\n0.033,\n\"rg-mytre\",\n\"\\\"tre_shared_service\\\":\\\"2fea\\\"\",\n\"USD\"\n],\n[\n3.62175702964083,\n\"rg-mytre\",\n\"\\\"tre_shared_service\\\":\\\"4a5b\\\"\",\n\"USD\"\n],\n[\n0.093523886643774659,\n\"rg-mytre-ws-5e86\",\n\"\\\"tre_user_resource_id\\\":\\\"126d\\\"\",\n\"USD\"\n],\n[\n0.078465743393993009,\n\"rg-mytre-ws-5e86\",\n\"\\\"tre_user_resource_id\\\":\\\"2627\\\"\",\n\"USD\"\n],\n[\n0.20275980676694544,\n\"rg-mytre-ws-5e86\",\n\"\\\"tre_user_resource_id\\\":\\\"319e\\\"\",\n\"USD\"\n],\n[\n0.17165788614506686,\n\"rg-mytre-ws-af30\",\n\"\\\"tre_user_resource_id\\\":\\\"3370\\\"\",\n\"USD\"\n],\n[\n0.17518017912599823,\n\"rg-mytre-ws-af30\",\n\"\\\"tre_user_resource_id\\\":\\\"b2be\\\"\",\n\"USD\"\n],\n[\n0.00015748658857886549,\n\"rg-mytre-ws-5e86\",\n\"\",\n\"USD\"\n],\n[\n0.39905729127776768,\n\"rg-mytre-ws-5e86\",\n\"\\\"tre_workspace_id\\\":\\\"5e86\\\"\",\n\"USD\"\n],\n[\n0.98272254462049369,\n\"rg-mytre-ws-af30\",\n\"\\\"tre_workspace_id\\\":\\\"af30\\\"\",\n\"USD\"\n],\n[\n0.17198963003776765,\n\"rg-mytre-ws-5e86\",\n\"\\\"tre_workspace_service\\\":\\\"8d0a\\\"\",\n\"USD\"\n],\n[\n0.54959787203801058,\n\"rg-mytre-ws-af30\",\n\"\\\"tre_workspace_service\\\":\\\"e70d\\\"\",\n\"USD\"\n]\n]\n}\n}\n</code></pre>"},{"location":"azure-tre-overview/networking/","title":"Network Architecture","text":"<p>The Trusted Research Environment (TRE) network topology is based on hub-spoke. The TRE Core VNET (Azure Virtual Network) is the central hub and each workspace is a spoke.</p> <p></p> <p>Azure TRE VNETs are segregated allowing limited traffic between the TRE Core VNET and Workspace VNETs. The security rules are managed by <code>nsg-ws</code> network security group. See workspace network security groups (NSG) further down.</p> <p>The Core VNET is further divided into subnets.</p> Subnet Description <code>AzureBastionSubnet</code> A dedicated subnet for Azure Bastion hosts. <code>AppGwSubnet</code> Subnet for Azure Application Gateway controlling ingress traffic. <code>AzureFirewallSubnet</code> Subnet for Azure Firewall controlling egress traffic. <code>ResourceProcessorSubnet</code> Subnet for VMSS used by the Composition Service to host Docker containers to execute Porter bundles that deploys Workspaces. <code>WebAppSubnet</code> Subnet for TRE API. <code>SharedSubnet</code> Shared Services subnet for all things shared by TRE Core and Workspaces. Such as Source Mirror Shared Service and Package Mirror Shared Service. <p>All subnets (Core and Workspace subnets) have a default route which directs egress traffic to the Azure Firewall to ensure only explicitly allowed destinations on the Internet to be accessed.</p> <p>There are a couple of exceptions:</p> <ul> <li><code>AzureFirewallSubnet</code> as it hosts the Azure Firewall which routes traffic to the Internet.</li> <li><code>AzureBastionSubnet</code> as it hosts Azure Bastion which is the management jump box within the VNET with Internet access.</li> <li><code>AppGwSubnet</code> as it hosts the Azure Application Gateway which has to be able to a ping the health endpoints e.g. TRE API.</li> </ul>"},{"location":"azure-tre-overview/networking/#ingress-and-egress","title":"Ingress and egress","text":"<p>Ingress traffic from the Internet is only allowed through the Application Gateway, which forwards HTTPS (port 443) call to the TRE API in the <code>WebAppSubnet</code>.</p> <p>Egress traffic is routed through the Azure Firewall with a few exceptions and by default all ingress and egress traffic is denied except explicitly allowed.</p> <p>The explicitly allowed egress traffic is described here:</p> <ul> <li>Resource Processor</li> <li>TRE API</li> <li>Gitea Shared Service</li> <li>Nexus Shared Service</li> </ul>"},{"location":"azure-tre-overview/networking/#azure-monitor","title":"Azure Monitor","text":"<p>Azure Monitor resources are secured using Azure Monitor Private Link Scope (AMPLS) keeping all traffic inside the Microsoft Azure backbone network. The Azure Monitor resources and their network configuration is defined in <code>/templates/core/terraform/azure-monitor</code> folder and the required private DNS zones in file <code>/templates/core/terraform/network/dns_zones.tf</code>.</p>"},{"location":"azure-tre-overview/networking/#network-security-groups","title":"Network security groups","text":""},{"location":"azure-tre-overview/networking/#tre-core","title":"TRE Core","text":"<p>Network security groups (NSG), and their security rules for TRE core resources are defined in <code>/templates/core/terraform/network/network_security_groups.tf</code>.</p> Network security group Associated subnet(s) <code>nsg-bastion-subnet</code> <code>AzureBastionSubnet</code> <code>nsg-app-gw</code> <code>AppGwSubnet</code> <code>nsg-default-rules</code> <code>ResourceProcessorSubnet</code>, <code>SharedSubnet</code>, <code>WebAppSubnet</code>"},{"location":"azure-tre-overview/networking/#workspaces","title":"Workspaces","text":"<p>Azure TRE VNETs are segregated allowing limited traffic between the TRE Core VNET and Workspace VNETs. The rules to manage and limit the traffic between the TRE Core VNET and Workspace VNETs are defined by the <code>nsg-ws</code> network security group:</p> <ul> <li>Inbound traffic from TRE Core VNET to workspace allowed for Azure Bastion (22, 3389) - All other inbound traffic from Core to workspace denied.</li> <li>Outbound traffic to <code>SharedSubnet</code> from Workspace allowed.</li> <li>Outbound traffic to Internet allowed on HTTPS port 443 (next hop Azure Firewall).</li> <li>All other outbound traffic denied.</li> </ul> <p>Each of these rules can be managed per workspace.</p> <p>Caution</p> <p>In Azure, traffic between subnets are allowed except explicitly denied.</p>"},{"location":"azure-tre-overview/tre-resources-breakdown/","title":"Azure TRE Resource Breakdown","text":"<p>The Azure services deployed within an Azure TRE are described below.</p> <p>Once an Azure TRE has been provisioned in an Azure Subscription, you will have two Resource Groups:</p> <ol> <li>Azure TRE Management Resource Group - Pre-requisiste for deploying an Azure TRE instance</li> <li>Azure TRE Resource Group - Core Azure TRE instance</li> </ol>"},{"location":"azure-tre-overview/tre-resources-breakdown/#azure-tre-management-resource-group","title":"Azure TRE Management Resource Group","text":"Name Azure Service Description Additional links {MGMT_STORAGE_ACCOUNT_NAME} Storage Account Azure TRE Terraform and Porter state Storage Blobs {ACR_NAME} Container Registry Azure TRE container images (Porter bundles) Container Registry"},{"location":"azure-tre-overview/tre-resources-breakdown/#azure-tre-resource-group","title":"Azure TRE Resource Group","text":"Name Azure Service Description Additional links api-{TRE_ID} App Service Azure TRE Python api responsible for all operations on Workspaces and managing Workspace Templates built using the FastAPI framework FastAPI gitea-{TRE_ID} App Service Azure TRE Source Mirror - allows mirroring git repositories Gitea nexus-{TRE_ID} App Service Azure TRE Package Mirror - allows mirroring packages Sonatype Nexus plan-{TRE_ID} App Service Plan Compute resources in which the TRE app services run App Hosting plans agw-{TRE_ID} Azure Application Gateway Azure TRE App Gateway provides single public IP address with SSL for accessing core TRE resources Azure Application Gateway appi-{TRE_ID} Application Insights Telemetry for all API invocations Application Insights cosmos-{TRE_ID} Azure Cosmos DB Account NoSQL state store of TRE resources, templates and operations Cosmos DB mysql-{TRE_ID} Azure Database for MySQL server SQL state store for Gitea Gitea Database ampls-{TRE_ID} Azure Monitor Private Link Scope Provides secure link between PaaS resources and the TRE vnet using private endpoints Azure Monitor Private Link Scope bas-{TRE_ID} Azure Bastion Provides secure access for RDP/SSH to TRE VM (jumpbox) Azure Bastion vm-dsk-{TRE_ID} Disk Managed storage disk for TRE VM (jumpbox) Managed Disks fw-dsk-{TRE_ID} Azure Firewall Azure TRE Firewall restricts external outbound traffic from all TRE resources Azure Firewall kv-{TRE_ID} Azure Key Vault Management of TRE secrets &amp; certificates Azure Key Vault log-{TRE_ID} Log Analytics Workspace Azure Monitor Logs store for all TRE resources Log Analytics id-agw-{TRE_ID} Managed Identity User-managed identity for TRE Application Gateway Managed Identities id-api-{TRE_ID} Managed Identity User-managed identity for TRE API App Service Managed Identities id-gitea-{TRE_ID} Managed Identity User-managed identity for TRE Gitea App Service Managed Identities id-vmss-{TRE_ID} Managed Identity User-managed identity for TRE Resource Processer (VMSS) Managed Identities sb-{TRE_ID} Service Bus Namespace Messaging for TRE API Service Bus stappinsights{TRE_ID} Storage Account Storage for TRE Application Insights telemetry logs Storage Blobs stg{TRE_ID} Storage Account Files shares for TRE services such as Porter, Gitea, Nexus Storage Files stweb{TRE_ID} Storage Account Storage for Azure TRE Let's Encrypt Storage Blob vm-{TRE_ID} Virtual Machine Azure TRE VM (jumpbox) Windows Virtual Machine vm-{TRE_ID} Virtual Machine Scale Set Azure TRE Resource Processor Virtual Machine Scale Sets vnet-{TRE_ID} Virtual Network Azure TRE VNET central hub Virtual Networks rt-{TRE_ID} Route Table Azure TRE route table Route Tables <p>Note</p> <p>Network resources such as Network Interfaces, Network Security Groups, Private Endpoints, Private DNS zones and Public IP addresses are not listed above.</p>"},{"location":"azure-tre-overview/tre-resources-breakdown/#azure-tre-workspace-resource-group","title":"Azure TRE Workspace Resource Group","text":"<p>A TRE Workspace will be provisioned in a separate Resource Group along with its own resources.  An example TRE Workspace is shown and described here.</p> <p></p> Name Azure Service Description Additional links guacamole-{TRE_ID}-ws-XXXX-svc-XXXX App Service RDP for accessing workspace VMs Apache Guacamole kv-{TRE_ID}-ws-XXXX Azure Key Vault Management of TRE workspace secrets &amp; certificates Azure Key Vault osdisk-windowsvm8f45 Disk Azure VM storage disk Managed Disks plan-09d0ba4f-f79f-4047-aa2c-03fc9df7b318 App Service plan Compute resources in which the workspace app services (Gitea) run App Hosting Plans stgwsb318 Storage account Workspace Storage account Storage Blobs vnet-{TRE_ID}-ws-XXXX Virtual Network Azure TRE VNET spoke Virtual Networks windowsvm8f45 Virtual Machine Windows VM instance for research Windows Virtual Machine <p>Note</p> <p>Network resources such as Network Interfaces, Network Security Groups and Private Endpoints are not listed above.</p>"},{"location":"azure-tre-overview/user-roles/","title":"User roles","text":"<p>The Azure TRE solution has 8 different user roles defined. The roles are modeled around a set of tasks for each role. The roles are not mutually exclusive, and one person can have multiple roles assigned to be able to carry out a broader set of tasks.</p> <p>Before you deploy a Trusted Research Environment based on the Azure TRE solution, you should consider your scenario and have an understanding of which of these roles that needs to be staffed.</p>"},{"location":"azure-tre-overview/user-roles/#role-overview","title":"Role overview","text":"<p>While we have defined 8 different user roles for the Azure TRE solution, not all of them are required in all scenarios. Three of the roles support role-based access control (RBAC) within the TRE.  </p> Role Key task TRE RBAC Azure administrator Deploy the TRE TRE administrator Administer the TRE \u2714 TRE workspace owner Own a workspace \u2714 Researcher Perform research on the data \u2714 Airlock Manager Approves data import &amp; export \u2714 TRE service integrator Integrate additional workspace services Azure TRE developer Extend the TRE OSS solution Data engineer Move data to and potentially from the TRE Information security officer Validate and sign-off TRE deployment <p>Info</p> <p>More granular RBAC information is available here.</p>"},{"location":"azure-tre-overview/user-roles/#azure-administrator","title":"Azure administrator","text":"<p>Provisions the Azure TRE solution in an Azure subscription and performs tasks that require knowledge of Azure operations and has access to the Azure subscription.</p> <p>Example tasks:</p> <ul> <li>Provision Azure TRE solution instances.</li> <li>Second line support for TRE administrators, TRE workspace owners and Researchers when Azure TRE troubleshooting is required.</li> <li>Work with the data engineer to connect the Azure TRE with the data platform.</li> <li>Troubleshoot provisioning issues and failed deployments.</li> <li>Manage TRE administrator users.</li> <li>Manage data backups and restores.</li> <li>Update the Azure TRE instances.</li> <li>Configure log and metrics alerts.</li> </ul> <p>Expected skills:</p> <ul> <li>Azure administration and operations.</li> <li>Infrastructure as Code (Terraform, ARM, Git)</li> <li>PowerShell, Bash</li> </ul>"},{"location":"azure-tre-overview/user-roles/#tre-administrator","title":"TRE administrator","text":"<p>Day-to-day running and operations of the Azure TRE instance without touching Azure resources.</p> <p>Example tasks:</p> <ul> <li>Manage workspace owner users.</li> <li>Provision workspaces.</li> <li>Manage shared services e.g., available packages in package mirror shared service.</li> <li>Monitor workspace usage and billing.</li> <li>Set and manage quotas.</li> <li>Create and manage workspaces</li> </ul> <p>Expected skills:</p> <ul> <li>Limited or no Azure knowledge expected.</li> </ul>"},{"location":"azure-tre-overview/user-roles/#tre-workspace-owner","title":"TRE workspace owner","text":"<p>Owns a specific workspace and has additional privileges than the researcher within the workspace. Is most likely also a Researcher.</p> <p>Example tasks:</p> <ul> <li>Manage Researcher users.</li> <li>Export data from workspace.</li> <li>Import data and make it available within the workspace.</li> <li>Enable services within the workspace.</li> <li>Monitor billing and usage of the workspace.</li> <li>Create and manage workspace services</li> </ul> <p>Expected skills:</p> <ul> <li>Limited or no Azure knowledge expected.</li> </ul>"},{"location":"azure-tre-overview/user-roles/#researcher","title":"Researcher","text":"<p>Has access to one specific workspace and can use all the services provisioned within that workspace.</p> <p>Example tasks:</p> <ul> <li>Import software packages needed to conduct research (PyPi, Conda, Apt).</li> <li>Perform research using the services in the workspace.</li> <li>Create and manage user resources</li> </ul> <p>Expected skills:</p> <ul> <li>Python, R</li> <li>Git</li> <li>Linux</li> </ul>"},{"location":"azure-tre-overview/user-roles/#airlock-manager","title":"Airlock Manager","text":"<p>Approves (and reviews in some instances) the data that is being imported to and exported from a TRE Workspace</p> <p>Example tasks:</p> <ul> <li>Approve Airlock import requests</li> <li>Approve Airlock export requests</li> <li>Review the data being improted to and exported from a TRE Workspace</li> </ul>"},{"location":"azure-tre-overview/user-roles/#tre-service-integrator","title":"TRE service integrator","text":"<p>Integrates workspace service types with an Azure TRE instance. This involves extending the Azure Infrastructure as Code templates to make a workspace service available within an Azure TRE instance.</p> <p>Example tasks:</p> <ul> <li>Integrate a workspace service type with your Azure TRE instance.</li> <li>Implement Infrastructure as Code templates for new workspace service types.</li> </ul> <p>Expected skills:</p> <ul> <li>Infrastructure as Code (Terraform, ARM, Git)</li> <li>Python, Bash</li> <li>Azure administration</li> </ul>"},{"location":"azure-tre-overview/user-roles/#azure-tre-developer","title":"Azure TRE developer","text":"<p>Software developer who contributes to the development of the Azure TRE solution.</p> <p>Example tasks:</p> <ul> <li>Modify the deployment service, API and other components of the Azure TRE solution.</li> <li>Contribute to the Azure TRE OSS solution.</li> </ul> <p>Expected skills:</p> <ul> <li>Python, Bash</li> <li>Infrastructure as Code (Terraform, ARM, Git</li> <li>Azure administration</li> </ul>"},{"location":"azure-tre-overview/user-roles/#data-engineer","title":"Data engineer","text":"<p>Supporting role that is expected to build data movement pipelines between the data platform (not part of the TRE), and the TRE instance.</p> <p>Example tasks:</p> <ul> <li>Transfer data from the data platform to the TRE and potentially back.</li> <li>Create data movement and transformation pipelines.</li> </ul> <p>Expected skills:</p> <ul> <li>Python, Bash, Linux</li> <li>Azure Data Factory, Other ETL tools.</li> </ul>"},{"location":"azure-tre-overview/user-roles/#information-security-officer","title":"Information Security Officer","text":"<p>Needs to understand the security posture of the TRE to ensure that the organization is compliant with the information governance framework and additional relevant regulations.</p> <p>Example tasks:</p> <ul> <li>Use the Azure TRE documentation to understand the security posture of the TRE.</li> <li>Work with Azure administrator and TRE administrator to enforce the required security and privacy controls on the TRE.</li> <li>Commission penetration testing.</li> <li>Work with organization Information Governance committee to validate and sign-off Azure TRE deployment</li> </ul>"},{"location":"tre-admins/auth/","title":"Introduction to Authentication and Authorization","text":"<p>Azure Active Directory (AAD) is the backbone of Authentication and Authorization in the Trusted Research Environment. AAD holds the identities of all the TRE/workspace users, including administrators, and connects the identities with applications which define the permissions for each user role.</p> <p>It is common that the Azure Administrator is not necessarily the Azure Active Directory Administrator. Due to this, this step may have to be carried out by a different individual/team. We have automated this into a simple command, but should you wish, you can run these steps manually.</p> <p>This page describes the automated Auth setup for TRE.</p>"},{"location":"tre-admins/auth/#pre-requisites","title":"Pre-requisites","text":"<p>The automation utilises a <code>make</code> command, which reads a few environment variables and creates the AAD assets. The following values are needed to be in place before you run the creation process. (<code>/templates/core/.env</code>)</p> Key Description TRE_ID This is used to build up the name of the identities AAD_TENANT_ID The tenant id of where your AAD identities will be placed. This can be different to the tenant where your Azure resources are created. LOCATION Where your Azure assets will be provisioned (eg. westeurope). This is used to add a redirect URI from the Swagger UI to the API Application. AUTO_WORKSPACE_APP_REGISTRATION Default of <code>false</code>. Setting this to true grants the <code>Application.ReadWrite.All</code> and <code>Directory.Read.All</code> permission to the Application Admin identity. This identity is used to manage other AAD applications that it owns, e.g. Workspaces. If you do not set this, the identity will have <code>Application.ReadWrite.OwnedBy</code>. Further information can be found here. AUTO_WORKSPACE_GROUP_CREATION Default of <code>false</code>. Setting this to true grants the <code>Group.ReadWrite.All</code> permission to the Application Admin identity. This identity can then create security groups aligned to each applciation role. Active Directory licencing implications need to be considered as Group assignment is a premium feature."},{"location":"tre-admins/auth/#create-authentication-assets","title":"Create Authentication assets","text":"<p>You can build all of the Identity assets by running the following at the command line <pre><code>make auth\n</code></pre> This will create five identities, and if successful will write a new file; <code>/devops/auth.env</code>. If you are building locally, these values will be used when building your TRE. If you are setting this up for CI/CD, then these values will be needed by your Build Orchestrator.</p> <p>The contents of your <code>/devops/auth.env</code> file should contain : -</p> Variable Description <code>APPLICATION_ADMIN_CLIENT_ID</code> This client will administer AAD Applications for TRE <code>APPLICATION_ADMIN_CLIENT_SECRET</code> This client will administer AAD Applications for TRE <code>TEST_ACCOUNT_CLIENT_ID</code> This will be created by default, but can be disabled by editing <code>/devops/scripts/create_aad_assets.sh</code>. This is the user that will run the tests for you <code>TEST_ACCOUNT_CLIENT_SECRET</code> This will be created by default, but can be disabled by editing <code>/devops/scripts/create_aad_assets.sh</code>. This is the user that will run the tests for you <code>API_CLIENT_ID</code> API application (client) ID. <code>API_CLIENT_SECRET</code> API application client secret. <code>SWAGGER_UI_CLIENT_ID</code> Swagger (OpenAPI) UI application (client) ID. <code>WORKSPACE_API_CLIENT_ID</code> Each workspace is secured behind it's own AD Application <code>WORKSPACE_API_CLIENT_SECRET</code> Each workspace is secured behind it's own AD Application. This is the secret for that application."},{"location":"tre-admins/auth/#using-a-separate-azure-active-directory-tenant","title":"Using a separate Azure Active Directory tenant","text":"<p>Caution</p> <p>This section is only relevant it you are setting up a separate Azure Active Directory tenant for use. This is only recommended for development environments when you don't have the required permissions to register applications in Azure Active Directory. Using a separate Azure Active Directory tenant will prevent you from using certain Azure Active Directory integrated services. For production deployments, work with your Azure Active Directory administrator to perform the required registration</p> <ol> <li> <p>Create an Azure Active Directory tenant     To create a new Azure Active Directory tenant, follow the steps here</p> </li> <li> <p>Follow the steps outlined above. <code>make auth</code> should logon to the correct tenant. Make sure you logon back to the correct tenant before running <code>make all</code>.</p> </li> </ol>"},{"location":"tre-admins/auth/#app-registrations","title":"App registrations","text":"<p>App registrations (represented by service principals) define the various access permissions to the TRE system. There are a total of five main Applications of interest.</p> AAD Application Description TRE API application This is the main application and used to secure access to the TRE API. TRE UX This is the client application that will authenticate to the TRE/Workspace APIs. Application Admin There are times when workspace services need to update the AAD Application. For example, Guacamole needs to add a redirect URI to the Workspace AAD Application. This identity is used to manage AAD Applications. Automation App This application is created so that you can run the tests or any CI/CD capability without the need to divulge a user password. This is particularly important if your tenant is MFA enabled. Workspace API Typically you would have an application securing one or more workspaces that are created by TRE. <p>Some of the applications require admin consent to allow them to validate users against the AAD. Check the Microsoft Docs on Configure the admin consent workflow on how to request admin consent and handle admin consent requests.</p> <p>We strongly recommend that you use <code>make auth</code> to create the AAD assets as this has been tested extensively. Should you wish to create these manually via the Azure Portal; more information can be found here.</p>"},{"location":"tre-admins/environment-variables/","title":"Environment variables","text":"<p>Info</p> <p>The <code>.tfvars</code> file is intentionally not used. The <code>.env</code> file format is easier to parse, meaning we can use the values for bash scripts and other purposes.</p>"},{"location":"tre-admins/environment-variables/#for-shared-management-resources-in-devopsenv","title":"For shared management resources in <code>/devops/.env</code>","text":"Environment variable name Description <code>LOCATION</code> The Azure location (region) for all resources. <code>MGMT_RESOURCE_GROUP_NAME</code> The shared resource group for all management resources, including the storage account. <code>MGMT_STORAGE_ACCOUNT_NAME</code> The name of the storage account to hold the Terraform state and other deployment artifacts. <code>TERRAFORM_STATE_CONTAINER_NAME</code> The name of the blob container to hold the Terraform state Default value is <code>tfstate</code>. <code>ACR_NAME</code> A globally unique name for the Azure Container Registry (ACR) that will be created to store deployment images. <code>ARM_SUBSCRIPTION_ID</code> Optional for manual deployment. If not specified the <code>az cli</code> selected subscription will be used. The Azure subscription ID for all resources. <code>ARM_CLIENT_ID</code> Optional for manual deployment without logged-in credentials. The client whose azure identity will be used to deploy the solution. <code>ARM_CLIENT_SECRET</code> Optional for manual deployment without logged-in credentials. The password of the client defined in <code>ARM_CLIENT_ID</code>. <code>ARM_TENANT_ID</code> Optional for manual deployment. If not specified the <code>az cli</code> selected subscription will be used. The AAD tenant of the client defined in <code>ARM_CLIENT_ID</code>."},{"location":"tre-admins/environment-variables/#for-azure-tre-instance-in-templatescoreenv","title":"For Azure TRE instance in <code>/templates/core/.env</code>","text":"Environment variable name Description <code>TRE_ID</code> A globally unique identifier. <code>TRE_ID</code> can be found in the resource names of the Azure TRE instance; for example, a <code>TRE_ID</code> of <code>mytre-dev</code> will result in a resource group name for Azure TRE instance of <code>rg-mytre-dev</code>. This must be less than 12 characters. Allowed characters: Alphanumeric, underscores, and hyphens. <code>TRE_URL</code> This will be generated for you by populating your <code>TRE_ID</code>. This is used so that you can automatically register bundles <code>CORE_ADDRESS_SPACE</code> The address space for the Azure TRE core virtual network. <code>/22</code> or larger. <code>TRE_ADDRESS_SPACE</code> The address space for the whole TRE environment virtual network where workspaces networks will be created (can include the core network as well). E.g. <code>10.0.0.0/12</code> <code>SWAGGER_UI_CLIENT_ID</code> Generated when following pre-deployment steps guide. Client ID for swagger client to make requests. <code>AAD_TENANT_ID</code> Generated when following pre-deployment steps guide. Tenant id against which auth is performed. <code>API_CLIENT_ID</code> Generated when following pre-deployment steps guide. Client id of the \"TRE API\". <code>API_CLIENT_SECRET</code> Generated when following pre-deployment steps guide. Client secret of the \"TRE API\". <code>STATEFUL_RESOURCES_LOCKED</code> If set to <code>false</code> locks on stateful resources won't be created. A recommended setting for developers. <code>ENABLE_AIRLOCK_MALWARE_SCANNING</code> If False, Airlock requests will skip the malware scanning stage. If set to True, Setting up a scanner manually is required! <code>ENABLE_LOCAL_DEBUGGING</code> Set to <code>false</code> by default. Setting this to <code>true</code> will ensure that Azure resources are accessible from your local development machine. (e.g. ServiceBus and Cosmos) <code>PUBLIC_DEPLOYMENT_IP_ADDRESS</code> The public IP address of the machine that is deploying TRE. (Your desktop or the build agents). In certain locations a dynamic script to retrieve this from https://ipecho.net/plain does not work. If this is the case, then you can 'hardcode' your IP. <code>RESOURCE_PROCESSOR_VMSS_SKU</code> The SKU of the VMMS to use for the resource processing VM. <code>CORE_APP_SERVICE_PLAN_SKU</code> The SKU of AppService plans created for the core infrastructure. <code>WORKSPACE_APP_SERVICE_PLAN_SKU</code> Optional. The SKU used for AppService plan used in E2E tests unless otherwise specified. Default value is <code>P1v2</code>."},{"location":"tre-admins/registering-templates/","title":"Registering Templates","text":"<p>To enable users to deploy Workspaces, Workspace Services or User Resources, we need to register their Templates. This can be done wither by running <code>make</code> commands; using the API or devops scripts. In this article both approaches are described.</p> <p>Info</p> <p>Templates are encapsulated in Porter bundles.</p>"},{"location":"tre-admins/registering-templates/#registration-with-make-commands","title":"Registration with make commands","text":"<p>Porter bundles can be registered with <code>make</code> commands which can be useful for CI/CD scenarios. To start on should build the Porter bundle running the command <code>make bundle-build</code>. Once built a Template must be published so it can the registered. For this the commands <code>make bundle publish</code> and <code>make bundle-register</code> can be used Here we use the workspace service Azure ML bundle as an example:</p> <pre><code>make bundle-build DIR=templates/workspace_services/azureml\nmake bundle-publish DIR=templates/workspace_services/azureml\nmake bundle-register DIR=templates/workspace_services/azureml BUNDLE_TYPE=workspace_service\n</code></pre>"},{"location":"tre-admins/registering-templates/#registration-using-swagger-ui","title":"Registration using Swagger UI","text":"<p>Porter bundles can also be registered interactively using the Swagger UI. For that we need to build and publish the porter bundle  </p> <ol> <li> <p>Build the Porter bundle</p> <pre><code>make bundle-build DIR=templates/workspace_services/azureml\nmake bundle-publish DIR=templates/workspace_services/azureml\n</code></pre> </li> <li> <p>Use the utility script to generate the payload. The script needs to be executed from within the bundle directory, for example <code>/templates/workspaces/base/</code></p> <pre><code>../../../devops/scripts/register_bundle_with_api.sh -r &lt;acr_name&gt; -i -t workspace\n</code></pre> <p>Copy the resulting JSON payload.</p> </li> <li> <p>Navigate to the Swagger UI at <code>/api/docs</code></p> </li> <li>Log into the Swagger UI using <code>Authorize</code></li> <li> <p>Click <code>Try it out</code> on the <code>POST</code> <code>/api/workspace-templates</code> operation:</p> <p></p> </li> <li> <p>Paste the payload json generated earlier into the <code>Request body</code> field, then click <code>Execute</code>. Review the server response.</p> </li> <li>Verify the template registration using the <code>GET</code> operation on <code>/api/workspace-templates</code>. The name of the template should now be listed.</li> </ol>"},{"location":"tre-admins/registering-templates/#registration-using-script","title":"Registration using script","text":"<p>To use the script to automatically register the template, you must create a user that does not require an interactive login per the e2e test user documentation here.</p> <p>The script needs to be executed from within the bundle directory, for example <code>/templates/workspaces/base/</code></p> <pre><code>Usage: ../../../devops/scripts/register_bundle_with_api.sh [-u --tre_url]  [-c --current] [-i --insecure]\n\nOptions:\n   -r, --acr-name                Azure Container Registry Name\n   -t, --bundle-type             Bundle type: workspace, workspace_service, user_resource or shared_service\n   -w, --workspace-service-name  The template name of the user resource (if registering a user_resource)\n   -c, --current                 Make this the currently deployed version of this template\n   -i, --insecure                Bypass SSL certificate checks\n   -u, --tre_url                 URL for the TRE (required for automatic registration)\n   -a, --access-token            Azure access token to automatically post to the API (required for automatic registration)\n   -v, --verify                  Verify registration with the API\n</code></pre> <p>In addition to generating the payload, the script posts the payload to the <code>/api/workspace-templates</code> endpoint. Once registered the template can be retrieved by a <code>GET</code> operation on <code>/api/workspace-templates</code>.</p> <p>Tip</p> <p>Follow the same procedure to register workspace service templates and user resource templates</p>"},{"location":"tre-admins/start-stop/","title":"Start/Stop Azure TRE","text":"<p>Once you've provisioned an Azure TRE instance it will begin to incurr running costs of the underlying Azure services.</p> <p>Within evaluation or development, you may want to \"pause\" the TRE environment during out of hours or weekends, to reduce costs without having to completely destroy the environment.  The following <code>make targets</code> provide a simple way to start and stop both the Azure Firewall and Azure Application Gateway instances, considerably reducing the Azure TRE instance running costs.</p> <p>Info</p> <p>After running <code>make all</code> underlying Azure TRE services are automatically started, billing will start.</p>"},{"location":"tre-admins/start-stop/#start-azure-tre","title":"Start Azure TRE","text":"<p>This will allocate the Azure Firewall settings with a public IP and start the Azure Application Gateway service, starting billing of both services.</p> <pre><code>make tre-start\n</code></pre>"},{"location":"tre-admins/start-stop/#stop-azure-tre","title":"Stop Azure TRE","text":"<p>This will deallocate the Azure Firewall public IP and stop the Azure Application Gateway service, stopping billing of both services.</p> <pre><code>make tre-stop\n</code></pre>"},{"location":"tre-admins/start-stop/#automating-stop","title":"Automating <code>stop</code>","text":"<p>In certain situations, you might want to stop any TRE running on a schedule to reduce costs in a wider way. We have this procedure setup in our development subscriptions where each night we stop all our environments after which each developer would need to manually start their TRE when they need it again.</p>"},{"location":"tre-admins/start-stop/#requirements","title":"Requirements","text":"<p>We use Azure Automation to run this procedure.</p> <p>Be sure to create a runbook with Powershell 7.1 enabled and an identity with contributor permissions on the subscription. Note that the script below uses a system managed identity and if you use something different then you might need to update the authentication part.</p> <p>If you create a new Automation account, you will have the required modules preinstalled.</p> <p>Finally, schedule it to run when it makes sense for you.</p>"},{"location":"tre-admins/start-stop/#runbook-script","title":"Runbook Script","text":"<pre><code>try\n{\n    \"Logging in to Azure...\"\n    Connect-AzAccount -Identity\n}\ncatch {\n    Write-Error -Message $_.Exception\n    throw $_.Exception\n}\n\n$azContext = Get-AzContext\n$azProfile = [Microsoft.Azure.Commands.Common.Authentication.Abstractions.AzureRmProfileProvider]::Instance.Profile\n$profileClient = New-Object -TypeName Microsoft.Azure.Commands.ResourceManager.Common.RMProfileClient -ArgumentList ($azProfile)\n$token = $profileClient.AcquireAccessToken($azContext.Subscription.TenantId)\n\n$authHeader = @{\n    'Content-Type'='application/json'\n    'Authorization'='Bearer ' + $token.AccessToken\n}\n\n\n$ResourceGroups = Get-AzResourceGroup -Tag @{'project'='Azure Trusted Research Environment'}\nforeach ($Group in $ResourceGroups) \n{\n    if ($Group.ResourceGroupName -like '*-ws-*') {\n      # we deal with the workspace resource groups separately.\n      continue\n    }\n\n    $Firewall = Get-AzFirewall -ResourceGroupName $Group.ResourceGroupName\n    if ($Firewall -ne $null) {\n        $Firewall.Deallocate()\n        Write-Output \"Deallocating $($Firewall.Name)\"\n        Set-AzFirewall -AzureFirewall $Firewall\n    }\n\n    $Gateway = Get-AzApplicationGateway -ResourceGroupName $Group.ResourceGroupName\n    if ($Gateway -ne $null) {\n        Write-Output \"Stopping $($Gateway.Name)\"\n        Stop-AzApplicationGateway -ApplicationGateway $Gateway\n    }\n\n  $MySQLServers = Get-AzResource -ResourceGroupName $Group.ResourceGroupName -ResourceType \"Microsoft.DBforMySQL/servers\"\n  foreach ($Server in $MySQLServers)\n  {\n    # Invoke the REST API\n    Write-Output \"Stopping $($Server.Name)\"\n    $restUri='https://management.azure.com/subscriptions/'+$azContext.Subscription.Id+'/resourceGroups/'+$Group.ResourceGroupName+'/providers/Microsoft.DBForMySQL/servers/'+$Server.Name+'/stop?api-version=2020-01-01'\n    $response = Invoke-RestMethod -Uri $restUri -Method POST -Headers $authHeader\n  }\n\n  $VMSS = Get-AzVMSS -ResourceGroupName $Group.ResourceGroupName\n  foreach ($item in $VMSS)\n  {\n    Write-Output \"Stopping $($item.Name)\"\n    Stop-AzVmss -ResourceGroupName $item.ResourceGroupName -VMScaleSetName $item.Name -Force\n  }\n\n  $VM = Get-AzVM -ResourceGroupName $Group.ResourceGroupName\n  foreach ($item in $VM)\n  {\n    Write-Output \"Stopping $($item.Name)\"\n    Stop-AzVm -ResourceGroupName $item.ResourceGroupName -Name $item.Name -Force\n  }\n\n  $WorkspaceResourceGroups = Get-AzResourceGroup -Name \"$($Group.ResourceGroupName)-ws-*\"\n  foreach ($wsrg in $WorkspaceResourceGroups)\n  {\n    $VM = Get-AzVM -ResourceGroupName $wsrg.ResourceGroupName\n    foreach ($item in $VM)\n    {\n      Write-Output \"Stopping $($item.Name)\"\n      Stop-AzVm -ResourceGroupName $item.ResourceGroupName -Name $item.Name -Force\n    }\n  }\n}\n</code></pre>"},{"location":"tre-admins/tear-down/","title":"Tear-down","text":"<p>To remove the Azure TRE and its resources from your Azure subscription run:</p> <pre><code>make tre-destroy\n</code></pre> <p>Alternatively, you can delete the resource groups in Azure Portal or using the CLI:</p> <pre><code>az group delete --name &lt;resource group name&gt;\n</code></pre> <p>Finally, delete the app registrations in Azure Portal or using the CLI:</p> <pre><code>az ad app delete --id &lt;application client ID&gt;\n</code></pre>"},{"location":"tre-admins/identities/api/","title":"The API Identity","text":""},{"location":"tre-admins/identities/api/#name","title":"Name","text":"<p>The API Identity is typically called <code>&lt;TRE_ID&gt; API</code> within the AAD Portal.</p>"},{"location":"tre-admins/identities/api/#purpose","title":"Purpose","text":"<p>This identity's credentials are stored in the <code>core</code> Key Vault and mandatory for the running of the Trusted Research Environment (TRE). It is required for the API Application, hosted in Azure App Service, to authenticate to Azure Active Directory and authorize the various operations.</p>"},{"location":"tre-admins/identities/api/#application-roles","title":"Application Roles","text":"Display name Description Allowed member types Value TRE Administrators Provides resource administrator access to the TRE. Users/Groups,Applications <code>TREAdmin</code> TRE Users Provides access to the TRE application. Users/Groups,Applications <code>TREUser</code>"},{"location":"tre-admins/identities/api/#microsoft-graph-permissions","title":"Microsoft Graph Permissions","text":"Name Type* Admin consent required TRE usage Directory.Read.All Application Yes Allows the app to read directory objects (roles/permissions) in your organization's directory, such as roles and permissions, without a signed-in user. User.Read.All Application Yes Allows the app to read user profiles without a signed in user to check that the user has permissions to execute an action e.g., to view workspaces. See <code>/api_app/services/aad_authentication.py</code>. email Delegated No Used to read the user's email address when creating TRE resources openid Delegated No Allows users to sign in to the app with their work or school accounts and allows the app to see basic user profile information. profile Delegated No Used to read the user's profile when creating TRE resources <p>'*' See the difference between delegated and application permission types. See Microsoft Graph permissions reference for more details.</p>"},{"location":"tre-admins/identities/api/#clients","title":"Clients","text":"<p>This identity should only be used by the API Application.</p>"},{"location":"tre-admins/identities/api/#how-to-create","title":"How to create","text":"<p>Example on how to run the script:</p> <p><pre><code>./devops/scripts/aad/create_api_application.sh \\\n--name &lt;TRE_ID&gt; \\\n--tre-url \"https://&lt;TRE_ID&gt;.&lt;LOCATION&gt;.cloudapp.azure.com\" \\\n--admin-consent \\\n--automation-clientid &lt;TEST_ACCOUNT_CLIENT_ID&gt;\n</code></pre> Below is a sample where <code>TRE_ID</code> has value <code>mytre</code>:</p> <pre><code>./devops/scripts/aad/create_api_application.sh --name mytre --admin-consent \\\n--tre-url \"https://mytre_6.westeurope.cloudapp.azure.com\" --automation-clientid 176c2f5d-xxxx-xxxx-xxxx-68a5c30f354d\n</code></pre> Argument Description <code>--name</code> The prefix of the name of the app registrations. <code>TRE</code> will give you <code>TRE API</code>. <code>--tre-url</code> Used to construct auth redirection URLs for the UI and Swagger app. Use the values of the environment variables <code>TRE_ID</code> and <code>LOCATION</code> in the URL. Reply URL for the localhost, <code>http://localhost:8000/api/docs/oauth2-redirect</code>, will be added by default. <code>--admin-consent</code> Grants admin consent for the app registrations. This is required for them to function properly, but requires AAD admin privileges. <code>--automation-clientid</code> This is an optional parameter but will grant TREAdmin permission to the Service Principal of the Automation Admin. <code>--reset-password</code> Optional, default is 0. When run in a headless fashion, 1 is passed in to always reset the password. <p>Caution</p> <p>The script will create an app password (client secret) for the TRE API app and the Automation App and write them to <code>/devops/auth.env</code> file. These values are only shown once, if you lose them, the script will create new secrets if run again.</p> <p>You can create an automation account which will aid your development flow, if you don't want to do this you can omit the <code>--automation-clientid</code> switch.</p> <p>You can run the script without the <code>--admin-consent</code> and ask your admin to grant consent. If you don't have permissions and just want to create a development environment then skip this step and see the steps in the \"Using a separate Azure Active Directory tenant) below.</p>"},{"location":"tre-admins/identities/api/#environment-variables","title":"Environment Variables","text":"Variable Description Location API_CLIENT_ID The Client Id <code>./devops/auth.env</code> API_CLIENT_SECRET The client secret <code>./devops/auth.env</code>"},{"location":"tre-admins/identities/api/#comments","title":"Comments","text":"<p>The TRE API app registration requires no redirect URLs defined. From a security standpoint, public client flows should not be allowed. As the identity of the client application cannot be verified (see the image below taken from app registration authentication blade in Azure Portal).</p> <p></p>"},{"location":"tre-admins/identities/application_admin/","title":"The Application Administrator Identity","text":""},{"location":"tre-admins/identities/application_admin/#purpose","title":"Purpose","text":"<p>This identity's credentials are stored in the core key vault and are used when you wish to update AAD Applications. For instance, when you add Guacamole as a Workspace Service, you would need to add the URI of the Guacamole Service as a Redirect URI to the Workspace App to complete the login flow.</p>"},{"location":"tre-admins/identities/application_admin/#application-roles","title":"Application Roles","text":"<p>This application does not have any roles defined.</p>"},{"location":"tre-admins/identities/application_admin/#microsoft-graph-permissions","title":"Microsoft Graph Permissions","text":"Name Type* Admin consent required TRE usage Application.ReadWrite.OwnedBy Application Yes This user has <code>Application.ReadWrite.OwnedBy</code> as a minimum permission for it to function. If the tenant is managed by a customer administrator, then this user must be added to the Owners of every workspace that is created. This will allow TRE to manage the AAD Application. This will be a manual process for the Tenant Admin. Application.ReadWrite.All Application Yes This permission is required to create workspace applications and administer any applications in the tenant. This is needed if the AAD Administrator has delegated AAD administrative operations to the TRE. There will be no need for the Tenant Admin to manually create workspace applications in the Tenant. Directory.Read.All Application Yes This permission is required to read User details from Azure Active Directory. This is needed if the AAD Administrator has delegated AAD administrative operations to the TRE. Group.ReadWrite.All Application Yes This permission is required to create and update Azure AD groups. This is requried if Azure AD groups are to be created automatically by the TRE. <p>'*' See the difference between delegated and application permission types. See Microsoft Graph permissions reference for more details.</p>"},{"location":"tre-admins/identities/application_admin/#clients","title":"Clients","text":"<p>This user is currently only used from the Porter bundles hosted on the Resource Processor Virtual Machine Scale Set.</p>"},{"location":"tre-admins/identities/application_admin/#how-to-create","title":"How to create","text":"<p><pre><code>./scripts/aad/create_application_administrator.sh \\\n--name \"${TRE_ID}\" --admin-consent --application-permission \"${APPLICATION_PERMISSION}\"\n</code></pre> | Argument | Description | | -------- | ----------- | | <code>--name</code> | This is used to put a friendly name to the Application that can be seen in the portal. It is typical to use the name of your TRE instance. | | <code>--admin-consent</code> | If you have the appropriate permission to grant admin consent, then pass in this argument. If you do not, you will have to ask an AAD Admin to consent after you have created the identity. Consent is required for this permission. | <code>--application-permission</code> | This  is a comma seperated list of the permissions that need to be assigned. For exampler <code>Application.ReadWrite.All,Directory.Read.All,Group.ReadWrite.All</code> | | <code>--reset-password</code> | Optional, default is 0. When run in a headless fashion, 1 is passed in to always reset the password. |</p>"},{"location":"tre-admins/identities/application_admin/#environment-variables","title":"Environment Variables","text":"Variable Description Location APPLICATION_ADMIN_CLIENT_ID The Client Id <code>./devops/auth.env</code> APPLICATION_ADMIN_CLIENT_SECRET The client secret <code>./devops/auth.env</code>"},{"location":"tre-admins/identities/auth-manual/","title":"Manually creating AAD identities","text":"<p>This guide is here if you wanted to create these Application Registrations manually.</p> <p>These should be created in order (if applicable) as some applications are then granted permission to other applications.</p>"},{"location":"tre-admins/identities/auth-manual/#manual-creation-guides","title":"Manual Creation Guides","text":"Application Comments Application Admin This is required TRE API This is required UI Client This is created when you create the TRE API. Automation Account This is optional Workspace You need one of these per Workspace if you wish to have different users in each workspace."},{"location":"tre-admins/identities/client/","title":"TRE Client UX","text":""},{"location":"tre-admins/identities/client/#name","title":"Name","text":"<p>The Client Identity is typically called <code>&lt;TRE_ID&gt; UX</code> within the AAD Portal.</p>"},{"location":"tre-admins/identities/client/#purpose","title":"Purpose","text":"<p>This identity is used by any public facing client application so that user impersonation can occur to the Core API and any Workspace Applications.</p>"},{"location":"tre-admins/identities/client/#application-roles","title":"Application Roles","text":"<p>This application does not have any roles defined.</p>"},{"location":"tre-admins/identities/client/#permissions","title":"Permissions","text":"Name Type* Admin consent required TRE usage offline_access Delegated No Allows the app to see and update the data you gave it access to, even when users are not currently using the app. openid Delegated No Allows users to sign in to the app with their work or school accounts and allows the app to see basic user profile information. TRE API/user_impersonation Delegated No Flow the authenticated user to the TRE API when needed. Workspace API/user_impersonation Delegated No Flow the authenticated user to the Workspace API when needed. <p>'*' See the difference between delegated and application permission types. See Microsoft Graph permissions reference for more details.</p>"},{"location":"tre-admins/identities/client/#clients","title":"Clients","text":"<p>This identity should only be used by client applications. Currently this is the React UI and the Swagger UI.</p>"},{"location":"tre-admins/identities/client/#how-to-create","title":"How to create","text":"<p>This identity is created when you create the API. For completeness, you can run the following script Example on how to run the script:</p> <pre><code>./devops/scripts/aad/create_api_application.sh \\\n--name &lt;TRE_ID&gt; \\\n--tre-url \"https://&lt;TRE_ID&gt;.&lt;LOCATION&gt;.cloudapp.azure.com\" \\\n--admin-consent \\\n--automation-clientid &lt;TEST_ACCOUNT_CLIENT_ID&gt;\n</code></pre> Argument Description <code>--name</code> The prefix of the name of the app registrations. <code>TRE</code> will give you <code>TRE API</code>. <code>--tre-url</code> Used to construct auth redirection URLs for the UI and Swagger app. Use the values of the environment variables <code>TRE_ID</code> and <code>LOCATION</code> in the URL. Reply URL for the localhost, <code>http://localhost:8000/api/docs/oauth2-redirect</code>, will be added by default. <code>--admin-consent</code> Grants admin consent for the app registrations. This is required for them to function properly, but requires AAD admin privileges. <code>--automation-clientid</code> This is an optional parameter but will create an application with test users with permission to use the <code>TRE API</code> and <code>TRE Swagger UI</code> <code>--reset-password</code> Optional, default is 0. This flag has no relevance when creating the UX as there is no password for the AAD Application."},{"location":"tre-admins/identities/client/#redirect-urls","title":"Redirect URLs","text":"<p>The following Redirect URIs will be added to the application * <code>https://&lt;TRE ID&gt;.&lt;Azure location&gt;.cloudapp.azure.com</code> * <code>http://localhost:8000/docs/oauth2-redirect</code> - For local testing</p>"},{"location":"tre-admins/identities/client/#environment-variables","title":"Environment Variables","text":"Variable Description Location SWAGGER_UI_CLIENT_ID The Client Id <code>./devops/auth.env</code>"},{"location":"tre-admins/identities/test-account/","title":"TRE Automation Admin Application","text":""},{"location":"tre-admins/identities/test-account/#name","title":"Name","text":"<p>The Automation Application is typically called <code>&lt;TRE_ID&gt; Automation Admin</code> within the AAD Portal.</p>"},{"location":"tre-admins/identities/test-account/#purpose","title":"Purpose","text":"<p>This application is used to authorize end-to-end test scenarios.</p> <p>Note</p> <ul> <li>This app registration is only needed and used for testing</li> </ul>"},{"location":"tre-admins/identities/test-account/#application-roles","title":"Application Roles","text":"<p>This application does not have any roles defined.</p>"},{"location":"tre-admins/identities/test-account/#permissions","title":"Permissions","text":"Name Type* Admin consent required TRE usage TRE API / TREAdmin Application Yes This allows this application to authenticate as a TRE Admin for running the tests locally and the E2E in the build. TRE API / user_impersonation Delegated No This allows the application to impersonate the logged in user. TRE - workspace x API / WorkspaceOwner Application Yes This allows this application to authenticate as a Workspace Owner for running the tests locally and the E2E in the build. TRE - workspace x  API / user_impersonation Delegated No This allows the application to impersonate the logged in user. <p>'*' See the difference between delegated and application permission types. See Microsoft Graph permissions reference for more details.</p>"},{"location":"tre-admins/identities/test-account/#clients","title":"Clients","text":"<p>This application is used locally to automatically register bundles against the API and is the user that runs the E2E locally and in the Build.</p>"},{"location":"tre-admins/identities/test-account/#environment-variables","title":"Environment Variables","text":"Variable Description Location TEST_ACCOUNT_CLIENT_ID The Client Id <code>./devops/auth.env</code> TEST_ACCOUNT_CLIENT_SECRET The client secret <code>./devops/auth.env</code>"},{"location":"tre-admins/identities/test-account/#how-to-create","title":"How to create","text":"<p>Example on how to run the script:</p> <pre><code>./devops/scripts/aad/create_automation_administrator.sh \\\n--name \"${TRE_ID}\"\n</code></pre> Argument Description <code>--name</code> The prefix of the name of the app registrations. <code>TRE123</code> will give you <code>TRE123 Automation Admin</code>. <code>--reset-password</code> Optional, default is 0. When run in a headless fashion, 1 is passed in to always reset the password."},{"location":"tre-admins/identities/test-account/#create-this-application-from-the-portal-optional","title":"Create this application from the portal (optional)","text":"<p>To create an application registration for automation, open the Azure Active Directory tenant for your TRE in the portal and navigate to \"App Registrations\". Click \"New registration\" as shown in the image below.</p> <p></p> <p>Enter a name for the application registration and click \"Register\".</p> <p></p> <p>On the app registration \"Overview\" page, copy the \"Application (client) ID\" value and save it for later.</p> <p></p> <p>Under \"Manage\", click on \"Certificates &amp; secrets\" and then \"New client secret\"</p> <p></p> <p>Add a description and create the client secret. Once done, the secret value will be displayed (as shown below). Copy this value and save it for later as you cannot retrieve it again after closing this page.</p> <p></p>"},{"location":"tre-admins/identities/test-account/#add-api-permissions","title":"Add API Permissions","text":"<p>After creating the automation application registration, it needs to be granted permissions to access the TRE API. Navigate to the API permissions page for the application registration and click \"Add a permission\"</p> <p></p> <p>Next, click on the \"My APIs\" tab, and then on \"TRE API\" On the \"Delegated permissions\" section, select \"user_impersonation\".</p> <p></p> <p>On the \"Application permissions\" section, select \"TRE Administrators\".</p> <p></p> <p>Back on the main permissions page, click on \"Grant admin consent\". Once done, you should see \"Granted\" in the \"Status\" column, as shown below.</p> <p></p>"},{"location":"tre-admins/identities/test-account/#enabling-users","title":"Enabling users","text":"<p>For a user to gain access to the system, they have to:</p> <ol> <li>Have an identity in Azure AD</li> <li>Be linked with an app registration and assigned a role</li> </ol> <p>When these requirements are met, the user can sign-in using their credentials and use their privileges to use the API, login to workspace environment etc. based on their specific roles.</p> <p></p> <p>The users can also be linked via the Enterprise application view:</p> <p></p>"},{"location":"tre-admins/identities/workspace/","title":"Workspace Applications","text":""},{"location":"tre-admins/identities/workspace/#purpose","title":"Purpose","text":"<p>Access to workspaces is also controlled using app registrations - one per workspace. The configuration of the app registration depends on the nature of the workspace, but this section covers the typical minimum settings.</p>"},{"location":"tre-admins/identities/workspace/#application-roles","title":"Application Roles","text":"Display name Description Allowed member types Value Workspace Owner Provides workspace owners access to the Workspace. Users/Groups,Applications <code>WorkspaceOwner</code> Workspace Researcher Provides researchers access to the Workspace. Users/Groups,Applications <code>WorkspaceResearcher</code> Airlock Manager Provides airlock managers access to the Workspace and ability to review airlock requests. Users/Groups,Applications <code>AirlockManager</code>"},{"location":"tre-admins/identities/workspace/#microsoft-graph-permissions","title":"Microsoft Graph Permissions","text":"Name Type* Admin consent required TRE usage email Delegated No Used to read the user's email address when creating TRE resources openid Delegated No Allows users to sign in to the app with their work or school accounts and allows the app to see basic user profile information. profile Delegated No Used to read the user's profile when creating TRE resources <p>'*' See the difference between delegated and application permission types. See Microsoft Graph permissions reference for more details.</p>"},{"location":"tre-admins/identities/workspace/#clients","title":"Clients","text":"<p>This identity should only be used by the API Application.</p>"},{"location":"tre-admins/identities/workspace/#how-to-create","title":"How to create","text":"<p>There are two mechanisms for creating Workspace Applications - Manually by your AAD Tenant Admin (default) - Automatically by TRE. Please see this guide if you wish this to be automatic.</p> <p>Caution</p> <p>By default, the app registration for a workspace is not created by the API. One needs to be present before using the API to provision a new workspace. If you ran <code>make auth</code>, a workspace AD application was created for you. If you wish to create another, the same script can be used to create the Workspace Application.</p> <p>Example on how to run the script:</p> <pre><code>  ./devops/scripts/aad/create_workspace_application.sh \\\n--name \"${TRE_ID} - workspace 11\" \\\n--admin-consent \\\n--ux-clientid \"${SWAGGER_UI_CLIENT_ID}\" \\\n--automation-clientid \"${TEST_ACCOUNT_CLIENT_ID}\" \\\n--application-admin-clientid \"${APPLICATION_ADMIN_CLIENT_ID}\"\n</code></pre> Argument Description <code>--name</code> The name of the application. This will be suffixed with 'API' by the script. <code>--ux-clientid</code> This value is one of the outputs when you first ran the script. It is mandatory if you use admin-consent. <code>--admin-consent</code> Grants admin consent for the app registrations. This is required for them to function properly, but requires AAD admin privileges. <code>--automation-clientid</code> This is an optional parameter but will grant the Automation App (created in step 1) permission to the new workspace app. <code>--application-admin-clientid</code> This is a required parameter , and should be a client id that will be added to the Owners of the AAD Application so that it can be administered within TRE. <code>--reset-password</code> Optional, default is 0. When run in a headless fashion, 1 is passed in to always reset the password. <p>Caution</p> <p>The script will create an app password (client secret) for the workspace and write to <code>/devops/auth.env</code>. These values are only shown once, if you lose them, the script will create new secrets if run again.</p> <p>If you do not wish to grant the Automation App permission to your workspace, just remove the <code>--automation-clientid</code> from the command.</p>"},{"location":"tre-admins/identities/workspace/#environment-variables","title":"Environment Variables","text":"Variable Description Location WORKSPACE_API_CLIENT_ID The Client Id <code>./devops/auth.env</code> WORKSPACE_API_CLIENT_SECRET The client secret <code>./devops/auth.env</code>"},{"location":"tre-admins/identities/workspace/#comments","title":"Comments","text":"<p>When the Workspace AAD app is registered by running <code>make auth</code>, the <code>Workspace Scope Id</code> is the same as the Client Id. When the Workspace AAD app is created by the base workspace, the <code>Workspace Scope Id</code> will be in this format <code>api://&lt;TRE_ID&gt;_ws_&lt;WORKSPACE_SHORT_IDENTIFIER&gt;</code></p>"},{"location":"tre-admins/setup-instructions/","title":"Getting Started","text":"<p>This section provide the guidelines for any engineer to deploy AzureTRE. This how-to will enable one to get familiar with a TRE deployment and its conceps.</p> <ol> <li> <p>Prerequisites</p> </li> <li> <p>AD Tenant</p> </li> <li> <p>Pre-deployment Steps</p> </li> <li> <p>Deploying Azure TRE</p> </li> <li> <p>Configuring Shared Services</p> </li> <li> <p>Installing Base Workspace</p> </li> <li> <p>Installing Workspace Service and User Resource</p> </li> </ol> <p>Tip</p> <p>For troubleshooting purpose make sure to check the Troubleshooting FAQ.</p>"},{"location":"tre-admins/setup-instructions/ad-tenant-choices/","title":"Azure Active Directory Tenant Choices","text":""},{"location":"tre-admins/setup-instructions/ad-tenant-choices/#dedicated-tenant-for-tre","title":"Dedicated Tenant for TRE","text":"<p>We recommend that you have a dedicated Tenant for your TRE rather than using your corporate tenant. This is because TRE is able to automate some of the AD Tenant Admin tasks for you. In order to do this, there is an Admin User that has the ability to create AD Applications. This would not be normal for a Corporate Tenant.</p> <p>Users from your corporate tenant can be guested into this new TRE tenant.</p> <p></p>"},{"location":"tre-admins/setup-instructions/ad-tenant-choices/#corporate-tenant","title":"Corporate Tenant","text":"<p>It is possible to use your corporate tenant for TRE. This does have the advantage of only managing a single tenant, but your AAD Tenant Admin must be aware of what TRE brings to your organisation and must be prepared to carry out some admin tasks, like creating an AAD Application everytime a new Workspace is created.</p> <p></p>"},{"location":"tre-admins/setup-instructions/ad-tenant-choices/#next-steps","title":"Next steps","text":"<ul> <li>Pre-deployment steps</li> </ul>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/","title":"Configuring Shared Services","text":"<p>In general, a shared service should be installed by using the UI or API directly once its bundle has been registered on the system.</p>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#deploy-configure-v2-nexus-service-hosted-on-vm","title":"Deploy &amp; configure V2 Nexus service (hosted on VM)","text":"<p>Caution</p> <p>Before deploying the V2 Nexus service, you will need workspaces of version <code>0.3.2</code> or above due to a dependency on a DNS zone link for the workspace(s) to connect to the Nexus VM.</p> <p>Before deploying the Nexus shared service, you need to make sure that it will have access to a certificate to configure serving secure proxies. By default, the Nexus service will serve proxies from <code>https://nexus-{TRE_ID}.{LOCATION}.cloudapp.azure.com/</code>, and thus it requires a certificate that validates ownership of this domain to use for SSL.</p> <p>You can use the Certs Shared Service to set one up by following these steps:</p> <ol> <li> <p>Run the below commands in your terminal to build, publish and register the certs bundle:</p> <pre><code>make bundle-build DIR=./templates/shared_services/certs\nmake bundle-publish DIR=./templates/shared_services/certs\nmake bundle-register DIR=./templates/shared_services/certs BUNDLE_TYPE=shared_service\n</code></pre> </li> <li> <p>Navigate to the Swagger UI for your TRE API at <code>https://&lt;azure_tre_fqdn&gt;/api/docs</code>, and authenticate if you haven't already by clicking <code>Authorize</code>.</p> </li> <li> <p>Click <code>Try it out</code> on the <code>POST</code> <code>/api/shared-services</code> operation, and paste the following to deploy the certs service:</p> <pre><code>{\n\"templateName\": \"tre-shared-service-certs\",\n\"properties\": {\n\"display_name\": \"Nexus cert\",\n\"description\": \"Generate/renew ssl cert for Nexus shared service\",\n\"domain_prefix\": \"nexus\",\n\"cert_name\": \"nexus-ssl\"\n}\n}\n</code></pre> </li> </ol> <p>Caution</p> <p>If you have KeyVault Purge Protection enabled and are re-deploying your environment using the same <code>cert_name</code>, you may encounter this: <code>Status=409 Code=\\\"Conflict\\\" Message=\\\"Certificate nexus-ssl is currently in a deleted but recoverable state</code>. You need to either manually recover the certificate or purge it before redeploying.</p> <p>Once deployed, the certs service will use Letsencrypt to generate a certificate for the specified domain prefix followed by <code>-{TRE_ID}.{LOCATION}.cloudapp.azure.com</code>, so in our case, having entered <code>nexus</code>, this will be <code>nexus-{TRE_ID}.{LOCATION}.cloudapp.azure.com</code>, which will be the public domain for our Nexus service.</p> <p>You can verify whether this has been successful by navigating to your core keyvault (<code>kv-{TRE_ID}</code>) and looking for a certificate called <code>nexus-ssl</code> (or whatever you called it).</p> <p>After verifying the certificate has been generated, you can deploy Nexus:</p> <ol> <li> <p>Run the below commands in your terminal to build, publish and register the Nexus shared service bundle:</p> <pre><code>make bundle-build DIR=./templates/shared_services/sonatype-nexus-vm\nmake bundle-publish DIR=./templates/shared_services/sonatype-nexus-vm\nmake bundle-register DIR=./templates/shared_services/sonatype-nexus-vm BUNDLE_TYPE=shared_service\n</code></pre> </li> <li> <p>Navigate to the Swagger UI for your TRE API at <code>https://&lt;azure_tre_fqdn&gt;/api/docs</code>, and authenticate if you haven't already by clicking <code>Authorize</code>.</p> </li> <li> <p>Click <code>Try it out</code> on the <code>POST</code> <code>/api/shared-services</code> operation, and paste the following to deploy the Nexus shared service:</p> <pre><code>{\n\"templateName\": \"tre-shared-service-sonatype-nexus\",\n\"properties\": {\n\"display_name\": \"Nexus\",\n\"description\": \"Proxy public repositories with Nexus\",\n\"ssl_cert_name\": \"nexus-ssl\"\n}\n}\n</code></pre> </li> </ol> <p>Tip</p> <p>If you called your cert something different in the certs shared service step, make sure that is reflected above.</p> <p>This will deploy the infrastructure required for Nexus, then start the service and configure it with the repository configurations located in the <code>./templates/shared_services/sonatype-nexus-vm/scripts/nexus_repos_config</code> folder. It will also set up HTTPS using the certificate you generated in the previous section, so proxies can be served at <code>https://nexus-{TRE_ID}.{LOCATION}.cloudapp.azure.com</code>.</p> <p>You can optionally go to the Nexus web interface by visiting <code>https://nexus-{TRE_ID}.{LOCATION}.cloudapp.azure.com/</code> in the jumpbox and signing in with the username <code>admin</code> and the password secret located in your core keyvault, with the key <code>nexus-admin-password</code>. Here you should be able to see all of the configured repositories and you can use the UI to manage settings etc.</p> <p>Just bear in mind that if this service is redeployed any changes made in the Nexus UI won't be persisted. If you wish to permanently add new repositories or alter existing ones, modify the JSON files within the <code>./nexus_repos_config</code> directory and redeploy.</p>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#migrate-from-an-existing-v1-nexus-service-hosted-on-app-service","title":"Migrate from an existing V1 Nexus service (hosted on App Service)","text":"<p>Once you've created the new V2 (VM-based) Nexus service by following the previous section, you can migrate from the V1 Nexus service by following these steps:</p> <ol> <li> <p>Identify any existing Guacamole user resources that are using the old proxy URL (<code>https://nexus-{TRE_ID}.azurewebsites.net/</code>). These will be any VMs with bundle versions &lt; <code>0.3.2</code>.</p> </li> <li> <p>These will need to be either re-deployed with the new template versions <code>0.3.2</code> or later and specifying an additional template parameter <code>\"nexus_version\"</code> with the value of <code>\"V2\"</code>, or manually have their proxy URLs updated by remoting into the VMs and updating the various configuration files of required package managers with the new URL (<code>https://nexus-{TRE_ID}.{LOCATION}.cloudapp.azure.com/</code>).</p> <ol> <li>For example, pip will need the <code>index</code>, <code>index-url</code> and <code>trusted-host</code> values in the global <code>pip.conf</code> file to be modified to use the new URL.</li> </ol> </li> <li> <p>Once you've confirmed there are no dependencies on the old Nexus shared service, you can delete it using the API.</p> </li> </ol>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#upgrade-notes","title":"Upgrade notes","text":"<p>The new V2 Nexus shared service can be located in the <code>./templates/shared_services/sonatype-nexus-vm</code> directory, with the bundle name <code>tre-shared-service-sonatype-nexus</code>, which is now hosted using a VM to enable additional configuration required for proxying certain repositories.</p> <p>This has been created as a separate service as the domain name exposed for proxies will be different to the one used by the original Nexus service and thus will break any user resources configured with the old proxy URL.</p> <p>The original Nexus service that runs on App Service (located in <code>./templates/shared_services/sonatype-nexus</code>) has the bundle name <code>tre-shared-service-nexus</code> so can co-exist with the new VM-based shared service to enable smoother upgrading of existing resources.</p>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#renewing-certificates-for-nexus","title":"Renewing certificates for Nexus","text":"<p>The Nexus V2 service checks Keyvault regularly for the latest certificate matching the name you passed on deploy (<code>nexus-ssl</code> by default).</p> <p>When approaching expiry, you can either provide an updated certificate if you brought your own, or if you used the certs shared service to generate one, just call the <code>renew</code> custom action on that service. This will generate a new certificate and persist it to the Keyvault.</p>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#configure-gitea-repositories","title":"Configure Gitea repositories","text":"<p>Note : This is a Gitea shared service which will be accessible from all workspaces intended for mirroring external Git repositories. A Gitea workspace service can also be deployed per workspace to enable Gitea to be used within a specific workspace.</p> <p>By default, this Gitea instance does not have any repositories configured. You can add repositories to Gitea either by using the command line or by using the Gitea web interface.</p>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#command-line","title":"Command Line","text":"<p>Make sure you run the following commands using git bash and set your current directory as C:/AzureTRE.</p> <ol> <li>On the jumbox, run: <code>./templates/workspace_services/gitea/gitea_migrate_repo.sh -t &lt;tre_id&gt; -g &lt;URL_of_github_repo_to_migrate&gt;</code></li> <li>If you have issues with token or token doesn't work, you can reset the token by setting it's value to null in Key Vault: <code>az keyvault secret set --name gitea-&lt;tre-id&gt;-admin-token --vault-name kv-&lt;tre-id&gt; --value null</code></li> </ol>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#gitea-web-interface","title":"Gitea Web Interface","text":"<ol> <li>on the jumbox, open Edge and go to: <code>https://gitea-&lt;TRE_ID&gt;.azurewebsites.net/</code></li> <li>Authenticate yourself using username <code>giteaadmin</code> and the secret <code>&lt;gitea-TRE_ID-administrator-password&gt;</code> stored in the keyvault,</li> <li>Add the repository of your choice</li> </ol>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#verify-can-access-the-mirrored-repository","title":"Verify can access the mirrored repository","text":"<p>From a virtual machine within a workspace: - Command line: <code>git clone https://gitea-&lt;TRE_ID&gt;.azurewebsites.net/giteaadmin/&lt;NameOfrepository&gt;</code> - Gitea Web Interface: <code>https://gitea-&lt;TRE_ID&gt;.azurewebsites.net/</code></p>"},{"location":"tre-admins/setup-instructions/configuring-shared-services/#next-steps","title":"Next steps","text":"<ul> <li>Install Base Workspace</li> </ul>"},{"location":"tre-admins/setup-instructions/deploying-azure-tre/","title":"Deploying Azure TRE","text":"<p>You are now ready to deploy the Azure TRE instance. Execute the <code>all</code> action of the makefile using <code>make</code>:</p> <pre><code>make all\n</code></pre> <p>Deploying a new Azure TRE instance takes approximately 30 minutes.</p> <p>Once the deployment is completed, you will be presented with a few output variables similar to the ones below:</p> <pre><code>app_gateway_name = \"agw-mytre\"\nazure_tre_fqdn = \"mytre.westeurope.cloudapp.azure.com\"\ncore_resource_group_name = \"rg-mytre\"\nkeyvault_name = \"kv-mytre\"\nlog_analytics_name = \"log-mytre\"\nstatic_web_storage = \"stwebmytre\"\n</code></pre> <p>The Azure TRE instance is initially deployed with an invalid self-signed SSL certificate. This certificate needs to be replaced with one valid for your configured domain name. To use a certificate from Let's Encrypt, run the command:</p> <pre><code>make letsencrypt\n</code></pre> <p>Caution</p> <p>There are rate limits with Let's Encrypt, so this should not be run when not needed.</p> <p>Info</p> <p>If you're using Codespaces, you'll encounter a bug when trying to run <code>make letsencrypt</code> where the incorrect IP will be whitelisted on the storage account and Codespaces won't be able to upload the test file due to a 403 error. The workaround until this is fixed is to temporarily disable the firewall on your <code>stweb{TRE_ID}</code> storage account before running the script, then re-enable afterwards.</p>"},{"location":"tre-admins/setup-instructions/deploying-azure-tre/#validate-the-deployment","title":"Validate the deployment","text":""},{"location":"tre-admins/setup-instructions/deploying-azure-tre/#using-curl","title":"Using curl","text":"<p>Use <code>curl</code> to make a simple request to the health endpoint of the API:</p> <pre><code>curl https://&lt;azure_tre_fqdn&gt;/api/health\n</code></pre> <p>The expected response is:</p> <pre><code>{\n\"services\": [\n{\n\"service\": \"Cosmos DB\",\n\"status\": \"OK\",\n\"message\": \"\"\n},\n{\n\"service\": \"Service Bus\",\n\"status\": \"OK\",\n\"message\": \"\"\n},\n{\n\"service\": \"Resource Processor\",\n\"status\": \"OK\",\n\"message\": \"\"\n}\n]\n}\n</code></pre>"},{"location":"tre-admins/setup-instructions/deploying-azure-tre/#using-the-api-docs","title":"Using the API docs","text":"<p>Open your browser and navigate to the <code>/api/docs</code> route of the API:  <code>https://&lt;azure_tre_fqdn&gt;/api/docs</code> and click <code>Try it out</code> on the operation of choice.</p> <p></p>"},{"location":"tre-admins/setup-instructions/deploying-azure-tre/#next-steps","title":"Next steps","text":"<ul> <li>Configure Shared Services</li> <li>Enable users to access the Azure TRE instance</li> </ul>"},{"location":"tre-admins/setup-instructions/installing-base-workspace/","title":"Installing base workspace","text":""},{"location":"tre-admins/setup-instructions/installing-base-workspace/#publishing-and-registering-the-base-workspace-bundle","title":"Publishing and registering the base workspace bundle","text":"<p>Run the following in a terminal: -</p> <pre><code>make bundle-publish DIR=./templates/workspaces/base\nmake bundle-register DIR=./templates/workspaces/base BUNDLE_TYPE=workspace\n</code></pre> <p>If you have setup the TEST_ACCOUNT_CLIENT_ID in the Pre-deployment steps, then your bundle will automatically publish and you can skip to 'Creating a base workspace'. Otherwise continue with these steps: -</p> <ol> <li> <p>Copy the resulting JSON payload.</p> </li> <li> <p>Navigate to the Swagger UI at <code>https://&lt;azure_tre_fqdn&gt;/api/docs</code></p> </li> <li> <p>Log into the Swagger UI by clicking <code>Authorize</code>, then <code>Authorize</code> again. You will be redirected to the login page.</p> </li> <li> <p>Once logged in, click <code>Try it out</code> on the <code>POST</code> <code>/api/workspace-templates</code> operation:</p> <p></p> </li> <li> <p>Paste the payload json generated earlier into the <code>Request body</code> field, then click <code>Execute</code>. Review the server response.</p> </li> <li> <p>To verify registration of the template do <code>GET</code> operation on <code>/api/workspace-templates</code>. The name of the template should now be listed.</p> </li> </ol>"},{"location":"tre-admins/setup-instructions/installing-base-workspace/#creating-a-base-workspace","title":"Creating a base workspace","text":"<p>Now that we have published and registered a base workspace bundle we can use the deployed API to create a base workspace.</p> <p>Info</p> <p>All routes are auth protected. Click the green Authorize button to receive a token for Swagger client.</p> <p>As explained in the auth guide, every workspace has a corresponding app registration which if you haven't run <code>make auth</code>; can be created using the helper script <code>./devops/scripts/aad/create_workspace_application.sh</code>. For example:</p> <pre><code>  ./devops/scripts/aad/create_workspace_application.sh \\\n--name \"${TRE_ID} - workspace 1\" \\\n--admin-consent \\\n--ux-clientid \"${SWAGGER_UI_CLIENT_ID}\" \\\n--automation-clientid \"${TEST_ACCOUNT_CLIENT_ID}\" \\\n--application-admin-clientid \"${APPLICATION_ADMIN_CLIENT_ID}\"\n</code></pre> <p>Caution</p> <p>If you're using a separate tenant for AAD app registrations to the one where you've deployed the TRE infrastructure resources, ensure you've signed into that tenant in the <code>az cli</code> before running the above command. See Using a separate Azure Active Directory tenant in Pre-deployment steps for more details.</p> <p>Running the script will report <code>WORKSPACE_API_CLIENT_ID</code> and <code>WORKSPACE_API_CLIENT_SECRET</code> for the generated app. Copy these into <code>/templates/core/.env</code> so that automated testing will work. You also need to use <code>WORKSPACE_API_CLIENT_ID</code> in the POST body below.</p> <p>Go to <code>https://&lt;azure_tre_fqdn&gt;/api/docs</code> and use POST <code>/api/workspaces</code> with the sample body to create a base workspace.</p> <pre><code>{\n\"templateName\": \"tre-workspace-base\",\n\"properties\": {\n\"display_name\": \"manual-from-swagger\",\n\"description\": \"workspace for team X\",\n\"client_id\":\"&lt;WORKSPACE_API_CLIENT_ID&gt;\",\n\"client_secret\":\"&lt;WORKSPACE_API_CLIENT_SECRET&gt;\",\n\"address_space_size\": \"medium\"\n}\n}\n</code></pre> <p>The API will return an <code>operation</code> object with a <code>Location</code> header to query the operation status, as well as the <code>resourceId</code> and <code>resourcePath</code> properties to query the resource under creation.</p> <p>You can also follow the progress in Azure portal as various resources come up.</p> <p>Workspace level operations can now be carried out using the workspace API, at <code>/api/workspaces/&lt;workspace_id&gt;/docs/</code>.</p>"},{"location":"tre-admins/setup-instructions/installing-base-workspace/#next-steps","title":"Next steps","text":"<ul> <li>Installing a workspace service &amp; user resources</li> </ul>"},{"location":"tre-admins/setup-instructions/installing-workspace-service-and-user-resource/","title":"Installing workspace service and user resource","text":""},{"location":"tre-admins/setup-instructions/installing-workspace-service-and-user-resource/#publish-and-register-a-workspace-service-template","title":"Publish and register a workspace service template","text":"<p>We will use the Guacamole workspace service bundle for the purposes of this tutorial. These steps can be repeated for any workspace service template.</p> <ol> <li> <p>Run:</p> <pre><code>make bundle-publish DIR=./templates/workspace_services/guacamole BUNDLE_TYPE=workspace_service\nmake bundle-register DIR=./templates/workspace_services/guacamole BUNDLE_TYPE=workspace_service\n</code></pre> <p>Copy the resulting JSON payload.</p> </li> <li> <p>Navigate to the Swagger UI at <code>https://&lt;azure_tre_fqdn&gt;/api/docs</code>.</p> </li> <li> <p>Log into the Swagger UI by clicking <code>Authorize</code>, then <code>Authorize</code> again. You will be redirected to the login page.</p> </li> <li> <p>Once logged in, click <code>Try it out</code> on the <code>POST</code> <code>/api/workspace-service-templates</code> operation.</p> </li> <li> <p>Paste the payload json generated earlier into the <code>Request body</code> field, then click <code>Execute</code>. Review the server response.</p> </li> <li> <p>To verify registration of the template do <code>GET</code> operation on <code>/api/workspace-service-templates</code>. The name of the template should now be listed.</p> </li> </ol>"},{"location":"tre-admins/setup-instructions/installing-workspace-service-and-user-resource/#publish-and-register-a-user-resource-template","title":"Publish and register a user resource template","text":"<p>The Guacamole workspace service also has user resources, there are the VMs that researchers will deploy. These steps can be repeated for any user resource template.</p> <ol> <li> <p>Run:</p> <pre><code>make bundle-publish DIR=./templates/workspace_services/guacamole/user_resources/guacamole-azure-windowsvm BUNDLE_TYPE=user_resource\nmake bundle-register DIR=./templates/workspace_services/guacamole/user_resources/guacamole-azure-windowsvm BUNDLE_TYPE=user_resource WORKSPACE_SERVICE_NAME=tre-service-guacamole\n</code></pre> <p>Copy the resulting JSON payload.</p> </li> <li> <p>Navigate to the Swagger UI at <code>https://&lt;azure_tre_fqdn&gt;/api/docs</code>.</p> </li> <li> <p>Log into the Swagger UI by clicking Authorize, then Authorize again. You will be redirected to the login page.</p> </li> <li> <p>Once logged in, click <code>Try it out</code> on the <code>POST</code> <code>/api/workspace-service-templates/&lt;service_template_name&gt;/user-resource-templates</code> operation.</p> </li> <li> <p>In the <code>service_template_name</code> field, paste the name of the workspace service template that you registered earlier - <code>tre-service-guacamole</code>.</p> </li> <li> <p>Paste the payload json generated earlier into the <code>Request body</code> field, then click <code>Execute</code>. Review the server response.</p> </li> <li> <p>To verify registration of the template do <code>GET</code> operation on <code>/api/workspace-service-templates/&lt;service_template_name&gt;/user-resource-templates</code>. The name of the template should now be listed.</p> </li> </ol>"},{"location":"tre-admins/setup-instructions/installing-workspace-service-and-user-resource/#creating-a-workspace-service","title":"Creating a workspace service","text":"<p>Now that we have published and registered both workspace service and user resource bundles we can use the workspace API to create a workspace service in our workspace.</p> <ol> <li>Navigate to the Swagger UI at <code>https://&lt;azure_tre_fqdn&gt;/api/workspaces/&lt;workspace_id&gt;/docs</code> . Where <code>&lt;workspace_id&gt;</code> is the workspace ID of the workspace created in the previous step.</li> </ol> <p>Info</p> <p>All routes are auth protected. Click the green Authorize button to receive a token for Swagger client.</p> <ol> <li>Log into the Swagger UI by clicking <code>Authorize</code>, then <code>Authorize</code> again. You will be redirected to the login page.</li> </ol> <p>Info</p> <p>You need to log in with a user with assigned the WorkspaceOwner role in the app regsitration used when deploying your workspace.</p> <ol> <li> <p>Once logged in, click <code>Try it out</code> on the <code>POST</code> <code>/api/workspaces/&lt;workspace_id&gt;/workspace-services</code> operation.</p> </li> <li> <p>Enter the workspace_id in the <code>workspace_id</code> field.</p> </li> <li> <p>Paste the following payload json into the <code>Request body</code> field. Then click <code>Execute</code>. Review the server response.</p> <pre><code>{\n\"templateName\": \"tre-service-guacamole\",\n\"properties\": {\n\"display_name\": \"Virtual Desktop\",\n\"description\": \"Create virtual desktops for running research workloads\",\n\"is_exposed_externally\": true,\n\"guac_disable_copy\": true,\n\"guac_disable_paste\": true\n}\n}\n</code></pre> </li> </ol> <p>The API will return an <code>operation</code> object with a <code>Location</code> header to query the operation status, as well as the <code>resourceId</code> and <code>resourcePath</code> properties to query the resource under creation. Record this ID for later use.</p> <p>You can also follow the progress in Azure portal as various resources come up.</p> <p>Info</p> <p>There is currently a bug where the redirect URI isn't automatically set up correctly in the Workspace API app registration. Until this is fixed, you need to head to the app registration in the Azure portal, click on Add a redirect URI &gt; Add a platform &gt; Web &gt; then paste in the Guacamole URI in the redirect URI box. You can find this in the Guacamole app service properties and append <code>/oauth2/callback</code> to the end - it should look like this: <code>https://guacamole-{TRE_ID}-ws-XXXX-svc-XXXX.azurewebsites.net/oauth2/callback/</code>). Finally, make sure you check the ID tokens checkbox and click Configure.</p>"},{"location":"tre-admins/setup-instructions/installing-workspace-service-and-user-resource/#creating-a-user-resource","title":"Creating a user resource","text":"<p>Once the workspace service has been created, we can use the workspace API to create a user resource in our workspace.</p> <p>Caution</p> <p>Before deploying Guacamole user resources, you will want to make sure you have a Nexus shared service deployed in the workspace so that your VMs can access package repositories through a proxy (as they can't access public repositories directly). See Configuring shared services.</p> <ol> <li> <p>Navigate to the Swagger UI at <code>https://&lt;azure_tre_fqdn&gt;/api/workspaces/&lt;workspace_id&gt;/docs</code> . Where <code>&lt;workspace_id&gt;</code> is the workspace ID of your workspace.</p> </li> <li> <p>Click <code>Try it out</code> on the <code>POST</code> <code>/api/workspaces/&lt;workspace_id&gt;/workspace-services/&lt;service_id&gt;/user_resources</code> operation. Where <code>&lt;workspace_id&gt;</code> and <code>&lt;service_id&gt;</code> are the workspace ID of your workspace and workspace service ID of your workspace service.</p> </li> <li> <p>Enter the workspace ID and workspace service id in the <code>workspace_id</code> and <code>service_id</code> fields.</p> </li> <li> <p>Paste the following payload json into the <code>Request body</code> field, then click <code>Execute</code>. Review the server response.</p> <pre><code>{\n\"templateName\": \"tre-service-guacamole-windowsvm\",\n\"properties\": {\n\"display_name\": \"My VM\",\n\"description\": \"Will be using this VM for my research\",\n\"os_image\": \"Server 2019 Data Science VM\",\n\"nexus_version\": \"V2\"\n}\n}\n</code></pre> <p>Note: You can also specify \"Windows 10\" in \"os_image\" for a standard Windows 10 image.</p> </li> </ol> <p>The API will return an <code>operation</code> object with a <code>Location</code> header to query the operation status, as well as the <code>resourceId</code> and <code>resourcePath</code> properties to query the resource under creation.</p> <p>You can also follow the progress in Azure portal as various resources come up. Once deployment has completed you can connect to the user resource using the <code>connection_uri</code> property returned by the API.</p>"},{"location":"tre-admins/setup-instructions/pre-deployment-steps/","title":"Pre-deployment steps","text":"<p>Info</p> <p>See Environment variables for full details of the deployment related variables.</p>"},{"location":"tre-admins/setup-instructions/pre-deployment-steps/#set-environment-configuration-variables-of-shared-management-resources","title":"Set environment configuration variables of shared management resources","text":"<ol> <li> <p>Open the <code>/devops/.env.sample</code> file and then save it without the .sample extension. You should now have a file called <code>.env</code> located in the <code>/devops</code> folder. The file contains configuration variables for the shared management infrastructure which is used to support the deployment of one or more Azure TRE instances.</p> </li> <li> <p>Provide the values for the following variables:</p> Variable Description <code>LOCATION</code> The Azure location (region) for all resources. E.g., <code>westeurope</code> <code>MGMT_RESOURCE_GROUP_NAME</code> The shared resource group for all management resources, including the storage account. <code>MGMT_STORAGE_ACCOUNT_NAME</code> The name of the storage account to hold the Terraform state and other deployment artifacts. <code>ACR_NAME</code> A globally unique name for the Azure Container Registry (ACR) that will be created to store deployment images. <code>ARM_SUBSCRIPTION_ID</code> The Azure subscription ID for all resources. <p>Tip</p> <p>To retrieve your Azure subscription ID, use the <code>az</code> command line interface available in the development container. In the terminal window in Visual Studio Code, type <code>az login</code> followed by <code>az account show</code> to see your default subscription. Please refer to <code>az account -help</code> for further details on how to change your active subscription.</p> </li> </ol> <p>The rest of the variables can have their default values. You should now have a <code>.env</code> file that looks similar to the one below:</p> <pre><code># Management infrastructure\nLOCATION=westeurope\nMGMT_RESOURCE_GROUP_NAME=aztremgmt\nMGMT_STORAGE_ACCOUNT_NAME=aztremgmt\nTERRAFORM_STATE_CONTAINER_NAME=tfstate\nACR_NAME=aztreacr\n\nARM_SUBSCRIPTION_ID=12...54e\n\n# If you want to override the currently signed in credentials\n# ARM_TENANT_ID=__CHANGE_ME__\n# ARM_CLIENT_ID=__CHANGE_ME__\n# ARM_CLIENT_SECRET=__CHANGE_ME__\n\n# Debug mode\nDEBUG=\"false\"\n</code></pre>"},{"location":"tre-admins/setup-instructions/pre-deployment-steps/#set-environment-configuration-variables-of-the-azure-tre-instance","title":"Set environment configuration variables of the Azure TRE instance","text":"<p>Next, you will set the configuration variables for the specific Azure TRE instance:</p> <ol> <li>Open the <code>/templates/core/.env.sample</code> file and then save it without the .sample extension. You should now have a file called <code>.env</code> located in the <code>/templates/core</code> folder.</li> <li>Decide on a name for your <code>TRE_ID</code>, which is an alphanumeric (with underscores and hyphens allowed) ID for the Azure TRE instance. The value will be used in various Azure resources, and needs to be globally unique and less than 12 characters in length. Use only lowercase letters. Choose wisely!</li> <li>Once you have decided on which AD Tenant paradigm, then you should be able to set <code>AAD_TENANT_ID</code></li> <li>If you want to disable the built-in web UI (<code>./ui</code>) ensure you set <code>DEPLOY_UI=false</code> in the .env file.</li> <li> <p>Your AAD Tenant Admin can now use the terminal window in Visual Studio Code to execute the following script from within the development container to create all the AAD Applications that are used for TRE. The details of the script are covered in the auth document.</p> <pre><code>make auth\n</code></pre> <p>Note</p> <p>In case you have several subscriptions and would like to change your default subscription use <code>az account set --subscription &lt;desired subscription ID&gt;</code></p> <p>Note</p> <p>The full functionality of the script requires directory admin privileges. You may need to contact your friendly Azure Active Directory admin to complete this step. The app registrations can be created manually in Azure Portal too. For more information, see Authentication and authorization.</p> </li> </ol> <p>All other variables can have their default values for now.</p>"},{"location":"tre-admins/setup-instructions/pre-deployment-steps/#add-admin-user","title":"Add admin user","text":"<p>Make sure the TRE Administrators and TRE Users roles, defined by the API app registration, are assigned to your user and others as required. See Enabling users for instructions.</p>"},{"location":"tre-admins/setup-instructions/pre-deployment-steps/#next-steps","title":"Next steps","text":"<ul> <li>Deploying Azure TRE</li> </ul>"},{"location":"tre-admins/setup-instructions/prerequisites/","title":"Prerequisites","text":"<p>To deploy an Azure TRE instance, the following assets and tools are required:</p> <ul> <li>Azure subscription</li> <li>Azure Active Directory (AAD) tenant in which you can create application registrations</li> <li>Git client such as Git or GitHub Desktop</li> <li>Docker Desktop</li> </ul>"},{"location":"tre-admins/setup-instructions/prerequisites/#development-container","title":"Development container","text":"<p>The Azure TRE solution contains a development container with all the required tooling to develop and deploy the Azure TRE. To deploy an Azure TRE instance using the provided development container you will also need:</p> <ul> <li>Visual Studio Code</li> <li>Remote containers extension for Visual Studio Code</li> </ul> <p>The files for the dev container are located in <code>/.devcontainer/</code> folder.</p> <p>Tip</p> <p>An alternative of running the development container locally is to use GitHub Codespaces.</p>"},{"location":"tre-admins/setup-instructions/prerequisites/#clone-the-azure-tre-git-repository","title":"Clone the Azure TRE Git repository","text":"<p>Tip</p> <p>If using Windows please clone the repository to a Linux file system, i.e. to <code>/xxx</code> rather than <code>c:\\</code>, for example within Windows Subsytem for Linux. If you clone the repository to a Windows file system you will likely hit issues with file permissions as described in this issue: https://github.com/microsoft/AzureTRE/issues/1395</p> <pre><code>git clone https://github.com/microsoft/AzureTRE.git\n</code></pre> <p>The Git repository will host some basic configuration for the TRE instances that are deployed from a given repository. Create a new branch for the instance that you are about to deploy.</p> <pre><code>cd AzureTRE\ngit checkout -b quickstartenv\n</code></pre> <ol> <li> <p>Open the cloned repository in Visual Studio Code and connect to the development container.</p> <pre><code>code .\n</code></pre> </li> </ol> <p>Tip</p> <p>Visual Studio Code should recognize the available development container and ask you to open the folder using it. For additional details on connecting to remote containers, please see the Open an existing folder in a container quickstart.</p> <p>When you start the development container for the first time, the container will be built. This usually takes a few minutes.</p>"},{"location":"tre-admins/setup-instructions/prerequisites/#next-steps","title":"Next steps","text":"<ul> <li>AD Tenant Choices</li> </ul>"},{"location":"tre-admins/setup-instructions/workflows/","title":"GitHub Actions workflows (CI/CD)","text":"<p>To deploy the Azure TRE using GitHub workflows, create a fork of the repository.</p> <p>Deployment is done using the <code>/.github/workflows/deploy_tre.yml</code> workflow. This method is also used to deploy the dev/test environment for the original Azure TRE repository.</p>"},{"location":"tre-admins/setup-instructions/workflows/#setup-instructions","title":"Setup instructions","text":"<p>Before you can run the <code>deploy_tre.yml</code> workflow there are some one-time configuration steps that we need to do, similar to the Pre-deployment steps for manual deployment.</p> <p>Tip</p> <p>In some of the steps below, you are asked to configure repository secrets. Follow the GitHub guide on creating repository secrets if you are unfamiliar with this step.</p> <ol> <li>Create a service principal for the subscription so that the workflow can provision Azure resources.</li> <li>Decide on a TRE ID and the location for the Azure resources</li> <li>Create app registrations for API authentication</li> <li>Create app registrations and a user for the E2E tests</li> <li>Create a workspace app registration for setting up workspaces (for the E2E tests)</li> <li>Create a Teams WebHook for deployment notifications</li> <li>Configure repository secrets</li> <li>Deploy the TRE using the workflow</li> </ol>"},{"location":"tre-admins/setup-instructions/workflows/#create-a-service-principal-for-provisioning-resources","title":"Create a service principal for provisioning resources","text":"<ol> <li> <p>Login to Azure</p> <p>Log in to Azure using <code>az login</code> and select the Azure subscription you wish to deploy Azure TRE to:</p> <pre><code>az login\naz account list\naz account set --subscription &lt;subscription ID&gt;\n</code></pre> <p>See Sign in with Azure CLI for more details.</p> </li> <li> <p>Create a service principal</p> <p>A service principal needs to be created to authorize CI/CD workflows to provision resources for the TRE workspaces and workspace services.</p> <p>Create a main service principal with \"Owner\" role:</p> <pre><code>az ad sp create-for-rbac --name \"sp-aztre-cicd\" --role Owner --scopes /subscriptions/&lt;subscription_id&gt; --sdk-auth\n</code></pre> <p>Caution</p> <p>Save the JSON output locally - as you will need it later for setting secrets in the build</p> </li> <li> <p>Create a repository secret named <code>AZURE_CREDENTIALS</code> and use the JSON output from the previous step as its value. Note it should look similar to this: <pre><code>{\n\"clientId\": \"\",\n\"clientSecret\": \"\",\n\"subscriptionId\": \"\",\n\"tenantId\": \"\"\n}\n</code></pre></p> </li> </ol>"},{"location":"tre-admins/setup-instructions/workflows/#decide-on-a-tre-id-and-azure-resources-location","title":"Decide on a TRE ID and Azure resources location","text":"<p>Configure the TRE ID and LOCATION repository secrets</p> Secret name Description <code>TRE_ID</code> A globally unique identifier. <code>TRE_ID</code> can be found in the resource names of the Azure TRE instance; for example, a <code>TRE_ID</code> of <code>tre-dev-42</code> will result in a resource group name for Azure TRE instance of <code>rg-tre-dev-42</code>. This must be less than 12 characters. Allowed characters: Alphanumeric, underscores, and hyphens. <code>LOCATION</code> The Azure location (region) for all resources. E.g. <code>westeurope</code>"},{"location":"tre-admins/setup-instructions/workflows/#create-app-registrations-for-api-authentication","title":"Create app registrations for API authentication","text":"<p>Follow the instructions to run the app registration script in the Authentication and Authorization document. Use the values for TRE ID and LOCATION from above.</p> <p>Configure the TRE API and Swagger UI repository secrets</p> Secret name Description <code>AAD_TENANT_ID</code> The tenant ID of the Azure AD. <code>SWAGGER_UI_CLIENT_ID</code> The application (client) ID of the TRE Swagger UI app. <code>API_CLIENT_ID</code> The application (client) ID of the TRE API app. <code>API_CLIENT_SECRET</code> The application password (client secret) of the TRE API app."},{"location":"tre-admins/setup-instructions/workflows/#create-an-app-registration-and-a-user-for-the-e2e-tests","title":"Create an app registration and a user for the E2E tests","text":"<p>Follow the instructions to create an app registration and a test user for the E2E tests in the Authentication and Authorization document.</p> <p>Configure the E2E Test repository secrets</p> Secret name Description <code>TEST_APP_ID</code> The application (client) ID of the E2E Test app <code>TEST_USER_NAME</code> The username of the E2E Test User <code>TEST_USER_PASSWORD</code> The password of the E2E Test User"},{"location":"tre-admins/setup-instructions/workflows/#create-a-workspace-app-registration-for-setting-up-workspaces-for-the-e2e-tests","title":"Create a workspace app registration for setting up workspaces (for the E2E tests)","text":"<p>Follow the instructions to create a workspace app registration (used for the E2E tests) - and make the E2E test user a WorkspaceOwner for the app registration.</p> <p>Configure the TEST_WORKSPACE_APP_ID repository secret</p> Secret name Description <code>TEST_WORKSPACE_APP_ID</code> The application (client) ID of the Workspaces app. <code>TEST_WORKSPACE_APP_SECRET</code> The application (client) secret of the Workspaces app."},{"location":"tre-admins/setup-instructions/workflows/#create-a-teams-webhook-for-deployment-notifications","title":"Create a Teams Webhook for deployment notifications","text":"<p>The <code>deploy_tre.yml</code> workflow sends a notification to a Microsoft Teams channel when it finishes running.</p> <p>Note</p> <p>If you don't want to notify a channel, you can also remove the Notify dedicated teams channel steps in the workflow</p> <ol> <li> <p>Follow the Microsoft Docs to create a webhook for your channel</p> </li> <li> <p>Configure the MS_TEAMS_WEBHOOK_URI repository secret</p> Secret name Description <code>MS_TEAMS_WEBHOOK_URI</code> URI for the Teams channel webhook </li> </ol>"},{"location":"tre-admins/setup-instructions/workflows/#configure-repository-secrets","title":"Configure repository secrets","text":"<p>Configure additional repository secrets used in the deployment workflow</p> Secret name Description <code>MGMT_RESOURCE_GROUP_NAME</code> The name of the shared resource group for all Azure TRE core resources. <code>MGMT_STORAGE_ACCOUNT_NAME</code> The name of the storage account to hold the Terraform state and other deployment artifacts. E.g. <code>mystorageaccount</code>. <code>ACR_NAME</code> A globally unique name for the Azure Container Registry (ACR) that will be created to store deployment images. <code>CORE_ADDRESS_SPACE</code> The address space for the Azure TRE core virtual network. E.g. <code>10.1.0.0/22</code>. Recommended <code>/22</code> or larger. <code>TRE_ADDRESS_SPACE</code> The address space for the whole TRE environment virtual network where workspaces networks will be created (can include the core network as well). E.g. <code>10.0.0.0/12</code> <code>TERRAFORM_STATE_CONTAINER_NAME</code> Optional. The name of the blob container to hold the Terraform state. Default value is <code>tfstate</code>. <code>CORE_APP_SERVICE_PLAN_SKU</code> Optional. The SKU used for AppService plan for core infrastructure. Default value is <code>P1v2</code>. <code>WORKSPACE_APP_SERVICE_PLAN_SKU</code> Optional. The SKU used for AppService plan used in E2E tests. Default value is <code>P1v2</code>."},{"location":"tre-admins/setup-instructions/workflows/#deploy-the-tre-using-the-workflow","title":"Deploy the TRE using the workflow","text":"<p>With all the repository secrets set, you can trigger a workflow run by pushing to develop/main of your fork, or by dispatching the workflow manually.</p>"},{"location":"tre-developers/","title":"TRE Developers","text":"<p>This section contains information relevant for developing against Azure TRE. See the topics in the index on the left.</p>"},{"location":"tre-developers/api-permissions-map/","title":"TRE API Permissions Map","text":"<p>These tables specify each endpoint that exists today in TRE API and the permissions it supports.</p>"},{"location":"tre-developers/api-permissions-map/#workspace-api","title":"Workspace API","text":"Endpoints Researcher Workspace Owner Airlock Manager GET /workspaces/{workspace_id}/workspace-services V V V GET /workspaces/{workspace_id}/workspace-service-templates V V V GET /workspaces/{workspace_id}/workspace-service-templates/{service_template_name}/user-resource-templates V V V GET /workspaces/{workspace_id}/workspace-services/{service_id} V V POST /workspaces/{workspace_id}/workspace-services X V PATCH /workspaces/{workspace_id}/workspace-services/{service_id} V V DELETE /workspaces/{workspace_id}/workspace-services/{service_id} X V POST /workspaces/{workspace_id}/workspace-services/{service_id}/invoke-action X V GET /workspaces/{workspace_id}/workspace-services/{service_id}/operations V V V GET /workspaces/{workspace_id}/workspace-services/{service_id}/operations/{operation_id} V V V GET /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources V V V GET /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources/{resource_id} V V V POST /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources V V V PATCH /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources/{resource_id} V V V DELETE /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources/{resource_id} V V V POST /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources/{resource_id}/invoke-action V V V GET /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources/{resource_id}/operations V V V GET /workspaces/{workspace_id}/workspace-services/{service_id}/user-resources/{resource_id}/operations/{operation_id} V V V GET /workspaces/{workspace_id}/requests V V V GET /workspaces/{workspace_id}/requests/{airlock_request_id} V V X POST /workspaces/{workspace_id}/requests V V X POST /workspaces/{workspace_id}/requests/{airlock_request_id}/submit V V X POST /workspaces/{workspace_id}/requests/{airlock_request_id}/cancel V V X POST /workspaces/{workspace_id}/requests/{airlock_request_id}/review X X V GET /workspaces/{workspace_id}/requests/{airlock_request_id}/link V V V ## Core API Endpoints TRE Admin TRE User WS Owner ------------------------------------------------------------------------------------------------------------------- --------- -------- -------- GET /workspace-templates V X GET /workspace-templates/{workspace_template_name} V X POST /workspace-templates V X GET /workspace-service-templates V V GET /workspace-service-templates/{workspace_service_template_name} V V POST /workspace-service-templates V X GET /workspace-service-templates/{service_template_name}/user-resource-templates V V GET /workspace-service-templates/{service_template_name}/user-resource-templates/{user_resource_template_name} V V POST /workspace-service-templates/{service_template_name}/user-resource-templates V X GET /workspaces V V GET /workspaces/(workspace_id) V V POST /workspaces V X PATCH /workspaces/{workspace_id} V X X DELETE /workspaces/{workspace_id} V X X POST /workspaces/{workspace_id}/invoke-action V X X GET /workspaces/{workspace_id}/operations V X V GET /workspaces/{workspace_id}/operations/{operation_id} V X V GET /shared-service-templates V V GET /shared-service-templates/{shared_service_template_name} V V POST /shared-service-templates V X GET /shared-service V V GET /shared-service/{shared_service_id} V V POST /shared-service V X PATCH /shared-service/{shared_service_id} V X DELETE /shared-service/{shared_service_id} V X POST /shared-service/{shared_service_id}/invoke-action V X GET /shared-service/{shared_service_id}/operations V X GET /shared-service/{shared_service_id}/operations/{operation_id} V X POST /migrations V X GET /costs V X X GET /workspaces/{workspace_id}/costs V X V GET /health - - -"},{"location":"tre-developers/api/","title":"TRE API","text":"<p>The TRE API is a service that users can interact with to request changes to workspaces e.g., to create, update, delete workspaces and workspace services inside each workspace.</p> <p>This page is a guide for a developer looking to make a change to the API and debug it.</p>"},{"location":"tre-developers/api/#repository-folder-structure","title":"Repository folder structure","text":"<pre><code>api_app\n\u251c\u2500\u2500 api              - API implementation\n\u2502   \u251c\u2500\u2500 dependencies - Dependencies for routes definition\n\u2502   \u251c\u2500\u2500 errors       - Definitions of error handlers\n\u2502   \u2514\u2500\u2500 routes       - Web routes (API endpoints)\n\u2502\n\u251c\u2500\u2500 core             - Application configuration, startup events, logging\n\u2502\n\u251c\u2500\u2500 db               - Database related implementation\n\u2502   \u251c\u2500\u2500 migrations   - Manually written alembic migrations\n\u2502   \u2514\u2500\u2500 repositories - All CRUD features\n\u2502\n\u251c\u2500\u2500 models           - Pydantic models for this application\n\u2502   \u251c\u2500\u2500 domain       - Main models that are used almost everywhere\n\u2502   \u2514\u2500\u2500 schemas      - Schemas for using in web routes\n\u2502\n\u251c\u2500\u2500 resources        - Strings that are used e.g., in web responses\n\u2502\n\u251c\u2500\u2500 services         - Logic that is not only CRUD related (authentication, logging, tracing, etc)\n\u2502\n\u251c\u2500\u2500 tests_ma         - Unit tests\n\u2502\n\u2514\u2500\u2500 main.py          - FastAPI application creation and configuration\n</code></pre>"},{"location":"tre-developers/api/#unit-tests","title":"Unit tests","text":"<p>The unit tests are written with pytest and located in folder <code>/api_app/tests_ma/</code>.</p> <p>Run all unit tests with the following command in the root folder of the repository:</p> <pre><code>pytest --ignore=e2e_tests\n</code></pre> <p>Please refer to a different guide on running E2E tests locally.</p>"},{"location":"tre-developers/api/#local-debugging","title":"Local debugging","text":"<p>To set up local debugging, first run (if you haven't done so already)</p> <pre><code>az login\nmake setup-local-debugging\n</code></pre> <p>Next, go to \"Run and Debug\" panel in VSCode, and select TRE API.</p> <p></p> <p>You will see a log similar to this:</p> <p></p> <p>Now, you should be able to open Swagger UI for your local instance on http://localhost:8000/api/docs.</p>"},{"location":"tre-developers/api/#cloud-instance","title":"Cloud instance","text":"<p>On Azure Portal, find an App Service instance named <code>app-${TRE_ID}</code>.</p>"},{"location":"tre-developers/api/#api-logs-in-loganalytics","title":"API logs in LogAnalytics","text":"<p>To find logs in LogAnalytics, go to your resource group, then to LogAnalytics instance, which is named like <code>log-${TRE_ID}</code>.</p> <p>There, you can run a query like</p> <pre><code>AppTraces \n| where AppRoleName == \"uvicorn\"\n| order by TimeGenerated desc \n</code></pre>"},{"location":"tre-developers/api/#api-logs-using-deployment-center","title":"API logs using deployment center","text":"<p>Check that the version you are debugging/troubleshooting is the same one deployed on the App Service.</p> <p>You can check this in Deployment Center, or follow the logs as generated by the container in the logs tabs.</p> <p></p>"},{"location":"tre-developers/api/#deploying-a-cloud-instance","title":"Deploying a cloud instance","text":"<p>To deploy a new version of the API to your TRE deployment, do this:</p> <ol> <li> <p>Update the version in <code>api_app/_version.py</code></p> </li> <li> <p>Run</p> </li> </ol> <pre><code>make build-and-push-api\nmake deploy-core\n</code></pre>"},{"location":"tre-developers/api/#enabling-debug-mode-on-the-api","title":"Enabling DEBUG mode on the API","text":"<p>For security, the API is by default configured to not show detailed error messages and stack trace when an error occurs.</p> <p>You can enable debugging via one of the two ways:</p> <ol> <li>Set <code>DEBUG=true</code> in <code>templates/core/.env</code> file (see [])</li> </ol> <p>To enable debugging on an already running instance:</p> <ol> <li>Go to App Service for the API and select Settings &gt; Configuration.</li> <li>Click New Application Setting.</li> <li>in the new dialog box set Name=DEBUG and Value=true</li> </ol> <p></p>"},{"location":"tre-developers/api/#using-swagger-ui","title":"Using Swagger UI","text":"<p>Swagger UI lets you send requests to the API.</p> <p>To send a request, click on the row with the request, then <code>Try out</code>, then <code>Execute</code>. See screenshot:</p> <p></p>"},{"location":"tre-developers/api/#authorization","title":"Authorization","text":"<p>Swagger UI is accessible under <code>https://${TRE_ID}.${LOCATION}.cloudapp.azure.com/api/docs</code>.</p> <p>To start using it, click Authorize button, then click Authorize (leave the field <code>client_secret</code> empty). See screenshot:</p> <p></p> <p>If you see an error message saying something like:</p> <pre><code>The redirect URI 'https://tanyagts8.westeurope.cloudapp.azure.com/api/docs/oauth2-redirect' specified in the request does not match the redirect URIs configured for the application '558602a8-764a-453c-8efa-4dc3ddd61570'.\n</code></pre> <p>Then you'll need to update the redirect URI (see below).</p> <p>Otherwise, after you sign in on Azure Portal, the lock icon on Authorize button should look \"locked\". Then you can start executing queries.</p> <p>See also setup instructions.</p> <p>All workspace operations are executed using a different URL: <code>https://${TRE_ID}.${LOCATION}.cloudapp.azure.com/api/workspaces/${WORKSPACE_ID}/docs</code>. See also instructions on installing base workspace.</p>"},{"location":"tre-developers/api/#updating-the-redirect-uri","title":"Updating the redirect URI","text":"<p>If you get the following error:</p> <p></p> <p>You should run:</p> <pre><code>make auth\n</code></pre> <p>Alternatively, in Azure Portal you can add the redirect URL to the App Registration. Under AAD, find App Registrations, and find the App Registration with the ID shown in the error message. There, go to Redirect URL and add the URL given to you by the error message (it will have a form of <code>https://${TRE_ID}.westeurope.cloudapp.azure.com/api/docs/oauth2-redirect</code>).</p>"},{"location":"tre-developers/api/#troubleshooting","title":"Troubleshooting","text":""},{"location":"tre-developers/api/#wrong-docker-image-version","title":"Wrong docker image version","text":"<p>If this happens, you will see a log similar to this:</p> <p><code>2022-05-10T05:34:48.844Z ERROR - DockerApiException: Docker API responded with status code=NotFound, response={\"message\":\"manifest for tborisdevtreacr.azurecr.io/microsoft/azuretre/api:0.2.24 not found: manifest unknown: manifest tagged by \\\"0.2.24\\\" is not found\"}</code></p> <p>To fix, run <code>make build-and-push-api</code> from your branch and restart the instance.</p>"},{"location":"tre-developers/api/#investigating-apihealth-response","title":"Investigating /api/health response","text":"<p>The endpoint <code>/api/health</code> tracks health of not only API, but other components of the system too, and can help to narrow down any problems with your deployment:</p> <pre><code>{\n\"services\": [\n{\n\"service\": \"Cosmos DB\",\n\"status\": \"OK\",\n\"message\": \"\"\n},\n{\n\"service\": \"Service Bus\",\n\"status\": \"OK\",\n\"message\": \"\"\n},\n{\n\"service\": \"Resource Processor\",\n\"status\": \"Not OK\",\n\"message\": \"Resource Processor is not responding\"\n}\n]\n}\n</code></pre> <p>In this case, next step is to look at logs of Resource Processor. See also Resource Processor docs.</p>"},{"location":"tre-developers/end-to-end-tests/","title":"End-to-end (E2E) tests","text":""},{"location":"tre-developers/end-to-end-tests/#prerequisites","title":"Prerequisites","text":"<ol> <li>Authentication and Authorization configuration set up as noted here</li> <li>An Azure Tre deployed environment.</li> </ol>"},{"location":"tre-developers/end-to-end-tests/#registering-bundles-to-run-end-to-end-tests","title":"Registering bundles to run End-to-end tests","text":"<p>End-to-end tests depend on certain bundles to be registered within the TRE API.</p> <p>When End-to-end tests run in CI, they are registered as a prerequisite to running tests.</p> <p>When running tests locally, use the <code>prepare-for-e2e</code> Makefile target:</p> <pre><code>make prepare-for-e2e\n</code></pre>"},{"location":"tre-developers/end-to-end-tests/#debugging-the-end-to-end-tests","title":"Debugging the End-to-End tests","text":"<p>Use the \"Run and Debug\" panel within Visual Studio Code, select \"E2E Extended\", \"E2E Smoke\" or \"E2E Performance\" in the drop down box and click play.</p> <ul> <li>This will copy /workspaces/AzureTRE/templates/core/.env to /workspaces/AzureTRE/e2e_tests/.env for you which supplies your authentciation details</li> </ul> <ul> <li>This will also use /workspaces/AzureTRE/templates/core/private.env file for other values.</li> </ul>"},{"location":"tre-developers/letsencrypt/","title":"Letsencrypt","text":"<p>Certain components of the TRE require the aquisition of a certificate via Letsencrypt to ensure secure HTTPS connections.</p> <p>In order to aquire these certificates, there must be a public facing endpoint which can be reached by Letsencrypt.</p> <p>As TREs are secured environments with very few publicly facing points, additional resources are required to ensure the certificate can be provisioned for the correct domain.</p> <p>The additional resources are as followed:</p> <ol> <li>Public IP provisioned in the same location as the web app that the certificate is intended for; this will also have a domain label which matches the web app name.</li> <li>Storage Account with a static web app.</li> <li>Application gateway to route traffic from the Public IP to the static web app</li> </ol> <p>The following diagram illustrated the flow of data between the resources:</p> <pre><code>flowchart RL\n    subgraph .dev Container\n        direction TB\n        A(letsencrypt process runs)\n    end\n    subgraph External\n        direction TB\n        B[letsencrypt authority]\n    end\n    subgraph TRE\n        subgraph Core VNet\n            C[Public IP  &lt;br/&gt; Domain Label: &lt; web-app-name &gt; &lt;br/&gt; Endpoint: &lt; web-app-name &gt;.&lt; location &gt;.cloudapp.net]\n            subgraph Storage Account\n                D[SA Static Site]\n            end\n        end\n        subgraph VNet\n            E[Key Vault &lt;br/&gt; kv-&lt; tre_id &gt;]\n            subgraph VM\n                F[Web App]\n            end\n            G[Private DNS Zone &lt; web-app-name &gt;.&lt; location &gt;.cloudapp.net]\n        end\n    end\n\n    A --&gt; |1. Request to            | B\n    B --&gt; |2. Attempts to hit       | C\n    C --&gt; |3. App Gateway routes    | D\n    D --&gt; |4. Responds              | C\n    C --&gt; |5. Responds              | B\n    B --&gt; |6. Acquires certificate  | A\n    A --&gt; |7. Stores Certificate    | E\n    F --&gt; |8. Pulls Certificate     | E</code></pre>"},{"location":"tre-developers/release/","title":"How to release an AzureTRE version","text":"<p>A release is created when enough changes have been made and the main branch is stable enough.</p> <p>The process follows these steps:</p> <ol> <li>Update <code>CHANGELOG.md</code> in a PR with the following:     1. Rename the top-most verion noted as unreleaed with the version number that makes sense. Note that you don't have to keep the one that is currently in the file as the version number chosen should reflect the changes made (major, minor, etc.)     1. Create a new section for the next-unreleaed version so that future changes will be placed there.     1. Run <code>devops/scripts/list_versions.sh</code> and include the output in the change log for the version you're about the release</li> <li>Merge the PR</li> <li>Create a GitHub Release          1. Go to https://github.com/microsoft/AzureTRE/releases/new     1. Click on <code>Choose a tag</code> and type a new one for you version. It should be in the form of <code>v0.9.2</code> - note the \"v\" in the begining.     1. The release title should be just the version number \"0.9.2\" in the example above.     1. Copy the text from the CHANGELOG.md file and paste in the release description.     1. Include a final line with a link to the full changelog similar to this:      Full Changelog: https://github.com/microsoft/AzureTRE/compare/v0.9.1...v0.9.2</li> <li>Update AzureTRE-Deployment. The procedure may vary depending on the level of changes introduced in the new version but should include the following steps:     1. Update the tag used in devcontainer.json.     1. Rebuild the container.     1. Compare both <code>.devcontainer</code> and <code>.github</code> folders of the new release with the ones in the repo and make required updates so that only required difference exist.     The comapre can be done with VSCode Compare Folders extension as you have both the old version (under to root folder) and the \"new\" one inside the AzureTRE symlink.     1. With all changes made, rebuild the container to verify it's working and that AzureTRE folder has been populated correctly.</li> </ol>"},{"location":"tre-developers/resource-processor/","title":"Resource Processor (VMSS)","text":"<p>Resource Processor is the Azure TRE component automating Porter bundle deployments. It hosts Porter and its dependencies.</p> <p>This page is a guide for a developer looking to make a change to the Resource Processor and debug it.</p>"},{"location":"tre-developers/resource-processor/#overview","title":"Overview","text":"<p>The logic in Resource Processor is written in Python. The Resource Processor implementation is located in <code>resource_processor</code> folder of the repository.</p> <p>Read how a workspace is provisioned using Porter</p>"},{"location":"tre-developers/resource-processor/#local-debugging","title":"Local debugging","text":"<p>To set up local debugging, first run, if you haven't done so already (make sure <code>ENABLE_LOCAL_DEBUGGING</code> is set to <code>true</code> in your <code>.env</code> file):</p> <pre><code>az login\nmake setup-local-debugging\n</code></pre> <p>This will allowlist your local IP against Azure resources and create a Service Principal for the Resource Processor.</p> <p>Next, disable the existing Resource Processor from running in your deployment. The easiest way to do this is to stop the VM scale set:</p> <p></p> <p>Now, go to \"Run and Debug\" panel in VSCode, and select Resource Processor.</p> <p></p> <p>Info</p> <p>If you get a credential error when trying to connect to Service Bus, make sure you've authenticated in the AZ CLI first as it uses your local credentials.</p> <p>Info</p> <p>If you get an error similar to <code>Environment variable 'ARM_CLIENT_ID' is not set correctly</code>, make sure you have ran <code>make setup-local-debugging</code></p> <p>You can use an API instance deployed in your environment to create deployment requests, and debug your locally running Resource Processor.</p> <p>For more information on how to use API, refer to API documentation.</p>"},{"location":"tre-developers/resource-processor/#cloud-instance","title":"Cloud instance","text":"<p>On Azure Portal, find an Virtual VM scale set with a name <code>vmss-rp-porter-${TRE_ID}</code>.</p>"},{"location":"tre-developers/resource-processor/#resource-processor-logs-in-loganalytics","title":"Resource Processor logs in LogAnalytics","text":"<p>To find logs in LogAnalytics, go to your resource group, then to LogAnalytics instance, which is named like <code>log-${TRE_ID}</code>.</p> <p>There, you can run a query like</p> <pre><code>AppTraces \n| where AppRoleName == \"runner.py\"\n| order by TimeGenerated desc \n</code></pre>"},{"location":"tre-developers/resource-processor/#ssh-ing-to-the-instance","title":"SSH-ing to the instance","text":"<p>The processor runs in a VNET, and you cannot connect to it directly. To SSH to this instance, use Bastion.</p> <ol> <li>Find a keyvault with a name <code>kv-${TRE_ID}</code> in your resource group.</li> <li> <p>Copy a secret named <code>resource-processor-vmss-password</code></p> <p></p> <p>If you don't have permissions to see the secret, add yourself to the Access Policy of this keyvault with a permission to read secrets:</p> <p> 1. Connect to the instance using Bastion. Use the username <code>adminuser</code> and the password you just copied.</p> <p></p> </li> </ol>"},{"location":"tre-developers/resource-processor/#getting-container-logs","title":"Getting container logs","text":"<ol> <li>SSH into the Resource Processor VM as described above</li> <li> <p>Check the status of the container using <code>sudo docker ps</code></p> <p>If you see nothing (and the container was pulled) then the processor has either not started yet or it has crashed.</p> </li> <li> <p>Get the logs from the container using <code>sudo docker logs &lt;container_id&gt;</code> command.</p> </li> </ol>"},{"location":"tre-developers/resource-processor/#starting-container-manually","title":"Starting container manually","text":"<ol> <li>Find the runner_image:tag by running <code>docker ps</code></li> <li> <p>Execute the following command from the root (/) of the file system</p> <pre><code>sudo docker run -v /var/run/docker.sock:/var/run/docker.sock --env-file .env --name resource_processor_vmss_porter_debug [runner_image:tag]\n</code></pre> </li> </ol> <p>Info</p> <p>If you start a container manually you will probably want to install software, for example, an editor. However, the firewall blocks all ingress traffic, so you cannot run <code>sudo apt update</code>. You need to add an override rule in the firewall to allow the traffic.</p> <p>Caution</p> <p>Remember to remove this rule when debugging is done.</p>"},{"location":"tre-developers/resource-processor/#troubleshooting","title":"Troubleshooting","text":""},{"location":"tre-developers/resource-processor/#no-container-logs-on-the-instance","title":"No container logs on the instance","text":"<ol> <li> <p>If you don't see container logs, you should check the status of cloud-init which is used to bootstrap the machine with docker and start the processor. Log files for cloud init are:</p> <ul> <li><code>/var/log/cloud-init.log</code></li> <li><code>/var/log/cloud-init-output.log</code></li> </ul> <p>If the Docker container is pulled as shown in logs then the resource processor should start. 1. Check the status of all Docker processes using <code>docker ps -a</code> which should show you if the container terminated prematurely.</p> </li> </ol>"},{"location":"tre-developers/resource-processor/#implementation-details","title":"Implementation details","text":""},{"location":"tre-developers/resource-processor/#porter","title":"Porter","text":"<p>Azure TRE needed a solution for implementing and deploying workspaces and workspace services with the following properties:</p> <ul> <li>Means for packaging and versioning workspaces and workspace services</li> <li>Providing unified structure for deployment definitions (scripts, pipelines) so that the process can be easily automated</li> <li>Solid developer experience - easy to use and learn</li> </ul> <p>Porter meets all these requirements well. Porter packages cloud application into a versioned, self-contained Docker container called a Porter bundle.</p> <p>CNAB spec defines actions that Porter implements: install, upgrade and uninstall. The developer has practically complete freedom on how to implement logic for these actions. The deployment pipeline definition is created in YAML. The YAML file is called Porter manifest and in additon to the actions, it contains the name, version, description of the bundle and defines the input parameters, possible credentials and output.</p> <p>Furthermore, Porter provides a set of mixins - analogous to the concrete actions in GitHub workflows and tasks in Azure DevOps pipelines - which simplify and reduce the development cost when implementing deployment logic. For example, Terraform mixin installs the required tools and provides a clean step in the pipeline to execute Terraform deployments. Exec mixin allows running any command or script; especially useful, if no suitable mixin for a specific technology is available. Implementing custom mixins is possible too.</p>"},{"location":"tre-developers/resource-processor/#porter-azure-plugin","title":"Porter Azure plugin","text":"<p>Resource Processor uses Porter Azure plugin to store Porter data in TRE management storage account. The storage table, named <code>porter</code>, is created during the bootstrapping phase of TRE deployment. The <code>/resource_processor/run.sh</code> script generates a <code>config.toml</code> file in Porter home folder to enable the Azure plugin when the image is started.</p>"},{"location":"tre-developers/resource-processor/#porter-bundle-inputs","title":"Porter bundle inputs","text":"<p>When Porter runs bundle actions, it passes input parameters. Full set of inputs that Porter passes can be found in config.py.</p> <p>Info</p> <p>Note that Resource Processor does not pass any location-related attributes when running bundle actions. Instead, a <code>location</code> attribute is passed from the API. This is so that different TRE resources could be potentially deployed to different regions.</p>"},{"location":"tre-developers/ui/","title":"TRE Web User Interface","text":"<p>This project contains a React-based web UI which covers the core aspects of a TRE, for researchers and workspace owners.</p>"},{"location":"tre-developers/ui/#chosen-ui-stack-components","title":"Chosen UI Stack + Components","text":"<p>The UI is built upon several popular web frameworks: - React v18 (created via create-react-app, with all build configurations left as defaults)   - Typescript   - React Router v6 for client side routing - Fluent UI Fluent UI Docs - MSAL v2: AAD authentication msal-react docs</p>"},{"location":"tre-developers/ui/#folder-structure","title":"Folder structure","text":"<pre><code>ui\n\u251c\u2500\u2500 app                    - Root of the React application\n\u2502   \u251c\u2500\u2500 build              - Location of compiled files after build process\n\u2502   \u251c\u2500\u2500 public             - Location for static HTML to bootstrap the app\n\u2502   \u251c\u2500\u2500 src                - All .tsx components\n\u2502   \u251c\u2500\u2500 index.tsx          - Entry point for the app\n\u2502   \u251c\u2500\u2500 App.tsx            - Wrapper and routing for the app\n\u2502   \u2514\u2500\u2500 config.source.json - JSON file to be used as source file for autogenerated config\n</code></pre>"},{"location":"tre-developers/ui/#authn-authz","title":"AuthN + AuthZ","text":"<p>For further details on the auth setup, see Auth.</p> <p>As stated above, AAD is used for Authentication and Authorization. There are 3 AAD apps involved here: - TRE UX. This is the app that the user authenticates against. Once authenticated, the client will request an access token for the <code>TRE Api</code>. - TRE Api. In the access token response from this app we get the user's role membership for TRE-level roles (<code>TREAdmin</code> / <code>TREUser</code>). Based on these role memberships, aspects of the UI will be made available. If the user is in a <code>TREAdmin</code> role, they will see buttons to create workspaces for instance. When the user navigates into a Workspace, the client will request an access token for that <code>Workspace App</code>. - Workspace App(s). Each TRE workspace will have a workspace app registration. The Application Id URI for each workspace app is stored in the Workspace resource object in Cosmos, and the client uses this URI to gain an access token for that particular workspace.</p> <p>Workspace app registrations may be reused across multiple workspaces in development scenarios. From this access token we can find the Workspace-level roles the user is in (<code>WorkspaceOwner</code> / <code>WorkspaceResearcher</code>). These are in turn used to show/hide features of the UI.</p>"},{"location":"tre-developers/ui/#react-contexts","title":"React Contexts","text":"<p>The React Context API is a clean way to handle a limited amount of global state, and is used for a few scenarios in this project: - TRE Roles Context: A context provides details of the base TRE roles a user is in, which can be consumed anywhere throughout the app - Workspace Context: Tracks the currently selected Workspace, and the roles the user is in for that Workspace. This context is used for nested components to be able to authenticate against the correct AAD App via <code>workspaceCtx.workspaceApplicationIdURI</code>. - Create Form Context: A context to control the Create / Update form behaviour. - Notifications Context: Tracks all the in-progress operations currently running. For each operation, the Notifications panel also uses this context to broadcast Component 'actions' which are subscribed to by downstream components. This way, a resource component does not have to track it's own changes, and can be 'told' by the Notifications Context whether it should refresh / lock etc.</p>"},{"location":"tre-developers/ui/#custom-hooks","title":"Custom Hooks","text":"<p>Hooks are used throughout the project, and a couple of custom hooks were written to abstract common logic: - <code>useAuthApiCall</code>: A way to encapsulate an authenticated <code>fetch</code> request and provide a simple interface for downstream components to use. - <code>useComponentManager</code>: This hook subscribes to changes broadcast from the Notifications panel, via the context. A component can simply add this hook to start subscribing to changes and react accordingly.</p>"},{"location":"tre-developers/ui/#deployment","title":"Deployment","text":"<p>The UI is deployed as part of the <code>tre-deploy</code> make target (unless you set <code>DEPLOY_UI=false</code> in your <code>./templates/core/.env</code> file).</p> <p>To re-deploy just the UI (after an initial deploy), run <code>make build-and-deploy-ui</code> from the root of the dev container. This will: - Use the environment variables from your deployment to create a <code>config.json</code> file for the UI - Build the source code, via <code>yarn build</code> - Deploy the code to Azure blob storage, where it will be statically served behind the App Gateway that also fronts the APi.</p>"},{"location":"tre-templates/","title":"Templates and Services","text":"<p>Info</p> <p>Coming soon</p> <p>We're working to improve our documentation, and fill in some gaps. Unfortunately, this particular page is one of the gaps we're looking to fill and isn't yet available.</p>"},{"location":"tre-templates/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"tre-templates/pipeline-templates/overview/","title":"Pipeline Templates","text":"<p>Occasionally there will be a need for the deployment / update of one resource to affect a change in another. This section outlines how that can be achieved with Pipeline Templates.</p>"},{"location":"tre-templates/pipeline-templates/overview/#overview","title":"Overview","text":"<p>A pipeline template is an optional <code>pipeline: {}</code> block that can be added to the top level of a resource schema document. It allows a template developer to define actions to run against other resources before and after the primary resource is deployed.</p>"},{"location":"tre-templates/pipeline-templates/overview/#example","title":"Example","text":"<p>Consider the following <code>template_schema.json</code>:</p> <pre><code>{\n\"$schema\": \"http://json-schema.org/draft-07/schema\",\n\"$id\": \"https://github.com/microsoft/AzureTRE/templates/workspace_services/guacamole/user_resources/guacamole-dev-vm/template_schema.json\",\n...\n\"properties\": {...},\n\"pipeline\": {\n\"install\": [\n{\n\"stepId\": \"6d2d7eb7-984e-4330-bd3c-c7ec98658402\",\n\"stepTitle\": \"Update the firewall name\",\n\"resourceTemplateName\": \"tre-shared-service-firewall\",\n\"resourceType\": \"shared_service\",\n\"resourceAction\": \"upgrade\",\n\"properties\": [\n{\n\"name\": \"display_name\",\n\"type\": \"string\",\n\"value\": \"A new name here!\"\n}]\n},\n{\n\"stepId\": \"main\"\n},\n{\n\"stepId\": \"2fe8a6a7-2c27-4c49-8773-127df8a48b4e\",\n...\n}\n]\n}\n}\n</code></pre> <p>When a user deploys this resource, the API will read the <code>install: []</code> array within the <code>pipeline: {}</code> block, and will: - Orchestrate the <code>upgrade</code> of the <code>tre-shared-service-firewall</code>, changing the <code>display_name</code> property to <code>A new name here!</code>. - Run the <code>main</code> (primary resource) install - Complete the next step</p> <p>A single <code>Operation</code> document will be used to keep track of which steps in the deployment chain have completed.</p>"},{"location":"tre-templates/pipeline-templates/overview/#current-limitations","title":"Current Limitations","text":"<p>This feature is undergoing active development, and is currently limited in the following ways: - Only statically addressable resources can be referred to - <code>shared_services</code>, as these are singletons and can be referenced by a template name. - Only the <code>upgrade</code> action for each secondary resource is supported. Support for <code>install</code> / <code>uninstall</code> of secondary resources is planned. - No current planned support for <code>customActions</code>.</p>"},{"location":"tre-templates/pipeline-templates/pipeline-schema/","title":"Pipeline Template Schema","text":"<p>This document will help you write a valid <code>pipeline: {}</code> block in your template.</p> <p>For a working example, see <code>./templates/shared-services/sonatype-nexus/template_schema.json</code>.</p>"},{"location":"tre-templates/pipeline-templates/pipeline-schema/#schema","title":"Schema","text":"<pre><code>\"pipeline\": {\n\"install\": [ // &lt;-- [install | upgrade | uninstall]\n{\n\"stepId\": \"a unique string value here\",\n\"stepTitle\": \"Friendly description of the step here - will be displayed in the UI\",\n\"resourceTemplateName\": \"name of the resource template to update\", // only required for shared_service targets\n\"resourceType\": \"shared_service\", // [ shared_service | user_resource | workspace_service | workspace ]\n\"resourceAction\": \"upgrade\", // &lt;-- currently only upgrade supported\n\"properties\": [\n{\n\"name\": \"display_name\",\n\"type\": \"string\",\n\"value\": \"A new name here!\"\n}]\n},\n{\n\"stepId\": \"main\" // &lt;-- deployment of the VM resource\n},\n</code></pre>"},{"location":"tre-templates/pipeline-templates/pipeline-schema/#substituting-resource-property-values","title":"Substituting Resource Property Values","text":"<p>It's possible to refer to properties from the primary resource (the resource that triggered this pipeline) in the template steps. The values will be substituted in at runtime.</p> <p>The syntax is <code>{{ resource.propertyName }}</code>. For example: <code>\"{{ resource.properties.display_name }}\"</code>.</p> <p>Example pipeline in <code>template_schema.json</code>: The below example references 2 properties from the primary resource to be used in updating the firewall shared service.</p> <pre><code>\"pipeline\": {\n\"upgrade\": [\n{\n\"stepId\": \"1234567-87654-2345-6543\",\n\"stepTitle\": \"Update a firewall rule\",\n\"resourceTemplateName\": \"tre-shared-service-firewall\",\n\"resourceType\": \"shared_service\", \"resourceAction\": \"upgrade\",\n\"arraySubstitutionAction\": \"replace\", // &lt;-- [append | remove | replace]\n\"arrayMatchField\": \"name\", // &lt;-- name of the field in the array object to match on, for remove / replace\n\"properties\": [\n{\n\"name\": \"rule_collections\",\n\"type\": \"array\", // &lt;-- More on array types below\n\"value\": { // &lt;-- value can be string or object\n\"name\": \"my-firewall-rule-collection\",\n\"action\": \"Allow\",\n\"rules\": [\n{\n\"name\": \"my-rules\",\n\"target_fqdns\": \"{{ resource.properties.fqdns_list }}\",\n\"source_addresses\": \"{{ resource.properties.address_prefixes }}\"\n}\n}\n}]\n},\n</code></pre>"},{"location":"tre-templates/pipeline-templates/pipeline-schema/#working-with-properties-containing-arrays","title":"Working with Properties Containing Arrays","text":"<p>It's possible that a resource property would actually be an array. As an example, the firewall shared service has the <code>rule_collections</code> property. This single property contains an array of objects. Since the values inside this array may have been sourced from different resources, it's important to leave other values in tact when modifying the property. To do so, the <code>arraySubstitutionAction</code> field supports the following values: - <code>append</code> - just append this object into the array - <code>replace</code> - find this object in the array (using the <code>arrayMatchField</code> value), and replace it with this value - <code>remove</code> - remove this property from the array (useful for <code>uninstall</code> actions)</p>"},{"location":"tre-templates/pipeline-templates/pipeline-schema/#notes","title":"Notes","text":"<ul> <li>Each step is executed in serial, in the order defined in the template</li> <li>Theoretically any number of steps could be created</li> <li>A step with <code>step_id</code> of <code>main</code> represents where in the chain the primary resource will get deployed. It is possible to omit this step altogether, and not touch the primary resource at all.</li> </ul>"},{"location":"tre-templates/shared-services/airlock-notifier/","title":"Airlock Notifications Shared Service","text":"<p>This shared service connects to the Airlock's notification event grid and send emails to the researchers/ws owners upon Airlock requests changes.</p>"},{"location":"tre-templates/shared-services/airlock-notifier/#development-and-modification","title":"Development and modification","text":"<p>This service was built with extensibility and modification in mind, since each organization might have different messaging platform and preferences.</p> <p>From that reason, and for low-code development, Airlock notification service (or Airlock Notifier) is defined in an Azure Logic App workflow.</p> <p>Editing the workflow can be done through the Azure Portal, or with the Azure Logic Apps (Standard) Visual Studio Code extension. In this repository, you will find that as the default, the email is sent using the Logic App SMTP connector. Since the connector is 'Managed', your environment or firewall must allow access for the outbound IP addresses used by these connectors in your datacenter region. In the future, the SMTP connection should transition into a 'Built-in connector', thus running in the same cluster as the Azure Logic Apps host runtime, and using virtual network (VNet) integration capabilities to access resources over a private network.</p> <p>As an alternative to the SMTP connector, you can modify the Logic app to use other email and messaging platforms as connectors, like Office 365, Outlook.com, MailChimp, Mandrill.</p>"},{"location":"tre-templates/shared-services/cyclecloud/","title":"Azure CycleCloud Shared Service","text":"<p>Azure CycleCloud is an enterprise-friendly tool for orchestrating and managing High Performance Computing (HPC) environments on Azure. This shared service deploys a single CycleCloud server, which can be used to by a TRE Administrator to create and manage multiple HPC clusters.</p> <p></p> <p>Used  \"as is\", this shared service is only appropriate for proof of concept work and small projects, however can be used as a starting point for more advanced scenarios.</p> <p>Using the CycleCloud cluster properties the TRE Administrator can choose which virtual network the cluster will be deployed into, and hence the workspace the cluster can be accessed from.</p> <p>At present there is no self service cluster creation for research teams, and as such costs are not attributed to individual workspace however this could be added in the future, and is tracked in this issue https://github.com/microsoft/AzureTRE/issues/2230.</p>"},{"location":"tre-templates/shared-services/cyclecloud/#deployment-and-configuration","title":"Deployment and Configuration","text":"<p>The CycleCloud shared service template needs registering with the TRE as per &lt;../../tre-admins/registering-templates/&gt; The templates can be found at <code>templates/shared_services/cyclecloud</code>.</p> <p>Prior to deploying the CycleCloud server, the license terms for any Azure VM marketplace images used by CycleCloud must be accepted. This can be done by running the following command while logged into the Azure CLI:</p> <pre><code>az vm image terms accept --urn azurecyclecloud:azure-cyclecloud:cyclecloud8:latest\naz vm image terms accept --urn almalinux:almalinux-hpc:8_5-hpc:latest\n</code></pre> <p>Deploy the CycleCloud server using UI or API.</p> <p>To connect to the CycleCloud server, the TRE Administrator must connect to the CycleCloud server from the administration jumpbox. Use Azure Bastion to connect to the jumpbox a with the username <code>admin</code> and the select the password located in your core KeyVault. Connect to the CycleCloud server at the URL: <code>https://cyclecloud-{TRE_ID}.{LOCATION}.cloudapp.azure.com/</code>.</p> <ul> <li>Provide a name for the cyclecloud server instance.</li> </ul> <p>-Review the terms and conditions and hit next.</p> <ul> <li>Provide your user details, including SSH key</li> </ul> <ul> <li>Hit Done, and wait for the add subscription dialog. Select the region your TRE is deployed into, leave the resource group as the default <code>&lt;Create New Per Cluster&gt;</code> and select the storage account beginning <code>stgcc</code>. This should look similar to:</li> </ul> <p></p> <ul> <li>Hit Save, and then \"Back to Clusters\"</li> </ul>"},{"location":"tre-templates/shared-services/cyclecloud/#create-a-cluster","title":"Create a Cluster","text":"<ul> <li>Before you start creating the cluster retrieve the last 4 digits of the workspace ID that you want to deploy the cluster into.</li> </ul> <ul> <li>Create a user in CycleCloud as per https://docs.microsoft.com/en-us/azure/cyclecloud/concepts/user-management?view=cyclecloud-8#adding-new-users-to-cyclecloud . The SSH key for the user will need to be created within the workspace and public key exporting. We suggest using the 4 digits retrieved in step 1 as part of the user account.</li> </ul> <ul> <li>Select your cluster type, we have tested Slurm and Grid Engine using the methods documented here.</li> </ul> <ul> <li>Give the cluster a name - again we suggest using the last 4 digits of the workspace ID as part of the name.Click Next.</li> </ul> <ul> <li>Select your required settings. In the Subnet ID box, choose the <code>ServicesSubnet</code> in the resource group and virtual network containing the 4 digit workspace ID. Click Next.</li> </ul> <ul> <li>Configure any storage settings and click Next.</li> </ul> <ul> <li>Under advanced settings, under advanced networking - uncheck Return Proxy, and Public Head node. Click Next.</li> </ul> <ul> <li>Under cloud init, paste the below script, with the appropriate values for TRE ID and Region into each of the nodes to ensure the package mirror is used.</li> </ul> <pre><code>#!/bin/sh\nTRE_ID=\"mrtredemo2\"\nREGION=\"westeurope\"\n\nls /etc/yum.repos.d/*.repo | xargs sed -i 's/mirrorlist/# mirrorlist/g'\nls /etc/yum.repos.d/*.repo | xargs sed -i \"s,# baseurl=https://repo.almalinux.org/,baseurl=https://nexus-$TRE_ID.$REGION.cloudapp.azure.com/repository/almalinux/,g\"\n\nyum -y install epel-release\nls /etc/yum.repos.d/*.repo | xargs sed -i 's/metalink/# metalink/g'\nls /etc/yum.repos.d/*.repo | xargs sed -i \"s,#baseurl=https://download.fedoraproject.org/,baseurl=https://nexus-$TRE_ID.$REGION.cloudapp.azure.com/repository/fedoraproject/,g\"\n\nyum -y install python3 python3-pip\n\nsudo tee /etc/pip.conf &lt;&lt;EOF\n[global]\nindex = https://nexus-$TRE_ID.$REGION.cloudapp.azure.com/repository/pypi/pypi\nindex-url = https://nexus-$TRE_ID.$REGION.cloudapp.azure.com/repository/pypi/simple\ntrusted-host = https://nexus-$TRE_ID.$REGION.cloudapp.azure.com\nEOF\n\nsudo cat &gt; /etc/yum.repos.d/cyclecloud.repo &lt;&lt;EOF\n[cyclecloud]\nname=cyclecloud\nbaseurl=https://nexus-$TRE_ID.$REGION.cloudapp.azure.com/repository/microsoft-yumrepos/cyclecloud\ngpgcheck=1\ngpgkey=https://nexus-$TRE_ID.$REGION.cloudapp.azure.com/repository/microsoft-keys/microsoft.asc\nEOF\n</code></pre> <ul> <li>Click Save.</li> </ul> <ul> <li>Under the new cluster, click Access and add the user created earlier and configure node access.</li> </ul> <ul> <li>Start the cluster, ensure the cluster starts successfully and provide the users connection details as detailed here: https://docs.microsoft.com/en-us/azure/cyclecloud/how-to/connect-to-node?view=cyclecloud-8</li> </ul>"},{"location":"tre-templates/shared-services/gitea/","title":"Gitea Shared Service","text":"<p>As outbound access to public git repositories such as GitHub is often blocked a git mirror may be required. Gitea can be deployed as a shared service to offer this functionality.</p> <p>Documentation on Gitea can be found here: https://docs.gitea.io/.</p>"},{"location":"tre-templates/shared-services/gitea/#deploy","title":"Deploy","text":"<p>To deploy this shared service you should use the UI (or the API) to issue a request. If you don't see the option available for this specifc template make sure it has been built, published and registered by the TRE Admin.</p>"},{"location":"tre-templates/shared-services/gitea/#getting-started","title":"Getting Started","text":"<p>Connect to the Gitea admin console <code>https://yourtreuri/gitea/</code> with the <code>giteaadmin</code> user. You can find the password in keyvault as <code>gitea password</code>.</p>"},{"location":"tre-templates/shared-services/gitea/#network-requirements","title":"Network requirements","text":"<p>Gitea needs to be able to access the following resource outside the Azure TRE VNET via explicitly allowed Service Tags or URLs.</p> Service Tag / Destination Justification AzureActiveDirectory Authorize the signed in user against Azure Active Directory. AzureContainerRegistry Pull the Gitea container image, as it is located in Azure Container Registry. (www.)github.com Allows Gitea to mirror any repo on GitHub"},{"location":"tre-templates/shared-services/nexus/","title":"Nexus Shared Service","text":"<p>Sonatype Nexus (RepoManager) allows users in workspaces to access external software packages securely.</p> <p>Documentation on Nexus can be found here: https://help.sonatype.com/repomanager3/.</p>"},{"location":"tre-templates/shared-services/nexus/#deploy","title":"Deploy","text":"<p>To deploy this service use the UI or API directly and choose the nexus template.</p> <p>Nexus will be deployed as part of the main TRE terraform deployment. A configuration script needs to be run once the deployment is done. The script will:</p> <ol> <li>Fetch the Nexus generated password from storage account.</li> <li>Reset the default password and set a new one.</li> <li>Store the new password in Key Vault under <code>nexus-&lt;TRE_ID&gt;-admin-password</code></li> <li>Create an anonymous default PyPI proxy repository</li> </ol>"},{"location":"tre-templates/shared-services/nexus/#setup-and-usage","title":"Setup and usage","text":"<ol> <li>A TRE Administrator can access Nexus though the admin jumpbox provisioned as part of the TRE deployment. The username is <code>adminuser</code> and the password is located in the KeyVault under <code>vm-&lt;tre-id&gt;-jumpbox-password</code></li> <li>A researcher can access Nexus from within the workspace by using the internal Nexus URL of: https://nexus-.azurewebsites.net/ <li>To fetch Python packages from the PyPI proxy, a researcher can use pip install while specifying the proxy server:<pre><code>pip install packagename --index-url https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/apt-pypi/simple\n</code></pre> </li>"},{"location":"tre-templates/shared-services/nexus/#network-requirements","title":"Network requirements","text":"<p>Nexus Shared Service requires access to resources outside of the Azure TRE VNET. These are set as part of the firewall provisioning pipeline via explicit allow on Service Tags or URLs. Notice that since Nexus Shared Service is running on an App Service, the outgoing exceptions are made for the calls coming out of the Web App Subnet.</p> Service Tag / Destination Justification AzureActiveDirectory Authorize the signed in user against Azure Active Directory. AzureContainerRegistry Pull the Nexus container image, as it is located in Azure Container Registry. pypi.org Enables Nexus to \"proxy\" python packages to use inside of workspaces. repo.anaconda.com Enables Nexus to \"proxy\" conda packages to use inside of workspaces. conda.anaconda.org Enables Nexus to \"proxy\" additional conda packages to use inside of workspaces such as conda-forge. *.docker.com Enables Nexus to \"proxy\" docker repos to use inside of workspaces. *.docker.io Enables Nexus to \"proxy\" docker repos to use inside of workspaces. archive.ubuntu.com Enables Nexus to \"proxy\" apt packages to use inside of workspaces. security.ubuntu.com Enables Nexus to \"proxy\" apt packages to use inside of workspaces."},{"location":"tre-templates/shared-services/nexus/#current-repos","title":"Current Repos","text":"Name Type Source URI Nexus URI Usage PiPy PiPy [https://pypi.org/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/pypi/</code> Allow use of pip commands. Apt PiPy Apt [https://pypi.org/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/apt-pypi/</code> Install pip via apt on Linux systems. Conda conda [https://repo.anaconda.com/pkgs/main/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/conda/</code> Configure conda to have access to default conda packages. Conda-Forge conda [https://conda.anaconda.org/conda-forge/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/conda-forge/</code> Configure conda to have access to conda-forge packages. Docker apt [https://download.docker.com/linux/ubuntu/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/docker/</code> Install Docker via apt on Linux systems. Docker GPG raw [https://download.docker.com/linux/ubuntu/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/docker-public-key/</code> Provide public key to sign apt source for above Docker apt. Docker Hub docker [https://registry-1.docker.io] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/docker-hub/</code> Provide docker access to public images repo. Ubuntu Packages apt [http://archive.ubuntu.com/ubuntu/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/ubuntu/</code> Provide access to Ubuntu apt packages on Ubuntu systems. Ubuntu Security Packages apt [http://security.ubuntu.com/ubuntu/] <code>https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/ubuntu-security/</code> Provide access to Ubuntu Security apt packages on Ubuntu systems."},{"location":"tre-templates/user-resources/guacamole-linux-vm/","title":"Guacamole User Resource Service bundle (Linux)","text":"<p>This is a User Resource Service template. It defines a Linux-based VM to be used by TRE researchers and to be connected to using a Guacamole server. It blocks all inbound and outbound traffic to the internet and allows only RDP connections from within the vnet.</p>"},{"location":"tre-templates/user-resources/guacamole-linux-vm/#prerequisites","title":"Prerequisites","text":"<ul> <li>A base workspace bundle installed</li> <li>A guacamole workspace service bundle installed</li> </ul>"},{"location":"tre-templates/user-resources/guacamole-windows-vm/","title":"Guacamole User Resource Service bundle (Windows)","text":"<p>This is a User Resource Service template. It defines a Windows 10/Server 2019 VM to be used by TRE researchers and to be connected to using a Guacamole server. It blocks all inbound and outbound traffic to the internet and allows only RDP connections from within the vnet.</p>"},{"location":"tre-templates/user-resources/guacamole-windows-vm/#prerequisites","title":"Prerequisites","text":"<ul> <li>A base workspace bundle installed</li> <li>A guacamole workspace service bundle installed</li> </ul>"},{"location":"tre-templates/workspace-services/azure-ml/","title":"Azure Machine Learning Service bundle","text":"<p>See: https://azure.microsoft.com/services/machine-learning/</p> <p>This service installs the following resources into an existing virtual network within the workspace:</p> <p></p> <p>Any users with the role of <code>Workspace Researcher</code> will be assigned the <code>AzureML Data Scientist</code> role within the AML workspace.</p>"},{"location":"tre-templates/workspace-services/azure-ml/#properties","title":"Properties","text":"<ul> <li><code>display_name</code> - The name of the Azure Machine Learning workspace.</li> <li><code>description</code> - The description of the Azure Machine Learning workspace.</li> <li><code>is_exposed_externally</code> - If <code>True</code>, the Azure Machine Learning workspace is accessible from outside of the worksapce virtual network.</li> </ul>"},{"location":"tre-templates/workspace-services/azure-ml/#firewall-rules","title":"Firewall Rules","text":"<p>Please be aware that the following outbound Firewall rules are opened for the workspace when this service is deployed, including to Azure Storage. This does open the possibility to extract data from a workspace if the user is determined to do so. Work is ongoing to remove some of these requirements:</p> <p>Service Tags: - AzureActiveDirectory - AzureResourceManager - AzureMachineLearning\" - Storage.<code>{AzureRegion}</code> - MicrosoftContainerRegistry</p> <p>URLs: - aadcdn.msftauth.net - ml.azure.com</p>"},{"location":"tre-templates/workspace-services/azure-ml/#prerequisites","title":"Prerequisites","text":"<ul> <li>A base workspace bundle installed</li> </ul>"},{"location":"tre-templates/workspace-services/gitea/","title":"Gitea Workspace Service","text":"<p>See: https://gitea.io/</p>"},{"location":"tre-templates/workspace-services/gitea/#firewall-rules","title":"Firewall Rules","text":"<p>The Gitea worskpace service needs outbound access to:</p> <ul> <li>AzureActiveDirectory</li> <li>Azure AD CDN - <code>https://aadcdn.msftauth.net</code></li> </ul>"},{"location":"tre-templates/workspace-services/gitea/#prerequisites","title":"Prerequisites","text":"<ul> <li>A base workspace deployed</li> </ul> <ul> <li> <p>The Gitea workspace service container image needs building and pushing:</p> <p><code>make build-gitea-workspace-service-image push-gitea-workspace-service-image</code></p> </li> </ul>"},{"location":"tre-templates/workspace-services/gitea/#gitea-workspace-service-configuration","title":"Gitea Workspace Service Configuration","text":"<p>When deploying a Gitea Workspace service the following properties need to be configured.</p> Property Description <code>openid_client_id</code> Valid client ID of the Workspace App Registration. <code>openid_client_secret</code> Valid client secret of the Workspace App Registration. <code>openid_authority</code> Valid authority of the OpenID service, such as <code>https://login.microsoftonline.com/{tenant_id}/v2.0</code> <p>Once the service is deployed a redirect URL will need adding to the Azure AD app registration in the format: <code>https://&lt;gitea_url&gt;/user/oauth2/oidc/callback</code></p>"},{"location":"tre-templates/workspace-services/gitea/#authenticating-to-gitea-and-setting-up-a-local-username-and-password","title":"Authenticating to Gitea and setting up a local username and password","text":"<ol> <li>Navigate to the Gitea workspace service and from the menu click the <code>Sign in</code> button.</li> <li>Click sign in with OpenID button and sign in with the same credentials used to access the workspace.</li> <li>Once succesfully signed in choose a username.</li> <li>Navigate to the user settings and under the account tab set a password for your account( <code>https://&lt;gitea_url&gt;/user/settings/account</code> ). This username and passowrd should be used to authenticate against Gitea when carrying out git operations.</li> </ol>"},{"location":"tre-templates/workspace-services/guacamole/","title":"Guacamole Service bundle","text":"<p>See: https://guacamole.apache.org/</p>"},{"location":"tre-templates/workspace-services/guacamole/#firewall-rules","title":"Firewall Rules","text":"<p>Please be aware that the following Firewall rules are opened for the workspace when this service is deployed:</p> <p>Service Tags:</p> <ul> <li>AzureActiveDirectory</li> </ul>"},{"location":"tre-templates/workspace-services/guacamole/#prerequisites","title":"Prerequisites","text":"<ul> <li>A base workspace bundle installed</li> </ul>"},{"location":"tre-templates/workspace-services/guacamole/#guacamole-workspace-service-configuration","title":"Guacamole Workspace Service Configuration","text":"<p>When deploying a Guacamole service into a workspace the following properties need to be configured.</p>"},{"location":"tre-templates/workspace-services/guacamole/#optional-properties","title":"Optional Properties","text":"Property Options Description <code>guac_disable_copy</code> <code>true</code>/<code>false</code> (Default: <code>true</code>) Disable Copy functionality <code>guac_disable_paste</code> <code>true</code>/<code>false</code> (Default: <code>false</code>) Disable Paste functionality\" <code>guac_enable_drive</code> <code>true</code>/<code>false</code> (Default: <code>true</code>) Enable mounted drive <code>guac_disable_download</code> <code>true</code>/<code>false</code> (Default: <code>true</code>) Disable files download <code>is_exposed_externally</code> <code>true</code>/<code>false</code> (Default: <code>true</code>) Is the Guacamole service exposed outside of the vnet"},{"location":"tre-templates/workspace-services/inner-eye/","title":"InnerEye DeepLearning Service Bundle","text":"<ul> <li>Azure ML</li> </ul> <p>See: https://github.com/microsoft/InnerEye-DeepLearning</p>"},{"location":"tre-templates/workspace-services/inner-eye/#firewall-rules","title":"Firewall Rules","text":"<p>Please be aware that the following Firewall rules are opened for the workspace when this service is deployed. These are all dependencies needed by InnerEye to be able to develop and train models:</p> <p>URLs:</p> <ul> <li>*.anaconda.com</li> <li>*.anaconda.org</li> <li>binstar-cio-packages-prod.s3.amazonaws.com</li> <li>*pythonhosted.org</li> <li>github-cloud.githubusercontent.com</li> <li>azure.archive.ubuntu.com (git lfs package)</li> <li>packagecloud.io (git lfs package installation script)</li> </ul>"},{"location":"tre-templates/workspace-services/inner-eye/#initial-setup","title":"Initial setup","text":"<p>Provision an InnerEye workspace by invoking a POST to <code>https://&lt;treid&gt;.&lt;region&gt;.cloudapp.azure.com/api/workspaces</code> with the following payload:</p> <pre><code>    {\n\"templateName\": \"tre-workspace-innereye\",\n\"properties\": {\n\"display_name\": \"InnerEye\",\n\"description\": \"InnerEyer workspace\",\n\"client_id\": \"&lt;WORKSPACE_API_CLIENT_ID&gt;\",\n\"inference_sp_client_id\": \"&lt;spn_client_id&gt;\",\n\"inference_sp_client_secret\": \"&lt;spn_client_secret&gt;\"\n}\n}\n</code></pre> <p>This will provision Base Workspace, with AML service and InnerEye service, including InnerEye Inference web app.</p>"},{"location":"tre-templates/workspace-services/inner-eye/#running-the-innereye-helloworld","title":"Running the InnerEye HelloWorld","text":""},{"location":"tre-templates/workspace-services/inner-eye/#preparation-steps-performed-by-the-tre-admin","title":"Preparation steps performed by the TRE Admin","text":"<ol> <li>Ensure that you have completed \"Configuring Shared Services\"</li> <li>Log onto a TREAdmin Jumpbox and mirror Github repos needed by InnerEye Helloworld:<pre><code>./templates/workspace_services/gitea/gitea_migrate_repo.sh -t &lt;tre_id&gt; -g https://github.com/microsoft/InnerEye-DeepLearning\n./templates/workspace_services/gitea/gitea_migrate_repo.sh -t &lt;tre_id&gt; -g https://github.com/analysiscenter/radio\n./templates/workspace_services/gitea/gitea_migrate_repo.sh -t &lt;tre_id&gt; -g https://github.com/microsoft/InnerEye-Inference\n</code></pre> </li> </ol>"},{"location":"tre-templates/workspace-services/inner-eye/#setup-the-innereye-run-from-aml-compute-instance","title":"Setup the InnerEye run from AML Compute Instance","text":"<ol> <li>Log onto a VM in the workspace</li> <li>In the VM open your browser and navigate to ml.azure.com, login, select the right Subscription and AML workspace.</li> <li>Select the Notebooks tab and then click Terminal. This will open a terminal on a running compute instance</li> <li> <p>Pull the InnerEye-DeepLearning git repo from Gitea mirror and configure:</p> <pre><code>git clone https://gitea-&lt;TRE_ID&gt;.azurewebsites.net/giteaadmin/InnerEye-DeepLearning\ncd InnerEye-DeepLearning\ncurl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash\nsudo apt-get install git-lfs\ngit lfs install\ngit lfs pull\nexport PIP_INDEX_URL=https://nexus-&lt;TRE_ID&gt;.azurewebsites.net/repository/apt-pypi/simple\nconda init\nconda env create --file environment.yml\nconda activate InnerEye\n</code></pre> </li> <li> <p>Login to AzureCLI and set default subscription if needed</p> <pre><code>az login\naz account set --subscription \n</code></pre> </li> <li> <p>Create a \"datasets\" container</p> <p><code>az storage container create --name datasets --account-name stgws&lt;workspace_id&gt;</code> 1. Copy <code>dataset.csv</code> file from <code>Tests/ML/test_data/dataset.csv</code> to the <code>hello_world</code> folder:</p> <p><code>az storage blob upload --account-name stgws&lt;workspace_id&gt; --container-name datasets --file ./Tests/ML/test_data/dataset.csv --name hello_world/dataset.csv</code> 1. Copy the whole <code>train_and_test_data</code> folder from <code>Test/ML/test_data/train_and_test_data</code> to the <code>hello_world</code> folder:</p> <p><code>az storage blob directory upload -c datasets --account-name stgws&lt;workspace_id&gt; -s \"./Tests/ML/test_data/train_and_test_data\" -d hello_world --recursive</code></p> </li> <li> <p>Get storage keys for your storage:</p> <p><code>az storage account keys list --account-name stgws&lt;workspace_id&gt;</code></p> </li> <li> <p>Update the following variables in <code>InnerEye/settings.yml</code>: subscription_id, resource_group, workspace_name, cluster (see AML setup for more details).</p> </li> <li>Navigate to <code>Data stores</code> in AML Workspace. Create a New datastore named <code>innereyedatasets</code> and link it to your storage account and datasets container. Use the key collected from the step above.</li> <li> <p>Back from the Terminal run</p> <pre><code>python InnerEye/ML/runner.py --model=HelloWorld --azureml=True\n</code></pre> </li> <li> <p>The runner will provide you with a link and ask you to open it to login. Copy the link and open it in browser (Edge) on the DSVM and login. The run will continue after login.</p> </li> <li>In your browser navigate to https://ml.azure.com and open the <code>Experiments</code> tab to follow the progress of the training</li> </ol>"},{"location":"tre-templates/workspace-services/inner-eye/#configuring-and-testing-inference-service","title":"Configuring and testing inference service","text":"<p>The workspace service provisions an App Service Plan and an App Service for hosting the inference webapp. The webapp will be integrated into the workspace network, allowing the webapp to connect to the AML workspace. Following the setup you will need to:</p> <ol> <li> <p>Log onto a VM in the workspace and run:</p> <pre><code>git clone https://gitea-&lt;TRE_ID&gt;.azurewebsites.net/giteaadmin/InnerEye-Inference\ncd InnerEye-Inference\n</code></pre> </li> <li> <p>Create a file named \"set_environment.sh\" with the following variables as content:</p> <pre><code>#!/bin/bash\nexport CUSTOMCONNSTR_AZUREML_SERVICE_PRINCIPAL_SECRET=&lt;inference_sp_client_secret-from-above&gt;\nexport CUSTOMCONNSTR_API_AUTH_SECRET=&lt;generate-a-random-guid--that-is-used-for-authentication&gt;\nexport CLUSTER=&lt;name-of-compute-cluster&gt;\nexport WORKSPACE_NAME=&lt;name-of-AML-workspace&gt;\nexport EXPERIMENT_NAME=&lt;name-of-AML-experiment&gt;\nexport RESOURCE_GROUP=&lt;name-of-resource-group&gt;\nexport SUBSCRIPTION_ID=&lt;subscription-id&gt;\nexport APPLICATION_ID=&lt;inference_sp_client_id-from-above&gt;\nexport TENANT_ID=&lt;tenant-id&gt;\nexport DATASTORE_NAME=inferencedatastore\nexport IMAGE_DATA_FOLDER=imagedata\n</code></pre> </li> <li> <p>Upload the configuration file to the web app:</p> <pre><code>az webapp up --name &lt;inference-app-name&gt; -g &lt;resource-group-name&gt;\n</code></pre> </li> <li> <p>Create a new container in your storage account for storing inference images called <code>inferencedatastore</code>.</p> </li> <li>Create a new folder in that container called <code>imagedata</code>.</li> <li>Navigate to the ml.azure.com, <code>Datastores</code> and create a new datastore named <code>inferencedatastore</code> and connect it to the newly created container.</li> <li> <p>Test the service by sending a GET or POST command using curl or Invoke-WebRequest where API_AUTH_SECRET is the random GUID generated for CUSTOMCONNSTR_API_AUTH_SECRET above:</p> <p>Simple ping:</p> <pre><code>Invoke-WebRequest https://yourservicename.azurewebsites.net/v1/ping -Headers @{'Accept' = 'application/json'; 'API_AUTH_SECRET' = 'your-secret-1234-1123445'}\n</code></pre> <p>Test connection with AML:</p> <pre><code>Invoke-WebRequest https://yourservicename.azurewebsites.net/v1/model/start/HelloWorld:1 -Method POST -Headers @{'Accept' = 'application/json'; 'API_AUTH_SECRET' = 'your-secret-1234-1123445'}\n</code></pre> </li> </ol>"},{"location":"tre-templates/workspace-services/mlflow/","title":"MLflow Workspace Service","text":"<p>See: https://www.mlflow.org</p>"},{"location":"tre-templates/workspace-services/mlflow/#prerequisites","title":"Prerequisites","text":"<ul> <li>A base workspace deployed</li> </ul>"},{"location":"tre-templates/workspace-services/mlflow/#mlflow-workspace-vm-configuration","title":"MLflow Workspace VM Configuration","text":"<p>Each MLflow server deployment creates a PowerShell (for Windows) and a shell script (for Linux) with the same name as the MLflow server, in the shared storage mounted on the researcher VMs. These scripts will configure the researcher VMs (by installing the required packages and setting up the environment variables) to communicate with the MLflow tracking server.</p> <p>Note</p> <p>Please ensure that nexus reposiory is configured before running the above scripts.</p>"},{"location":"tre-templates/workspace-services/mlflow/#mlflow-set-tracking-uri","title":"MLflow set tracking URI","text":"<p>Researchers will be required to set the remote tracking URI in their scripts</p> <pre><code>remote_server_uri = \"https://xxxxxxx.azurewebsites.net/\"\n\nmlflow.set_tracking_uri(remote_server_uri)\n</code></pre>"},{"location":"tre-templates/workspace-services/mlflow/#using-with-conda-forge","title":"Using with Conda-Forge","text":"<p>If working with Conda-Forge you need to ensure the user resource you are using is configured correctly and using the channels available via the Nexus repository. If the user resource you have deployed used one of the pre-existing Guacamole user resource templates and has conda installed by default, conda will already be configured to use the correct channels via Nexus. If not and conda has been manually deployed on the user resource, the following script can be used to configure conda:</p> <pre><code>  conda config --add channels ${nexus_proxy_url}/repository/conda/  --system\n  conda config --add channels ${nexus_proxy_url}/repository/conda-forge/  --system\n  conda config --remove channels defaults --system\n  conda config --set channel_alias ${nexus_proxy_url}/repository/conda/  --system\n</code></pre>"},{"location":"tre-templates/workspace-services/mlflow/#condayml","title":"conda.yml","text":"<p>When using a <code>conda.yml</code> file to configure your MLFlow environment it is required to specify the channels to use. As the traditional channels (conda-forge, defaults etc) have been replaced with Nexus channels, you must ensure that the Nexus channels are being specified here instead. To retireve these channels, run <code>conda config --show channels</code> once conda has been configured to use Nexus.</p> <p>Note</p> <p>When logging models using sklearn, an optional parameter <code>conda_env</code> can be passed as either JSON or YML.  If this is not passed a default <code>conda.yml</code> will be generate for the model, targeting the channel <code>conda-forge</code> causing any subsequent environments created using the model to fail.   See the official documentation here for the full details.</p>"},{"location":"tre-templates/workspaces/airlock_manager/","title":"Airlock Manager workspace","text":"<p>NOTE: This feature is still in active development. More documentation will be added as the development progresses.</p> <p>Airlock Manager workspace is used as part of Review workflow for Airlock. It allows to review Airlock Data Import requests from, by providing a workspace to spin up VMs in that then can access the in-progress storage account.</p> <p>The workspace is built upon the base workspace template. It adds a private endpoint to connect to import in-progress storage account, adds corresponding roles, and disables shared storage for VMs.</p>"},{"location":"tre-templates/workspaces/base/","title":"Azure TRE base workspace","text":"<p>The base workspace template is the foundation that all other workspaces and workspace services are built upon. Alternative workspace architectures could be used. However, the templates provided in this repository rely on the specific architecture of this base workspace.</p> <p>The base workspace template contains the following resources:</p> <ul> <li>Virtual Network</li> <li>Storage Account</li> <li>Key Vault</li> <li>VNet Peer to Core VNet</li> <li>Network Security Group</li> <li>App Service Plan</li> </ul>"},{"location":"tre-templates/workspaces/base/#workspace-configuration","title":"Workspace Configuration","text":"<p>When deploying a workspace the following properties need to be configured.</p>"},{"location":"tre-templates/workspaces/base/#required-properties","title":"Required Properties","text":"Property Options Description <code>client_id</code> Valid client ID of the Workspace App Registration. The OpenID client ID which should be submitted to the OpenID service when necessary. This value is typically provided to you by the OpenID service when OpenID credentials are generated for your application. <code>client_secret</code> Valid client secret."},{"location":"tre-templates/workspaces/base/#azure-trusted-services","title":"Azure Trusted Services","text":"<p>Azure Trusted Services are allowed to connect to both the key vault and storage account provsioned within the workspace. If this is undesirable additonal resources without this setting configured can be deployed.</p> <p>Further details around which Azure services are allowed to connect can be found below:</p> <ul> <li>Key Vault: https://docs.microsoft.com/en-us/azure/key-vault/general/overview-vnet-service-endpoints#trusted-services</li> <li>Azure Storage: https://docs.microsoft.com/en-us/azure/storage/common/storage-network-security?msclkid=ee4e79e4b97911eca46dae54da464d11&amp;tabs=azure-portal#trusted-access-for-resources-registered-in-your-subscription</li> </ul>"},{"location":"tre-templates/workspaces/unrestricted/","title":"Unrestricted workspace","text":"<p>The unrestricted workspace template is a workspace template that allows for unrestricted access to the Internet from inside the workspace virtual network. This is useful for working on open data sets where data exfiltration is not a concern.</p> <p>This workspace template builds upon the base workspace template by adding additional firewall rules and disabling the airlock.</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/","title":"Authoring workspaces templates","text":"<p>Azure TRE workspaces, workspace services, and user resources are Porter bundles. Porter bundles are based on Cloud Native Application Bundles (CNAB).</p> <p>Workspace authors are free to choose the technology stack for provisioning resources (e.g., ARM templates, Terraform etc.), but the Azure TRE framework sets certain requirements for the bundle manifests, which specify the credentials, input and output parameters, deployment actions among other things.</p> <p>This document describes the requirements, and the process to author a template.</p> <p>Tip</p> <p>Use the base workspace bundle as reference or as the basis for the new bundle.</p> <p>To create a bundle from scratch follow the Porter Quickstart Guide (<code>porter create</code> CLI command will generate a new bundle in the current directory).</p> <p>Read more about Porter in Resource Processor doc.</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#prerequisites","title":"Prerequisites","text":"<ul> <li>Docker installed</li> <li>Porter installed</li> <li>Azure TRE instance deployed to test against</li> </ul>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#workspace-bundle-manifest","title":"Workspace bundle manifest","text":"<p>The manifest of a workspace bundle is the <code>porter.yaml</code> file (see Author Bundles in Porter documentation). This section describes the mandatory credentials, input and output parameters of a TRE workspace bundle.</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#credentials","title":"Credentials","text":"<p>A workspace bundle requires the following credentials to provision resources in Azure:</p> <ul> <li>Azure tenant ID</li> <li>Azure subscription ID</li> <li>The client ID of a service principal with privileges to provision resources</li> <li>The client secret (password) of a service principal</li> </ul> <p>The credentials are provided as environment variables by the deployment runner. The bundle author must use the following environment variable names:</p> <pre><code>ARM_TENANT_ID\nARM_SUBSCRIPTION_ID\nARM_CLIENT_ID\nARM_CLIENT_SECRET\n</code></pre> <p>The names of the Porter credentials (<code>name</code> field in <code>porter.yaml</code>) can be freely chosen by the author.</p> <p>Example:</p> <pre><code>credentials:\n- name: azure_tenant_id\nenv: ARM_TENANT_ID\n- name: azure_subscription_id\nenv: ARM_SUBSCRIPTION_ID\n- name: azure_client_id\nenv: ARM_CLIENT_ID\n- name: azure_client_secret\nenv: ARM_CLIENT_SECRET\n</code></pre>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#parameters","title":"Parameters","text":"<p>This section describes the mandatory (input) parameters of a workspace bundle manifest.</p> Parameter Type Description Example value <code>tre_id</code> string Unique ID of for the TRE instance. <code>tre-dev-42</code> <code>workspace_id</code> string Unique 4-character long, alphanumeric workspace ID. <code>0a9e</code> <code>azure_location</code> string Azure location (region) to deploy the workspace resource to. <code>westeurope</code> <code>address_space</code> string VNet address space for the workspace services. <code>10.2.1.0/24</code> <p><code>tre_id</code> can be found in the resource names of the Azure TRE instance; for example the resource group name of the Azure TRE instance based on the example in the above table would be \"<code>rg-tre-dev-42</code>\".</p> <p>Similarly to <code>tre_id</code>, <code>workspace_id</code> is used in the resource names of the workspace. The resource group name of the workspace must be of form \"<code>rg-&lt;tre_id&gt;-ws-&lt;workspace_id&gt;</code>\", for example: \"<code>rg-tre-dev-42-ws-0a9e</code>\".</p> <p>All the values for the required parameters will be provided by the deployment runner.</p> <p>Any custom parameters are picked up by Azure TRE API and will be queried from the user deploying the workspace bundle. Custom parameters should also be defined in the <code>template_schema.json</code> file at the root of the bundle. This file follows the JSON schema standard and can be used by a user interface to generate a UI for the user to input the parameters.</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#output","title":"Output","text":"<p>Todo</p> <p>After a workspace with virtual machines is implemented this section can be written based on that. (Outputs in Porter documentation to be linked here too.)</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#actions","title":"Actions","text":"<p>The required actions are the main two of CNAB spec:</p> <ul> <li><code>install</code> - Deploys/repairs the workspace Azure resources, and must be idempotent</li> <li><code>uninstall</code> - Tears down (deletes) the Azure resources of the workspace and its services</li> </ul>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#workspace-service-bundle-manifests","title":"Workspace service bundle manifests","text":"<p>Workspace service bundles are generated in the same way as workspace bundles.</p> <p>The mandatory parameters for workspace services are:</p> Parameter Type Description Example value <code>tre_id</code> string Unique ID of for the TRE instance. <code>tre-dev-42</code> <code>workspace_id</code> string Unique 4-character long, alphanumeric workspace ID. <code>0a9e</code>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#user-resource-bundle-manifests","title":"User resource bundle manifests","text":"<p>User Resource bundles are generated in the same way as workspace bundles and workspace services bundles. The main difference is that a workspace service type needs to be supplied when registering a user resource template, as it only applies to a given workspace service.</p> <p>The mandatory parameters for User Resources are:</p> Parameter Type Description Example value <code>tre_id</code> string Unique ID of for the TRE instance. <code>tre-dev-42</code> <code>workspace_id</code> string Unique 4-character long, alphanumeric workspace ID. <code>0a9e</code>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#azure-resources-tagging","title":"Azure Resources Tagging","text":"<p>TRE Cost Reporting is based on Azure tagging to be able to generate cost report for core services, shared services, workspace, workspace services and user resources. Templates authors need to make sure that underling Azure resources are tagged with the relevent tags, for more information see cost reporting:</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#versioning","title":"Versioning","text":"<p>Workspace versions are the bundle versions specified in the metadata. The bundle versions should match the image tags in the container registry (see Publishing workspace bundle).</p> <p>TRE does not provide means to update an existing workspace to a newer version. Instead, the user has to first uninstall the old version and then install the new one. The CNAB upgrade or a Porter custom (\"<code>update</code>\") action may be used in the future version of TRE to do this automatically.</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#publishing-workspace-bundle","title":"Publishing workspace bundle","text":"<p>See Registering workspace templates.</p>"},{"location":"tre-workspace-authors/authoring-workspace-templates/#manual-deployment","title":"Manual Deployment","text":"<p>Caution</p> <p>Resources should be deployed using the API (i.e. through the Swagger UI as described in the setup instructions). Only deploy manually for development/testing purposes.</p> <ol> <li> <p>Create a copy of the Porter bundle's environment settings from <code>/templates/&lt;scope&gt;/.env.sample</code> with the name <code>.env</code> and update the variables with the appropriate values.</p> </li> <li> <p>Build and deploy the Porter bundle</p> <pre><code>make bundle-build DIR=./templates/&lt;scope&gt;/&lt;bundle_name&gt;\nmake bundle-install DIR=./templates/&lt;scope&gt;/&lt;bundle_name&gt;\n</code></pre> </li> </ol>"},{"location":"tre-workspace-authors/firewall-rules/","title":"Adding Firewall Rules as part of a workspace or service deployment","text":"<p>Note</p> <p>Creating firewall rules will in the future only be allowed through the firewall shared services #882.</p> <p>A TRE service may require certain firewall rules to be opened in the TRE firewall. Examples include:</p> <ul> <li>Access to an external authorisation endpoint</li> <li>Access to an external data store</li> <li>Access to an external API</li> </ul> <p>Please be aware when opening firewall rules there is the potential for data to be leaked from the workspace to the external location.</p>"},{"location":"tre-workspace-authors/firewall-rules/#using-terraform-to-open-firewall-rules","title":"Using Terraform to open firewall rules","text":"<p>Until a mechanism to update shared services has been implemented, firewall rule updates should be done using terraform as part of the service deployment. The aim is to create a firewall rule that grants access from the workspace's address space to the external location. A challenge with this is that the rule must use a priority that has not been used by any other rule.</p> <ol> <li> <p>Create a <code>firewall.tf</code> file in the <code>terraform</code> directory of the workspace.</p> </li> <li> <p>Add the following code to the <code>firewall.tf</code> file to enable the TRE firewall and workspace network to be referenced:</p> <pre><code>data \"azurerm_firewall\" \"fw\" {\nname                = \"fw-${var.tre_id}\"\nresource_group_name = \"rg-${var.tre_id}\"\n}\n\ndata \"azurerm_virtual_network\" \"ws\" {\nname                = \"vnet-${var.tre_id}-ws-${var.workspace_id}\"\nresource_group_name = data.azurerm_resource_group.ws.name\n}\n</code></pre> </li> <li> <p>Define a local variable that contains the locations that access should be allowed to, and the naming format for the service resources for example:</p> <pre><code>locals {\nallowed_urls                     = [\"*.anaconda.com\", \"*.anaconda.org\"]\nservice_resource_name_suffix    = \"${var.tre_id}-ws-${var.workspace_id}-svc-${local.service_id}\"\n}\n</code></pre> </li> <li> <p>Log into the Azure CLI using service principal details:</p> <pre><code>resource \"null_resource\" \"az_login\" {\nprovisioner \"local-exec\" {\ncommand = \"az login --identity -u '${var.arm_client_id}'\"\n}\n\ntriggers = {\ntimestamp = timestamp()\n}\n}\n</code></pre> </li> <li> <p>Call the <code>get_firewall_priorities.sh</code> script to find the next available priority:</p> <pre><code>data \"external\" \"rule_priorities\" {\nprogram = [\"bash\", \"-c\", \"./get_firewall_priorities.sh\"]\n\nquery = {\nfirewall_name       = data.azurerm_firewall.fw.name\nresource_group_name = data.azurerm_firewall.fw.resource_group_name\nservice_resource_name_suffix = local.service_resource_name_suffix\n}\ndepends_on = [\nnull_resource.az_login\n]\n}\n</code></pre> </li> <li> <p>Save the <code>get_firewall_priorities.sh</code> script as a file in the <code>terraform</code> directory:</p> <pre><code>#!/bin/bash\n\nset -e\n\neval \"$(jq -r '@sh \"firewall_name=\\(.firewall_name) resource_group_name=\\(.resource_group_name) service_resource_name_suffix=\\(.service_resource_name_suffix)\"')\"\n\nif NETWORK_RULES=$(az network firewall network-rule list -g $resource_group_name -f  $firewall_name --collection-name \"nrc-$service_resource_name_suffix\" -o json); then\nNETWORK_RULE_PRIORITY=$(echo $NETWORK_RULES | jq '.priority')\nelse\nNETWORK_RULE_MAX_PRIORITY=$(az network firewall network-rule collection list -f $firewall_name -g $resource_group_name -o json --query 'not_null(max_by([],&amp;priority).priority) || `100`')\nNETWORK_RULE_PRIORITY=$(($NETWORK_RULE_MAX_PRIORITY+1))\nfi\n\nif APPLICATION_RULES=$(az network firewall application-rule list -g $resource_group_name -f  $firewall_name --collection-name \"arc-$service_resource_name_suffix\" -o json); then\nAPPLICATION_RULE_PRIORITY=$(echo $APPLICATION_RULES | jq '.priority')\nelse\nAPPLICATION_RULE_MAX_PRIORITY=$(az network firewall application-rule collection list -f $firewall_name -g $resource_group_name -o json --query 'not_null(max_by([],&amp;priority).priority) || `100`')\nAPPLICATION_RULE_PRIORITY=$(($APPLICATION_RULE_MAX_PRIORITY+1))\nfi\n\n# Safely produce a JSON object containing the result value.\njq -n --arg network_rule_priority \"$NETWORK_RULE_PRIORITY\" --arg application_rule_priority \"$APPLICATION_RULE_PRIORITY\" '{ \"network_rule_priority\":$network_rule_priority, \"application_rule_priority\":$application_rule_priority }'\n</code></pre> </li> <li> <p>Create the firewall rule using a resource similar to the below:</p> <pre><code>resource \"azurerm_firewall_application_rule_collection\" \"apprulecollection\" {\nname                = \"arc-${local.service_resource_name_suffix}\"\nazure_firewall_name = data.azurerm_firewall.fw.name\nresource_group_name = data.azurerm_firewall.fw.resource_group_name\npriority            = data.external.rule_priorities.result.application_rule_priority\naction              = \"Allow\"\n\nrule {\nname = \"allowServiceXRules\"\n\nsource_addresses = data.azurerm_virtual_network.ws.address_space\n\ntarget_fqdns = local.allowed_urls\n\nprotocol {\nport = \"443\"\ntype = \"Https\"\n}\nprotocol {\nport = \"80\"\ntype = \"Http\"\n}\n}\n}\n</code></pre> </li> </ol>"},{"location":"troubleshooting-faq/","title":"Operations Debugging and Troubleshooting guide","text":"<p>This guide explains how to go about finding the root cause of why a workspace resource might not have been deployed.</p> <p>The topics included in this section should be followed in order as that is how the message also flows in the system.</p>"},{"location":"troubleshooting-faq/api-logs-deployment-center/","title":"API logs using deployment center","text":"<p>Check that the version you are debugging/troubleshooting is the same one deployed on the App Service.</p> <p>You can check this in Azure's Deployment Center, or follow the logs as generated by the container in the logs tabs.</p> <p></p>"},{"location":"troubleshooting-faq/app-insights-logs/","title":"Checking the logs in App Insights","text":"<p>Every component of TRE should send their trace logs to App Insights logging backend, and you should be able to see the process flow by using a suitable query.</p> <p>Note</p> <p>AppTraces can take time to appear so be patient.</p> <p>Go to the deployed app insights instance and select Monitoring &gt; Logs where you can run the following example query to get the logs for a specific deployment.</p> <pre><code>let tracking_id=\"&lt;workspace_id&gt;\";\nAppTraces\n| where Message has tracking_id or OperationId == tracking_id | sort by TimeGenerated desc\n</code></pre> <p></p> <p>For a successful deployment you should see a message similiar to:</p> <pre><code>Received deployment status update message with correlation ID 70b09db1-30c4-475c-b1a1-8f9599a5a2f4: {'id': '70b09db1-30c4-475c-b1a1-8f9599a5a2f4', 'status': 'deployed', 'message': 'cse-msr-dev-b7f6: Workspace was deployed successfully...'}\n</code></pre> <p>It should also be evident from the message flow where the current processing is stuck or failed. Failed deployment status should also be available in the <code>GET /api/workspaces/{workspace_id}</code> and this is just another way to confirm it.</p>"},{"location":"troubleshooting-faq/debug-api/","title":"Enabling DEBUG mode on the API","text":"<p>The API is by default configured to not show detailed error messages and stack trace when an error occurs. This is done to prevent leaking internal state to the outside world and to minimize information which an attacker could use against the deployed instance.</p> <p>However, you can enable debugging, by setting <code>DEBUG=true</code> in the configuration settings of the API using Azure portal.</p> <ol> <li>Go to App Service for the API and select Settings &gt; Configuration.</li> <li>Click New Application Setting.</li> <li>in the new dialog box set Name=DEBUG and Value=true</li> </ol>"},{"location":"troubleshooting-faq/troubleshooting-rp/","title":"Checking the Virtual Machine Scale Set (VMSS) instance running resource processor","text":"<p>If you see messages hanging in the service bus queue then the resource processor is not up and running.</p> <p>Verify that the VMSS instance is up and healthy.</p> <p></p> <p>The processor runs in a VNET, and you cannot connect to it directly.</p> <ol> <li> <p>Connect to the instance using Bastion. Bastion is already deployed, and you can use the username <code>adminuser</code>. The password is stored in the keyvault under the secret <code>resource-processor-vmss-password</code></p> <p>Info</p> <p>You cannot see secrets unless you are added to a suitable access policy for the Key Vault.</p> <p></p> <p></p> </li> <li> <p>After logging in you should check the status of cloud-init which is used to bootstrap the machine with docker and start the processor. Log files for cloud init are:</p> <ul> <li><code>/var/log/cloud-init.log</code></li> <li><code>/var/log/cloud-init-output.log</code></li> </ul> <p>If the Docker container is pulled as shown in logs then the resource processor should start.</p> </li> <li> <p>Check the status of the container using <code>docker ps</code></p> <p>If you see nothing (and the container was pulled) then the processor has either not started yet or it has crashed.</p> </li> <li> <p>Check the status of all Docker processes using <code>docker ps -a</code> which should show you if the container terminated prematurely.</p> </li> <li>Get the logs from the container using <code>docker logs &lt;container_id&gt;</code> command.</li> </ol> <p>To start a processor container manually:</p> <ol> <li>Find the runner_image:tag by running <code>docker ps</code></li> <li> <p>Execute the following command from the root (/) of the file system</p> <pre><code>docker run -v /var/run/docker.sock:/var/run/docker.sock --env-file .env --name resource_processor_vmss_porter_debug [runner_image:tag]\n</code></pre> </li> </ol> <p>Info</p> <p>All logs from the resource processor should also be transferred to the App Insights instance, so it is not necessary to follow the progress by logging into the instance. Logging into the instance and starting a container manually however, is helpful in live debugging.</p>"},{"location":"troubleshooting-faq/troubleshooting-rp/#updating-the-running-container","title":"Updating the running container","text":"<p>If you start a container manually you will probably want to install software, for example, an editor. However, the firewall blocks all ingress traffic, so you cannot run <code>sudo apt update</code>. You need to add an override rule in the firewall to allow the traffic.</p> <p>Caution</p> <p>Remember to remove this rule when debugging is done.</p>"},{"location":"troubleshooting-faq/troubleshooting-sb/","title":"Checking the Service Bus","text":"<p>If the message payload is accepted by the API, and a workspace_id is generated, you should be able to track the progress of the deployment using <code>GET /api/workspaces/{workspace_id}</code></p> <p>Initially the status is always reported as:</p> <pre><code>{\n\"deployment\": {\n\"status\": \"awaiting_deployment\",\n\"message\": \"This resource has not yet been deployed\"\n}\n}\n</code></pre> <p>This should eventually change as the message flows through the system.</p> <p>If the message remains at this stage, you should first verify that the message arrived in the service bus.</p> <p>In the Azure portal:</p> <ol> <li>Select the Service Bus from deployed resources and click Entities &gt; Queues &gt; workspacequeue.</li> <li>Select the Service Bus Explorer and the Peek tab to check for hanging messages.</li> </ol> <p></p>"},{"location":"using-tre/","title":"Using the Azure TRE","text":"<p>This documentation part will cover how to use AzureTRE, extend it with your custom images and deploy it.</p>"},{"location":"using-tre/#azuretre-deployment-repo","title":"AzureTRE deployment repo","text":"<p>AzureTRE has an OSS deployment repository which you can find here. It contains all the required tooling to develop your custom templates and deploy the Azure TRE:</p> <ul> <li>Github Actions implementing AzureTRE automation, including running deployments to Azure</li> <li>Configuration specific to deployment</li> <li>Directories setup for: workspace, workspace service and user resource template definitions</li> <li>Devcontainer setup</li> </ul>"},{"location":"using-tre/#azuretre-reference","title":"AzureTRE Reference","text":"<p>AzureTRE deployment repository allows you to reference AzureTRE as a folder, but also uses it in its deployment. See AzureTRE deployment readme to learn more about it.</p>"},{"location":"using-tre/#getting-started","title":"Getting Started","text":"<p>To get started with AzureTRE follow the next steps:</p> <ol> <li>Go to AzureTRE Deployment repository</li> <li>Click on use this template to set up your project from this template:</li> </ol> <p></p> <ol> <li>Follow the steps in this Github templates guide to set up the repo.</li> <li>Having the project setup in your account, follow the next steps and guides to setup and extend AzureTRE in your environment:     - Local Development     - Setup CI/CD pipelines     - Add your custom templates</li> </ol>"},{"location":"using-tre/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/faq/","title":"FAQ","text":"<p>Info</p> <p>Coming soon</p> <p>We're working to improve our documentation, and fill in some gaps. Unfortunately, this particular page is one of the gaps we're looking to fill and isn't yet available.</p>"},{"location":"using-tre/faq/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/terms-definitions/","title":"Terms and Definitions","text":"<p>Trusted Research Environments (TRE) enforce a secure boundary around distinct workspaces to enable information governance controls to be enforced.</p> <p></p> <p>A Trusted Research Environment (typically one per organization, or one per department in large organizations) consist of:</p> <ul> <li>One Composition Service (API, deployment engine etc. used to manage and deploy workspaces, workspace services and user resources)</li> <li>One set of Shared Services used by all workspaces</li> <li>A number of Workspaces, where each workspace is its own security boundary, and in turn contains Workspace Services and User Resources</li> </ul>"},{"location":"using-tre/terms-definitions/#the-composition-service","title":"The Composition Service","text":"<p>The Composition Service offers an abstraction over the lower-level Azure resources to allow for TRE users to provision resources in terms of workspaces and workspace services.</p> <p>The Composition Service reconciles the desired state with the actual state by invoking Azure resource deployments.</p> <p>The composition service is fronted by an API that helps the TRE Admin, TRE Workspace Owners and TRE Researchers create and manage the workspaces and workspace services.</p>"},{"location":"using-tre/terms-definitions/#shared-services","title":"Shared Services","text":"<p>A service provides one or more capabilities to you as a user of the TRE or to the TRE itself.  Depending on the type of the service it is scoped to the environment and shared across all workspaces (Shared Service) or scoped to a specific workspace (Workspace Service).</p> <p>The types of services required for a research project varies greatly why extensibility is a key aspect of the Azure TRE solution. New services can be developed by you and your organization to fit your needs.</p> <p>Shared Services are services and resource shared by all workspaces. These services are created once, when the TRE is deployed and managed by the TRE Administrator.</p> <p>Examples of shared services are:</p> <ul> <li>Firewall</li> <li>Package Mirror</li> <li>Git Mirror</li> </ul>"},{"location":"using-tre/terms-definitions/#workspace","title":"Workspace","text":"<p>A workspace is a set of resources on a network, with inbound traffic restricted to authorised users, and outbound access restricted to defined network locations.</p> <p>The workspace is a security boundary and there should be zero transfer of data out from the workspace unless explicitly configured. Data transfer is not restricted within a workspace.</p> <p>The workspace itself contains only the bare essentials to provide this functionality, such as virtual network(s), storage etc.</p> <p>Workspaces can be enhanced with one or more building blocks called workspace services like Azure ML, Guacamole etc. to allow functionality such as development of machine learning models, data engineering, data analysis and software development.</p> <p>Multiple workspaces can be created within a single Trusted Research Environment to enable the required separation for your projects.</p> <p>Each workspace has workspace users: a workspace owner (normally only one), and one or more workspace researchers that can access the data and workspace services in the workspace. The workspace owner is also considered a workspace researcher.</p>"},{"location":"using-tre/terms-definitions/#workspace-service","title":"Workspace Service","text":"<p>A workspace service is a service, created as a building block, with pre-configured set of resources that can be applied to a workspace.</p> <p>Examples of Workspace Services are:</p> <ul> <li>Guacamole (Virtual Desktops)</li> <li>Azure Machine Learning</li> </ul> <p>Unlike shared services, a workspace service is only accessible to the workspace users.</p> <p>Some workspace services, such as Guacamole, allow users to add on user-specific resources (user resources)</p> <p>All workspace services can be deployed to all workspaces.</p>"},{"location":"using-tre/terms-definitions/#user-resource","title":"User Resource","text":"<p>A user resource is a resource that is only available to a particular researcher. For example a virtual machine exposed by Guacamole.</p> <p>User resources can be deployed to workspaces with a compatible workspace service. E.g. Guacamole VMs can only be deployed to workspaces where the Guacamole workspace service is deployed.</p>"},{"location":"using-tre/terms-definitions/#templates","title":"Templates","text":"<p>In order to deploy resources (workspaces, workspace services, user resources), the resources have to be defined in templates.</p> <p>A template contains everything needed to create an instance of the resource. Ex. a base workspace template, or a Guacamole workspace service template.</p> <p>The templates describe the porter bundles used, and the input parameters needed to deploy them.</p> <p>To use a template, and deploy a resource, the template needs to be registered in the TRE. This is done using the TRE API.</p> <p>Tip</p> <p>Once a template is registered it can be used multiple times to deploy multiple workspaces, workspace services etc.</p> <p>If you want to author your own workspace, workspace service, or user resource template, consult the template authoring guide</p>"},{"location":"using-tre/terms-definitions/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/local-development/local-development/","title":"Local Development","text":"<p>This guide will cover how to setup local development environment to add custom templates to AzureTRE and deploy AzureTRE from the local machine.</p>"},{"location":"using-tre/local-development/local-development/#local-development-setup","title":"Local Development Setup","text":""},{"location":"using-tre/local-development/local-development/#prerequisites","title":"Prerequisites","text":"<p>To deploy an Azure TRE instance, the following assets and tools are required:</p> <ul> <li>Azure subscription</li> <li>Azure Active Directory (AAD) tenant in which you can create application registrations</li> <li>Git client such as Git or GitHub Desktop</li> <li>Docker Desktop</li> </ul>"},{"location":"using-tre/local-development/local-development/#development-container","title":"Development container","text":"<p>The AzureTRE Deployment solution contains a development container with all the required tooling to develop and deploy the AzureTRE and your custom templates to it. To deploy and extend an AzureTRE instance using the provided development container you will also need:</p> <ul> <li>Visual Studio Code</li> <li>Remote containers extension for Visual Studio Code</li> </ul> <p>The files in AzureTRE Deployment repo for the dev container are located in <code>/.devcontainer/</code> folder.</p> <p>Having the prerequisites and the development container, to start local development follow the next steps:</p> <ol> <li>Clone the project you have created from the AzureTRE Deployment template <code>git clone &lt;your_project&gt;</code></li> <li>Open it in Visual Studio Code</li> <li>VSCode will recognize the devcontainer is set up in and will ask to reopen in Devcontainer:     </li> </ol> <p>After the devcontainer is built, you will see the AzureTRE folder which you can use as a reference for your templates. In addition the sample.env files will be added.</p>"},{"location":"using-tre/local-development/local-development/#local-deployment","title":"Local Deployment","text":"<p>To run AzureTRE  deploy locally:</p> <ol> <li>Open your project in VScode devcontainer.</li> <li>Fill in all the required configuration. Follow this guide to set it up.</li> <li>run <code>make all</code></li> </ol> <p>Tip</p> <p>The Makefile in the AzureTRE deployment repository sources the make commands from AzureTRE that it references. This allows you to add your commands and also use the same make commands used in the AzureTRE.</p> <p>Having all the env vars in place:</p>"},{"location":"using-tre/local-development/local-development/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/pipelines/pipelines/","title":"Pipelines","text":"<p>The AzureTRE deployment repository contains the following github workflows:</p> <ol> <li>Build Validation - validates the code by running linter and terraform validation.</li> <li>Clean Validation Environments - a periodical workflow to clean unused AzureTRE environments.</li> <li>Deploy Azure TRE (branch) - This workflow is intended to be used to test workflow changes. It deploys AzureTRE using the workflows defined on the branch</li> <li>Deploy Azure TRE - This workflow is the integration build run for pushes to the main branch. It also runs on a schedule, serving as the nightly build to keep the main AzureTRE env in sync.</li> <li>Deploy Azure TRE Reusable - responsible to deploy AzureTRE. It is referenced in other Azure TRE deployment workflows.</li> </ol>"},{"location":"using-tre/pipelines/pipelines/#setup-github-environment","title":"Setup Github Environment","text":"<p>The workflows are using Github environment to source its environment variables. Follow this guide to define it in your github repository and provide it as an input for the workflows.</p> <p>The following environment variables should be defined in your github environment:</p> <ol> <li>Auth env vars</li> <li>Core and Devops env vars</li> </ol> <p>Having all the environment variables set in the Github environment the next step will be to use it in your pipelines:</p> <p>In AzureTRE deployment repository You will find all the pipelines under the folder <code>.github/workflows</code> on top of each workflow there is the workflow inputs part where the used Github environment name is set, make sure to update it with yours, for example:</p> <p></p>"},{"location":"using-tre/pipelines/pipelines/#publish-custom-templates-in-pipelines","title":"Publish Custom Templates in Pipelines","text":"<p>If you have created custom AzureTRE templates you can publish and register them as part of the CI/CD pipelines. To do so follow the next steps: 1. Go to <code>.github/workflows/deploy_tre_reusable.yml</code> workflow. Add your template under the following jobs:     - publish_bundles:              - register_bundles:              - If it is a user resource add it also under register_user_resource_bundles:         </p>"},{"location":"using-tre/pipelines/pipelines/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/templates/","title":"Creating Custom templates","text":"<p>This document will show how to create custom templates, integrate them into your CI/CD pipelines.</p>"},{"location":"using-tre/templates/#templates-types","title":"Templates types","text":"<p>There are 3 types of templates:</p> <ol> <li>Workspace</li> <li>Workspace Service</li> <li>User Resource</li> </ol> <p>Read more about them here</p>"},{"location":"using-tre/templates/#how-to-add-custom-templates","title":"How to add custom templates","text":"<p>AzureTRE deployment repository has directories setup for: workspace, workspace service and user resource template definitions.</p> <p>See template authoring guide to learn more about how to author templates.</p> <p>To add your custom templates follow the next steps:</p> <ul> <li>Deployment requirements:<p>1. Add your template under relevant folder (For example: if you are adding a new workspace template then place it under <code>/templates/workspaces</code> folder).   2. Use existing templates in AzureTRE as a reference.   3. Add porter configuration - AzureTRE uses Porter as a solution for implementing and deploying workspaces and workspace, learn more about how it is used in AzureTRE here.   4. Add terraform scripts to setup your deployment plan. - Define resource template in the API - follow this readme to register your template. - Use the AzureTRE UI to deploy your resources - Add your custom templates to CI/CD workflows - in Deploy Azure TRE Reusable workflow make sure to add your bundles under register_bundles and publish_bundles steps.</p> </li> </ul>"},{"location":"using-tre/templates/#publish-and-register-custom-templates-in-the-cicd","title":"Publish and Register Custom templates in the CI/CD","text":"<p>See the pipelines documentation to learn more about publishing and registering your custom templates as part of the CI/CD/</p>"},{"location":"using-tre/templates/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/upgrading-tre/","title":"Upgrading AzureTRE version","text":"<p>This document will cover how AzureTRE is referenced and how to upgrade its version in the AzureTRE deployment repository</p>"},{"location":"using-tre/upgrading-tre/#introduction","title":"Introduction","text":"<p>AzureTRE referenced as an external folder in AzureTRE deployment repository. A specific version of it is downloaded as part of devcontainer setup.  A symlink is then created making it available to reference in the directory itself (it is available only for reference, any changes to it are gitignored)</p>"},{"location":"using-tre/upgrading-tre/#how-to-upgrade-azuretre-version","title":"How to upgrade AzureTRE version","text":"<p>Select AzureTRE version: 1. In AzureTRE go to releases:      1. Choose a release version</p> <p>To upgrade AzureTRE version inside AzureTRE deployment repository: 1. Go to devcontainer.json file 1. Update the OSS_VERSION param to the desired version.</p> <pre><code>![Upgrade TRE Version](../../assets/using-tre/upgrade_tre_version.png)\n</code></pre>"},{"location":"using-tre/upgrading-tre/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/wks/","title":"Workspaces","text":"<p>Info</p> <p>Coming soon</p> <p>We're working to improve our documentation, and fill in some gaps. Unfortunately, this particular page is one of the gaps we're looking to fill and isn't yet available.</p>"},{"location":"using-tre/wks/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/wks/using-wks/","title":"Using Workspaces","text":"<p>Info</p> <p>Coming soon</p> <p>We're working to improve our documentation, and fill in some gaps. Unfortunately, this particular page is one of the gaps we're looking to fill and isn't yet available.</p>"},{"location":"using-tre/wks/using-wks/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"},{"location":"using-tre/wks/wks-owner/","title":"Workspace Owners","text":"<p>Info</p> <p>Coming soon</p> <p>We're working to improve our documentation, and fill in some gaps. Unfortunately, this particular page is one of the gaps we're looking to fill and isn't yet available.</p>"},{"location":"using-tre/wks/wks-owner/#how-to-contribute-to-our-documentation","title":"How to Contribute to our Documentation","text":"<p>If you have any comments or suggestions about our documentation then you can visit our GitHub project and either raise a new issue, or comment on one of the existing ones.</p> <p>You can find our existing documentation issues on GitHub by clicking on the link below:</p> <p>Existing Documentation Issues</p> <p>Or, you can raise a new issue by clicking on this link:</p> <p>Report an Issue or Make a Suggestion</p> <p>Thank you for your patience and support!</p>"}]}